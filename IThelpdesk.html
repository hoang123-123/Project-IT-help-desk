<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IT Help Desk - H·ªá th·ªëng h·ªó tr·ª£ CNTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="icon" href="data:," />
    <style>
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #374151;
      }

      /* Sidebar transitions */
      .sidebar-transition {
        transition: all 0.3s ease-in-out;
      }

      /* Card hover effects */
      .card-hover {
        transition: all 0.2s ease-in-out;
      }
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      /* Status badges with gradients */
      .status-pending {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
      }
      .status-approved {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .status-rejected {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .status-in-progress {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
      }
      .status-completed {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Table styles */
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        text-align: left;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background-color: #f9fafb;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #6b7280;
      }

      /* Button styles */
      button {
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s ease-in-out;
      }

      button:hover {
        transform: translateY(-1px);
      }

      /* Input styles */
      input,
      select,
      textarea {
        font-family: inherit;
        transition: all 0.2s ease-in-out;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Modal backdrop */
      .modal-backdrop {
        backdrop-filter: blur(4px);
      }

      /* Loading animation */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Pulse animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Fade in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      /* Responsive utilities */
      @media (max-width: 768px) {
        .mobile-hidden {
          display: none;
        }

        .mobile-full {
          width: 100% !important;
        }
      }

      /* Print styles */
      @media print {
        .no-print {
          display: none !important;
        }

        body {
          background: white !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Sidebar -->
    <div
      id="sidebar"
      class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-transition transform -translate-x-full lg:translate-x-0"
    >
      <div
        class="flex items-center justify-between h-16 px-6 border-b border-gray-200"
      >
        <div class="flex items-center space-x-3">
          <div
            class="w-8 h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center"
          >
            <i class="fas fa-headset text-white text-sm"></i>
          </div>
          <h1 class="text-xl font-bold text-gray-800">IT Help Desk</h1>
        </div>
        <button
          id="closeSidebar"
          class="lg:hidden text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <nav class="mt-6 px-4">
        <div class="space-y-2">
          <a
            href="#tickets"
            class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors active"
          >
            <i class="fas fa-ticket-alt w-5 h-5 mr-3"></i>
            <span>Qu·∫£n l√Ω Ticket</span>
          </a>
          <a
            href="#dashboard"
            class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors"
          >
            <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
            <span>Dashboard</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen">
      <!-- Top Navigation -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="flex items-center justify-between h-16 px-6">
          <div class="flex items-center space-x-4">
            <button
              id="openSidebar"
              class="lg:hidden text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-bars"></i>
            </button>
            <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">
              Dashboard
            </h2>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Notifications -->
            <div class="relative">
              <button
                id="notificationsBtn"
                class="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <i class="fas fa-bell"></i>
                <span
                  id="notificationBadge"
                  class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden"
                  >3</span
                >
              </button>
              <div
                id="notificationsDropdown"
                class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
              >
                <div class="p-4 border-b border-gray-200">
                  <h3 class="font-semibold text-gray-800">Th√¥ng b√°o</h3>
                </div>
                <div id="notificationsList" class="max-h-64 overflow-y-auto">
                  <!-- Notifications will be populated here -->
                </div>
              </div>
            </div>

            <!-- User Menu -->
            <div class="relative">
              <button
                id="userMenuBtn"
                class="flex items-center space-x-2 p-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <div
                  class="w-8 h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center"
                >
                  <span class="text-white text-sm font-medium" id="userAvatar"
                    >AD</span
                  >
                </div>
                <span class="hidden md:block text-sm font-medium"
                  >Admin User</span
                >
                <i class="fas fa-chevron-down text-xs"></i>
              </button>
              <div
                id="userMenuDropdown"
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
              >
                <div class="py-2">
                  <a
                    href="#"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    >H·ªì s∆°</a
                  >
                  <a
                    href="#"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    >C√†i ƒë·∫∑t</a
                  >
                  <hr class="my-2" />
                  <a
                    href="#"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    >ƒêƒÉng xu·∫•t</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <main class="p-6">
        <!-- Dashboard Section -->
        <div id="dashboard" class="page-content">
          <!-- Stats Cards -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <div
              class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">T·ªïng Tickets</p>
                  <p class="text-2xl font-bold text-gray-900">1,234</p>
                </div>
                <div
                  class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-ticket-alt text-blue-600"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  12%
                </span>
                <span class="text-gray-500 ml-2">so v·ªõi th√°ng tr∆∞·ªõc</span>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">ƒêang ch·ªù</p>
                  <p class="text-2xl font-bold text-gray-900">45</p>
                </div>
                <div
                  class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-clock text-yellow-600"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-red-600 flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  8%
                </span>
                <span class="text-gray-500 ml-2">so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">ƒêang x·ª≠ l√Ω</p>
                  <p class="text-2xl font-bold text-gray-900">23</p>
                </div>
                <div
                  class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-cogs text-blue-600"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 flex items-center">
                  <i class="fas fa-arrow-down mr-1"></i>
                  5%
                </span>
                <span class="text-gray-500 ml-2">so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">Ho√†n th√†nh</p>
                  <p class="text-2xl font-bold text-gray-900">1,166</p>
                </div>
                <div
                  class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-check-circle text-green-600"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  15%
                </span>
                <span class="text-gray-500 ml-2">so v·ªõi th√°ng tr∆∞·ªõc</span>
              </div>
            </div>
          </div>

          <!-- Recent Activities -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">
                  Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                </h3>
                <a
                  href="#tickets"
                  class="text-blue-600 hover:text-blue-700 text-sm font-medium"
                  >Xem t·∫•t c·∫£</a
                >
              </div>
            </div>
            <div class="p-6">
              <div id="recentActivities" class="space-y-4">
                <!-- Recent activities will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tickets Section -->
        <div id="tickets" class="page-content hidden">
          <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 relative"
          >
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-end">
                <div class="flex items-center space-x-4">
                  <!-- √î t√¨m ki·∫øm -->
                  <div class="relative">
                    <input
                      type="text"
                      id="searchTickets"
                      placeholder="T√¨m ki·∫øm tickets..."
                      class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <i
                      class="fas fa-search absolute left-3 top-3 text-gray-400"
                    ></i>
                  </div>

                  <!-- B·ªô l·ªçc tr·∫°ng th√°i -->
                  <select
                    id="statusFilter"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending">Ch·ªù ph√™ duy·ªát</option>
                    <option value="approved">ƒê√£ ph√™ duy·ªát</option>
                    <option value="in-progress">ƒêang x·ª≠ l√Ω</option>
                    <option value="completed">Ho√†n th√†nh</option>
                    <option value="rejected">T·ª´ ch·ªëi</option>
                  </select>

                  <!-- N√∫t t·∫°o Ticket -->
                  <button
                    id="btnCreateTicket"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
                  >
                    <i class="fas fa-plus-circle mr-2"></i>
                    T·∫°o Ticket
                  </button>
                </div>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ti√™u ƒë·ªÅ
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Lo·∫°i
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ng∆∞·ªùi t·∫°o
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Tr·∫°ng th√°i
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ƒê·ªô ∆∞u ti√™n
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ng√†y t·∫°o
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      H√†nh ƒë·ªông
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="ticketsTable"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Tickets will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
          <!-- page -->
          <div
            id="ticketsPagination"
            class="absolute bottom-4 right-4 flex"
          ></div>
        </div>
        <!-- New Ticket Modal -->
        <div
          id="new-ticket"
          class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
        >
          <div class="max-w-4xl w-full mx-auto">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
              <div
                class="p-6 border-b border-gray-200 flex justify-between items-center"
              >
                <h3 class="text-lg font-semibold text-gray-800">
                  T·∫°o Ticket m·ªõi
                </h3>
                <!-- n√∫t ƒë√≥ng -->
                <button
                  id="closeNewTicket"
                  class="text-gray-400 hover:text-gray-600"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-6">
                <form id="newTicketForm" class="space-y-6">
                  <!-- Ch·ªçn Ph√≤ng ban -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Ph√≤ng ban *</label
                    >
                    <select
                      id="ticketDepartment"
                      required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Ch·ªçn ph√≤ng ban"
                    ></select>
                  </div>

                  <!-- Ch·ªçn Lo·∫°i y√™u c·∫ßu -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Lo·∫°i y√™u c·∫ßu *
                    </label>
                    <select
                      id="ticketCategory"
                      required
                      onchange="onCategoryChange(this.value)"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">Ch·ªçn lo·∫°i y√™u c·∫ßu</option>
                      <option value="191920000">ƒêi·ªÅu ch·ªânh gi√° SOD</option>
                      <option value="191920001">ƒêi·ªÅu ch·ªânh VAT SOD</option>
                      <option value="283640001">ƒêi·ªÅu ch·ªânh VAT SO</option>
                      <option value="283640002">ƒêi·ªÅu ch·ªânh gi√° BOD</option>
                      <option value="283640003">ƒêi·ªÅu ch·ªânh VAT BOD</option>
                      <option value="283640004">H·ªßy phi·∫øu nh·∫≠p kho</option>
                      <option value="283640005">
                        ƒêi·ªÅu ch·ªânh phi·∫øu nh·∫≠p kho
                      </option>
                      <option value="283640006">ƒêi·ªÅu ch·ªânh VAT BO</option>
                      <option value="283640007">ƒêi·ªÅu ch·ªânh ƒë·ªãnh l∆∞·ª£ng</option>
                      <option value="283640008">H·ªßy phi·∫øu xu·∫•t kho</option>
                      <option value="283640009">
                        ƒêi·ªÅu ch·ªânh phi·∫øu xu·∫•t kho
                      </option>
                    </select>
                  </div>

                  <!-- Th√¥ng tin chung -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Ng∆∞·ªùi duy·ªát *</label
                      >
                      <select id="ticketApprover" multiple></select>
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Th√¥ng tin y√™u c·∫ßu *</label
                      >
                      <input
                        type="text"
                        id="ticketAdjustmentInfo"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Nh·∫≠p th√¥ng tin chi ti·∫øt"
                      />
                    </div>
                  </div>

                  <!-- Tr∆∞·ªùng ƒë·ªông -->
                  <div id="dynamicFields" class="space-y-4"></div>

                  <!-- M√¥ t·∫£ -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >M√¥ t·∫£ chi ti·∫øt</label
                    >
                    <textarea
                      id="ticketDescription"
                      rows="5"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ..."
                    ></textarea>
                  </div>

                  <!-- Buttons -->
                  <div
                    class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200"
                  >
                    <button
                      type="button"
                      id="cancelTicket"
                      class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                    >
                      H·ªßy
                    </button>
                    <button
                      type="button"
                      id="submitTicket"
                      class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      T·∫°o Ticket dev
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Approvals Section -->
        <div id="approvals" class="page-content hidden">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-800">
                Ph√™ duy·ªát Tickets
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ID
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ti√™u ƒë·ªÅ
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ng∆∞·ªùi t·∫°o
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Lo·∫°i
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ƒê·ªô ∆∞u ti√™n
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Ng√†y t·∫°o
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      H√†nh ƒë·ªông
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="approvalsTable"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Approval tickets will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal for Ticket Details -->
    <div
      id="ticketModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
        >
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-800">
                Chi ti·∫øt Ticket
              </h3>
              <button
                id="closeTicketModal"
                class="text-gray-500 hover:text-gray-700"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div id="ticketModalContent" class="p-6">
            <!-- Ticket details will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Approval -->
    <div
      id="approvalModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">
              Ph√™ duy·ªát Ticket
            </h3>
          </div>
          <div class="p-6">
            <div id="approvalTicketInfo" class="mb-6">
              <!-- Ticket info will be populated here -->
            </div>
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Ghi ch√∫ (t√πy ch·ªçn)</label
              >
              <textarea
                id="approvalNotes"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c·∫ßn..."
              ></textarea>
            </div>
            <div class="flex items-center justify-end space-x-4">
              <button
                id="cancelApproval"
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
              >
                H·ªßy
              </button>
              <button
                id="rejectTicket"
                class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              >
                T·ª´ ch·ªëi
              </button>
              <button
                id="approveTicket"
                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
              >
                Ph√™ duy·ªát
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Login -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6 relative">
          <button
            id="closeLoginModal"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
          >
            &times;
          </button>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">ƒêƒÉng nh·∫≠p</h3>
          <form id="loginForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >T√†i kho·∫£n</label
              >
              <input
                type="text"
                id="username"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="Nh·∫≠p t√†i kho·∫£n"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >M·∫≠t kh·∫©u</label
              >
              <input
                type="password"
                id="password"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
              />
            </div>
            <div class="flex justify-between">
              <button
                type="button"
                id="cancelLogin"
                class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100"
              >
                H·ªßy
              </button>
              <button
                type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                ƒêƒÉng nh·∫≠p
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // ======== Setting =============

      let tickets = [];
      let supportSystemsData = [];
      let ordersDetailData = [];
      let approversData = []; // danh sach user
      let approverChoices = null;
      let ticketHandlersInitialized = false;
      let currentTicketPage = 1;
      //let cachedToken = null;

      const ticketsPerPage = 10;
      const DATAVERSE_URL = "https://wecare-ii.crm5.dynamics.com/api/data/v9.0";

      const AdminUser = [
        { username: "admin", password: "123456", fullName: "Admin WC" },
      ];

      const USER_QUERY =
        "/crdfd_employees" +
        "?$select=cr1bb_emailcal,crdfd_name,crdfd_phongbantext" +
        "&$filter=statecode eq 0 and crdfd_trangthai ne 191920004 and crdfd_local ne 'S√†i G√≤n' and cr1bb_chucvutext ne null ";

      const SOD_QUERY =
        "/crdfd_saleorderdetails" +
        "?$select=crdfd_saleorderdetailid, crdfd_name" +
        "&$filter=statecode eq 0 and crdfd_trangthaionhang1 ne 191920000" +
        "&$top=5000";

      // ========== Load web ================
      // Initialize the application
      document.addEventListener("DOMContentLoaded", async () => {
        token = await getToken(); // ch·ªù token
        await getData();
        initUserMenu(); // init menu + modal login
        const currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;
        if (currentUser) {
          init(); // user ƒë√£ login tr∆∞·ªõc ‚Üí render giao di·ªán/data lu√¥n
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("userMenuBtn");
        const dropdown = document.getElementById("userMenuDropdown");

        if (!btn || !dropdown) return; // tr√°nh l·ªói null

        btn.addEventListener("click", (e) => {
          e.stopPropagation(); // tr√°nh click ra ngo√†i k√≠ch ho·∫°t s·ª± ki·ªán document
          dropdown.classList.toggle("hidden");
        });

        // ·∫®n menu khi click ra ngo√†i
        document.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        initUserMenu();

        const currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;
        if (currentUser) {
          init(); // render data n·∫øu ƒë√£ login tr∆∞·ªõc ƒë√≥
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const btnCreateTicket = document.getElementById("btnCreateTicket");
        const newTicketModal = document.getElementById("new-ticket");
        const closeNewTicket = document.getElementById("closeNewTicket");
        const cancelTicket = document.getElementById("cancelTicket");

        if (btnCreateTicket) {
          btnCreateTicket.addEventListener("click", () => {
            newTicketModal.classList.remove("hidden");
          });
        }

        if (closeNewTicket) {
          closeNewTicket.addEventListener("click", () => {
            newTicketModal.classList.add("hidden");
          });
        }

        if (cancelTicket) {
          cancelTicket.addEventListener("click", () => {
            newTicketModal.classList.add("hidden");
          });
        }
      });

      // ========== Function ================

      async function getToken() {
        const url =
          "https://prod-43.southeastasia.logic.azure.com:443/workflows/1d8ccba4cda644d79f66bfe164b2a0bf/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=R4cX_RbgAONZ2qPVzkykPmDaX96SnPvw4lPAg5AcG78";

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key: "value" }),
          });

          if (!response.ok) {
            throw new Error("HTTP status " + response.status);
          }

          const data = await response.json();
          cachedToken = data.access_token; // üëà l·∫•y tr·ª±c ti·∫øp
          if (!cachedToken) {
            throw new Error("Kh√¥ng t√¨m th·∫•y access_token trong response");
          }

          return cachedToken;
        } catch (err) {
          console.error("Error getToken:", err);
          throw err;
        }
      }

      async function getData() {
        const cachedToken = await getToken();
        const [data, dataUser] = await Promise.all([
          //getAllXseptions(token, XSEPTIONS_QUERY, mappingListTickets),
          getAllXseptions(cachedToken, USER_QUERY, mappingUser),
          getAllXseptions(cachedToken, SOD_QUERY, mappingSOD),
        ]);
        return { data, dataUser };
      }

      async function refreshData() {
        const cachedToken = await getToken();
        const email = getCurrentUserEmail();
        if (!email) {
          console.warn("‚ùå Ch∆∞a login, b·ªè qua fetch data");
          return;
        }

        const query = buildXseptionsQuery(email);
        tickets = await getAllXseptions(cachedToken, query, mappingListTickets);
        console.log("data ticket: ", tickets);
        loadTickets(); // gi·ªù loadTickets d√πng tickets m·ªõi nh·∫•t
      }

      function getCurrentUserEmail() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        return currentUser ? currentUser.idU : null;
      }

      function buildXseptionsQuery(email) {
        return (
          "/crdfd_suport_systems" +
          "?$select=crdfd_suport_systemid,crdfd_name,crdfd_nguoiyeucau,crdfd_loaiieuchinh,crdfd_trangthai,crdfd_lydoieuchinh,createdon" +
          `&$filter=statecode eq 0 and (contains(crdfd_nguoiduyet,'${email}') or crdfd_nguoiyeucau eq '${email}')`
        );
      }

      async function init() {
        try {
          //console.log("Done, t·ªïng s·ªë record:", data.length);
          tickets = [...supportSystemsData];
          initializeNavigation();
          initializeFormHandlers();
          initializeModals();
          loadTickets();
          loadApprovals();
          loadDashboard();
          initApproverChoices();
          loadDepartments();
        } catch (err) {
          console.error("Error init:", err);
        }
      }

      // Navigation functions
      function initializeNavigation() {
        const navItems = document.querySelectorAll(".nav-item");
        const pageContents = document.querySelectorAll(".page-content");
        const pageTitle = document.getElementById("pageTitle");

        navItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();

            navItems.forEach((nav) =>
              nav.classList.remove("active", "bg-blue-50", "text-blue-600")
            );
            this.classList.add("active", "bg-blue-50", "text-blue-600");

            pageContents.forEach((content) => content.classList.add("hidden"));

            const targetId = this.getAttribute("href").substring(1);
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
              targetContent.classList.remove("hidden");
              const title = this.querySelector("span").textContent;
              pageTitle.textContent = title;

              switch (targetId) {
                case "dashboard":
                  loadDashboard();
                  break;
                case "tickets":
                  loadTickets();
                  break;
                case "approvals":
                  loadApprovals();
                  break;
              }
            }
          });
        });
        // Set default page to tickets
        const defaultNavItem = document.querySelector('a[href="#tickets"]');
        if (defaultNavItem) {
          defaultNavItem.click();
        }

        // Mobile sidebar
        const openSidebar = document.getElementById("openSidebar");
        const closeSidebar = document.getElementById("closeSidebar");
        const sidebar = document.getElementById("sidebar");

        openSidebar.addEventListener("click", () =>
          sidebar.classList.remove("-translate-x-full")
        );
        closeSidebar.addEventListener("click", () =>
          sidebar.classList.add("-translate-x-full")
        );
      }

      // Dashboard functions
      function loadDashboard() {
        loadRecentActivities();
      }

      function loadRecentActivities() {
        const recentActivities = document.getElementById("recentActivities");

        // T·∫°o danh s√°ch ho·∫°t ƒë·ªông t·ª´ tickets
        const activities = [];

        tickets.forEach((ticket) => {
          // Ho·∫°t ƒë·ªông t·∫°o ticket
          activities.push({
            type: "created",
            ticket: ticket,
            time: ticket.createdAt,
            description: `Ticket m·ªõi ƒë∆∞·ª£c t·∫°o: ${ticket.title}`,
          });

          // Ho·∫°t ƒë·ªông ph√™ duy·ªát/t·ª´ ch·ªëi
          if (ticket.status === "approved") {
            activities.push({
              type: "approved",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000, // +1 gi·ªù
              description: `Ticket ${ticket.id} ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát`,
            });
          } else if (ticket.status === "rejected") {
            activities.push({
              type: "rejected",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000, // +1 gi·ªù
              description: `Ticket ${ticket.id} ƒë√£ b·ªã t·ª´ ch·ªëi`,
            });
          } else if (ticket.status === "completed") {
            activities.push({
              type: "completed",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 7200000, // +2 gi·ªù
              description: `Ticket ${ticket.id} ƒë√£ ƒë∆∞·ª£c ƒë√≥ng`,
            });
          }
        });

        // S·∫Øp x·∫øp theo th·ªùi gian (m·ªõi nh·∫•t tr∆∞·ªõc)
        activities.sort((a, b) => b.time - a.time);

        // L·∫•y 15 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t
        const recentActivitiesList = activities.slice(0, 15);

        recentActivities.innerHTML = recentActivitiesList
          .map(
            (activity) => `
                <div class="flex items-center space-x-3 p-1 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex-shrink-0">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center ${getActivityIconClass(
                          activity.type
                        )}">
                            <i class="fas ${getActivityIcon(
                              activity.type
                            )} text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-900 truncate">${
                              activity.description
                            }</p>
                            <span class="text-xs text-gray-500 ml-2">${formatTimeAgo(
                              activity.time
                            )}</span>
                        </div>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="text-xs text-gray-500">${
                              activity.ticket.createdBy
                            }</span>
                            <span class="text-xs text-gray-400">‚Ä¢</span>
                            <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded ${getPriorityClass(
                              activity.ticket.priority
                            )}">
                                ${getPriorityText(activity.ticket.priority)}
                            </span>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function getActivityIcon(type) {
        switch (type) {
          case "created":
            return "fa-plus-circle";
          case "approved":
            return "fa-check-circle";
          case "rejected":
            return "fa-times-circle";
          case "completed":
            return "fa-flag-checkered";
          default:
            return "fa-info-circle";
        }
      }

      function getActivityIconClass(type) {
        switch (type) {
          case "created":
            return "bg-blue-500";
          case "approved":
            return "bg-green-500";
          case "rejected":
            return "bg-red-500";
          case "completed":
            return "bg-purple-500";
          default:
            return "bg-gray-500";
        }
      }

      // Tickets management

      function loadTickets(page = 1) {
        currentTicketPage = page;
        const ticketsTable = document.getElementById("ticketsTable");
        const paginationContainer =
          document.getElementById("ticketsPagination");

        const totalPages = Math.ceil(tickets.length / ticketsPerPage);
        const start = (page - 1) * ticketsPerPage;
        const end = start + ticketsPerPage;
        const ticketsToRender = tickets.slice(start, end);

        // Render b·∫£ng tickets
        ticketsTable.innerHTML = ticketsToRender
          .map(
            (ticket) => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate">${
            ticket.name
          }</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 truncate">${
            ticket.title
          }</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">${getCategoryText(
            ticket.category
          )}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">${
            ticket.createdBy
          }</td>
          <td class="px-6 py-4 whitespace-nowrap truncate">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(
              ticket.status
            )}">
              ${getStatusText(ticket.status)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap truncate">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(
              ticket.priority
            )}">
              ${getPriorityText(ticket.priority)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">${formatDate(
            ticket.createdAt
          )}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium truncate">
            <button onclick="viewTicket('${
              ticket.id
            }')" class="text-blue-600 hover:text-blue-900 mr-3">Xem</button>
            ${
              ticket.status === 191920002
                ? `<button onclick="openApprovalModal('${ticket.id}')" class="text-green-600 hover:text-green-900">Ph√™ duy·ªát</button>`
                : ""
            }
          </td>
        </tr>
      `
          )
          .join("");

        // Render ph√¢n trang
        let paginationHTML = "";

        // N√∫t Previous
        paginationHTML += `
    <button ${page === 1 ? "disabled" : ""} onclick="loadTickets(${page - 1})"
      class="px-3 py-1 mx-1 border rounded ${
        page === 1 ? "text-gray-400" : "text-blue-600 hover:bg-blue-100"
      }">
      Previous
    </button>
  `;

        // C√°c s·ªë trang
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `
      <button onclick="loadTickets(${i})"
        class="px-3 py-1 mx-1 border rounded ${
          i === page
            ? "bg-blue-600 text-white"
            : "text-blue-600 hover:bg-blue-100"
        }">
        ${i}
      </button>
    `;
        }

        // N√∫t Next
        paginationHTML += `
    <button ${page === totalPages ? "disabled" : ""} onclick="loadTickets(${
          page + 1
        })"
      class="px-3 py-1 mx-1 border rounded ${
        page === totalPages
          ? "text-gray-400"
          : "text-blue-600 hover:bg-blue-100"
      }">
      Next
    </button>
  `;

        paginationContainer.innerHTML = paginationHTML;
      }

      // Approvals management
      function loadApprovals() {
        const approvalsTable = document.getElementById("approvalsTable");
        const pendingTickets = tickets.filter((t) => t.status === 191920002);

        approvalsTable.innerHTML = pendingTickets
          .map(
            (ticket) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                      ticket.id
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                      ticket.title
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                      ticket.createdBy
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getCategoryText(
                      ticket.category
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(
                          ticket.priority
                        )}">
                            ${getPriorityText(ticket.priority)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(
                      ticket.createdAt
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openApprovalModal('${
                          ticket.id
                        }')" class="text-green-600 hover:text-green-900 mr-3">Ph√™ duy·ªát</button>
                        <button onclick="viewTicket('${
                          ticket.id
                        }')" class="text-blue-600 hover:text-blue-900">Xem</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Form handlers

      function initializeFormHandlers() {
        if (ticketHandlersInitialized) return; // ƒë√£ g·∫Øn r·ªìi th√¨ tho√°t
        ticketHandlersInitialized = true;

        const submitTicket = document.getElementById("submitTicket");
        const cancelTicket = document.getElementById("cancelTicket");
        const newTicketForm = document.getElementById("newTicketForm");

        submitTicket.addEventListener("click", function () {
          createNewTicket();
        });

        cancelTicket.addEventListener("click", function () {
          newTicketForm.reset();
          document.querySelector('a[href="#tickets"]').click();
        });
      }

      // ============ Create ticket =====================
      async function createNewTicket() {
        // L·∫•y user t·ª´ localStorage
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));

        const selectedApprovers = approverChoices.getValue(true);

        const approversText = Array.isArray(selectedApprovers)
          ? selectedApprovers.join(",")
          : selectedApprovers;

        const newTicket = {
          crdfd_lydoieuchinh:
            document.getElementById("ticketDescription").value,
          crdfd_loaiieuchinh: parseInt(
            document.getElementById("ticketCategory").value
          ),
          crdfd_nguoiyeucau: currentUser.idU,
          crdfd_trangthai: 191920002,
          cr1bb_phongban: document.getElementById("ticketDepartment").value,
          cr1bb_thongtinyeucau: document.getElementById("ticketAdjustmentInfo")
            .value,
          crdfd_nguoiduyet: approversText,
        };

        console.log("new ticket: ", newTicket);

        try {
          const cachedToken = await getToken();
          const response = await fetch(
            `${DATAVERSE_URL}/crdfd_suport_systems`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${cachedToken}`,
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(newTicket),
            }
          );

          if (!response.ok) {
            throw new Error(
              `L·ªói Dataverse: ${response.status} - ${response.statusText}`
            );
          }

          // Ch·ªâ parse JSON n·∫øu response c√≥ content
          let createdRecord = null;
          const text = await response.text();
          if (text) {
            createdRecord = JSON.parse(text);
            console.log("Ticket ƒë√£ t·∫°o tr√™n Dataverse:", createdRecord);
          } else {
            console.log(
              "Ticket ƒë√£ t·∫°o tr√™n Dataverse, nh∆∞ng kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ."
            );
          }

          document.getElementById("newTicketForm").reset();
          showNotification(
            "Ticket ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng tr√™n Dataverse!",
            "success"
          );
          document.querySelector('a[href="#tickets"]').click();
          //await refreshData(); // render l·∫°i d·ªØ li·ªáu titkets
          document.getElementById("new-ticket").classList.add("hidden");
        } catch (err) {
          console.error(err);
          showNotification("T·∫°o ticket th·∫•t b·∫°i: " + err.message, "error");
        }
      }

      // Modal functions
      function initializeModals() {
        const ticketModal = document.getElementById("ticketModal");
        const closeTicketModal = document.getElementById("closeTicketModal");
        const approvalModal = document.getElementById("approvalModal");
        const cancelApproval = document.getElementById("cancelApproval");

        closeTicketModal.addEventListener("click", () =>
          ticketModal.classList.add("hidden")
        );
        cancelApproval.addEventListener("click", () =>
          approvalModal.classList.add("hidden")
        );

        ticketModal.addEventListener("click", (e) => {
          if (e.target === ticketModal) ticketModal.classList.add("hidden");
        });

        approvalModal.addEventListener("click", (e) => {
          if (e.target === approvalModal) approvalModal.classList.add("hidden");
        });

        document
          .getElementById("approveTicket")
          .addEventListener("click", approveCurrentTicket);
        document
          .getElementById("rejectTicket")
          .addEventListener("click", rejectCurrentTicket);
      }

      let currentApprovalTicket = null;

      function openApprovalModal(ticketId) {
        const ticket = tickets.find((t) => t.id === ticketId);
        if (!ticket) return;

        currentApprovalTicket = ticket;
        const approvalModal = document.getElementById("approvalModal");
        const approvalTicketInfo =
          document.getElementById("approvalTicketInfo");

        approvalTicketInfo.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">${
                      ticket.title
                    }</h4>
                    <p class="text-sm text-gray-600 mb-2">${
                      ticket.description
                    }</p>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Lo·∫°i:</span> ${getCategoryText(
                          ticket.category
                        )}</div>
                        <div><span class="font-medium">ƒê·ªô ∆∞u ti√™n:</span> <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(
                          ticket.priority
                        )}">${getPriorityText(ticket.priority)}</span></div>
                        <div><span class="font-medium">Ng∆∞·ªùi t·∫°o:</span> ${
                          ticket.createdBy
                        }</div>
                        <div><span class="font-medium">Ng√†y t·∫°o:</span> ${formatDate(
                          ticket.createdAt
                        )}</div>
                    </div>
                </div>
            `;

        approvalModal.classList.remove("hidden");
      }

      //=========== User Approval ===========
      async function approveCurrentTicket() {
        if (!currentApprovalTicket) return;

        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser || !currentUser.idU) {
            throw new Error("Kh√¥ng t√¨m th·∫•y user login");
          }

          // update l√™n Dataverse
          const updated = await updateTicketStatus(
            currentApprovalTicket.id,
            283640001,
            currentUser.idU
          );
          document.getElementById("approvalModal").classList.add("hidden");
          if (updated) {
            showNotification("Ticket ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!", "success");
          } else {
            showNotification(
              "User n√†y kh√¥ng c√≥ record approval ƒë·ªÉ ph√™ duy·ªát.",
              "info"
            );
          }

          // refresh l·∫°i t·ª´ server
          await refreshData();
          loadApprovals();
          loadDashboard();
        } catch (err) {
          showNotification("Ph√™ duy·ªát th·∫•t b·∫°i: " + err.message, "error");
        }
      }

      async function rejectCurrentTicket() {
        if (!currentApprovalTicket) return;

        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser || !currentUser.idU) {
            throw new Error("Kh√¥ng t√¨m th·∫•y user login");
          }

          const updated = await updateTicketStatus(
            currentApprovalTicket.id,
            283640002,
            currentUser.idU // üëà email c·ªßa user login
          );

          document.getElementById("approvalModal").classList.add("hidden");
          if (updated) {
            showNotification("Ticket ƒë√£ b·ªã t·ª´ ch·ªëi!", "error");
          } else {
            showNotification(
              "User n√†y kh√¥ng c√≥ record approval ƒë·ªÉ ph√™ duy·ªát.",
              "info"
            );
          }

          await refreshData();
          loadApprovals();
          loadDashboard();
        } catch (err) {
          showNotification("T·ª´ ch·ªëi th·∫•t b·∫°i: " + err.message, "error");
        }
      }

      function viewTicket(ticketId) {
        const ticket = tickets.find((t) => t.id === ticketId);
        if (!ticket) return;

        const ticketModal = document.getElementById("ticketModal");
        const ticketModalContent =
          document.getElementById("ticketModalContent");

        ticketModalContent.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-xl font-semibold text-gray-800 mb-2">${
                          ticket.title
                        }</h4>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>ID: ${ticket.id}</span>
                            <span>‚Ä¢</span>
                            <span>${formatDate(ticket.createdAt)}</span>
                            <span>‚Ä¢</span>
                            <span>${ticket.createdBy}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">Tr·∫°ng th√°i</h5>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(
                              ticket.status
                            )}">
                                ${getStatusText(ticket.status)}
                            </span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">ƒê·ªô ∆∞u ti√™n</h5>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(
                              ticket.priority
                            )}">
                                ${getPriorityText(ticket.priority)}
                            </span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">Lo·∫°i</h5>
                            <span class="text-sm text-gray-600">${getCategoryText(
                              ticket.category
                            )}</span>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-gray-800 mb-2">M√¥ t·∫£</h5>
                        <p class="text-gray-600">${ticket.description}</p>
                    </div>
                </div>
            `;

        ticketModal.classList.remove("hidden");
      }

      // Notifications
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
          type === "success"
            ? "bg-green-500 text-white"
            : type === "error"
            ? "bg-red-500 text-white"
            : "bg-blue-500 text-white"
        }`;
        notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${
                      type === "success"
                        ? "fa-check-circle"
                        : type === "error"
                        ? "fa-exclamation-circle"
                        : "fa-info-circle"
                    }"></i>
                    <span>${message}</span>
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(
          () => notification.classList.remove("translate-x-full"),
          100
        );
        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Utility functions
      function getStatusClass(status) {
        switch (status) {
          case 191920002:
            return "status-pending text-white";
          case 191920000:
            return "status-approved text-white";
          case 191920001:
            return "status-rejected text-white";
          case "in-progress":
            return "status-in-progress text-white";
          case "completed":
            return "status-completed text-white";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case 191920002:
            return "Ch·ªù ph√™ duy·ªát";
          case 191920000:
            return "ƒê√£ ph√™ duy·ªát";
          case 191920001:
            return "T·ª´ ch·ªëi";
          case "in-progress":
            return "ƒêang x·ª≠ l√Ω";
          case "completed":
            return "Ho√†n th√†nh";
          default:
            return "Kh√¥ng x√°c ƒë·ªãnh";
        }
      }

      function getPriorityClass(priority) {
        switch (priority) {
          case "low":
            return "bg-gray-100 text-gray-800";
          case "medium":
            return "bg-yellow-100 text-yellow-800";
          case "high":
            return "bg-orange-100 text-orange-800";
          case "urgent":
            return "bg-red-100 text-red-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      function getPriorityText(priority) {
        switch (priority) {
          case "low":
            return "Th·∫•p";
          case "medium":
            return "Trung b√¨nh";
          case "high":
            return "Cao";
          case "urgent":
            return "Kh·∫©n c·∫•p";
          default:
            return "Kh√¥ng x√°c ƒë·ªãnh";
        }
      }

      function getCategoryText(category) {
        switch (category) {
          case 191920000:
            return "ƒêi·ªÅu ch·ªânh gi√° SOD";
          case 191920001:
            return "ƒêi·ªÅu ch·ªânh VAT SOD";
          case 283640001:
            return "ƒêi·ªÅu ch·ªânh VAT SO";
          case 283640002:
            return "ƒêi·ªÅu ch·ªânh gi√° BOD";
          case 283640003:
            return "ƒêi·ªÅu ch·ªânh VAT BOD";
          case 283640004:
            return "H·ªßy phi·∫øu nh·∫≠p kho";
          case 283640005:
            return "ƒêi·ªÅu ch·ªânh phi·∫øu nh·∫≠p kho";
          case 283640006:
            return "ƒêi·ªÅu ch·ªânh VAT BO";
          case 283640007:
            return "ƒêi·ªÅu ch·ªânh ƒë·ªãnh l∆∞·ª£ng";
          case 283640008:
            return "H·ªßy phi·∫øu xu·∫•t kho";
          case 283640009:
            return "ƒêi·ªÅu ch·ªânh phi·∫øu xu·∫•t kho";
          default:
            return "Kh√¥ng x√°c ƒë·ªãnh";
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) {
          return "V·ª´a xong";
        } else if (diffInSeconds < 3600) {
          const minutes = Math.floor(diffInSeconds / 60);
          return `${minutes} ph√∫t tr∆∞·ªõc`;
        } else if (diffInSeconds < 86400) {
          const hours = Math.floor(diffInSeconds / 3600);
          return `${hours} gi·ªù tr∆∞·ªõc`;
        } else if (diffInSeconds < 2592000) {
          const days = Math.floor(diffInSeconds / 86400);
          return `${days} ng√†y tr∆∞·ªõc`;
        } else {
          return date.toLocaleDateString("vi-VN", {
            month: "2-digit",
            day: "2-digit",
          });
        }
      }

      async function getAllXseptions(token, query, callback) {
        let url = DATAVERSE_URL + query;
        console.log("url: ", url);
        let allData = [];
        let page = 1;

        while (url) {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          allData = allData.concat(data.value);

          page++;

          url = data["@odata.nextLink"] || null;
        }
        if (typeof callback === "function") {
          return callback(allData);
        }
        return allData; // <-- quan tr·ªçng
      }

      function mappingListTickets(allData) {
        // üîπ Mapping d·ªØ li·ªáu t·ª´ Dataverse v·ªÅ m·∫£ng chu·∫©n gi·ªëng sampleTickets
        supportSystemsData = allData.map((item, index) => ({
          id: item.crdfd_suport_systemid || "", // t·∫°o ID gi·ªëng sampleTickets
          title: item.crdfd_lydoieuchinh || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ",
          description: item.crdfd_lydoieuchinh || "",
          category: item.crdfd_loaiieuchinh || "other",
          priority: "medium",
          status: item.crdfd_trangthai || "Ch∆∞a x√°c ƒë·ªãnh",
          createdBy: item.crdfd_nguoiyeucau || "·∫®n danh",
          createdAt: item.createdon || "Kh√¥ng x√°c ƒë·ªãnh date",
          userTickets: item.crdfd_nguoiduyet || "Ch∆∞a x√°c ƒë·ªãnh",
          name: item.crdfd_name || "",
        }));

        supportSystemsData.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
        return supportSystemsData;
      }

      function mappingUser(allData) {
        approversData = allData.map((item, index) => ({
          idU: item.cr1bb_emailcal || "Kh√¥ng x√°c ƒë·ªãnh",
          useName: item.crdfd_name || "Kh√¥ng x√°c ƒë·ªãnh",
          phongban: item.crdfd_phongbantext || "Kh√¥ng x√°c ƒë·ªãnh",
          password: "wecare123@",
        }));
        return approversData;
      }

      function mappingSOD(allData) {
        ordersDetailData = allData.map((item, index) => ({
          idSOD: item.crdfd_saleorderdetailid || "Kh√¥ng x√°c ƒë·ªãnh",
          sodName: item.crdfd_name || "Kh√¥ng x√°c ƒë·ªãnh",
        }));
        return ordersDetailData;
      }
      function onCategoryChange(category) {
        const container = document.getElementById("dynamicFields");
        container.innerHTML = ""; // reset

        switch (parseInt(category)) {
          // ==== ƒêi·ªÅu ch·ªânh gi√° ====
          case 191920000: // ƒêi·ªÅu ch·ªânh gi√° SOD
          case 283640002: // ƒêi·ªÅu ch·ªânh gi√° BOD
            container.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√£ ƒë∆°n h√†ng</label>
          <input type="text" id="orderCodePrice" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° tr·ªã ƒëi·ªÅu ch·ªânh</label>
          <input type="number" id="adjustPrice" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p gi√° tr·ªã m·ªõi">
        </div>
      `;
            break;

          // ==== ƒêi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng ====
          //     case 283640007:
          //       container.innerHTML = `
          //   <div>
          //     <label class="block text-sm font-medium text-gray-700 mb-2">M√£ ƒë∆°n h√†ng</label>
          //     <input type="text" id="orderCodeQty" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
          //   </div>
          //   <div>
          //     <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë l∆∞·ª£ng m·ªõi</label>
          //     <input type="number" id="adjustQty" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng m·ªõi">
          //   </div>
          // `;
          //       break;

          // ==== Lo·∫°i h·ªßy ====
          case 283640004: // H·ªßy phi·∫øu nh·∫≠p kho
          case 283640008: // H·ªßy phi·∫øu xu·∫•t kho
            container.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√£ c·∫ßn h·ªßy</label>
          <input type="text" id="cancelCode" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p m√£ c·∫ßn h·ªßy">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√£ c·∫ßn h·ªßy</label>
          <input type="text" id="cancelCode" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng c·∫ßn h·ªßy">
        </div>
      `;
            break;

          // ==== ƒêi·ªÅu ch·ªânh ƒë·ªãnh l∆∞·ª£ng ====
          case 283640007: // ƒêi·ªÅu ch·ªânh ƒë·ªãnh l∆∞·ª£ng
            container.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">S·∫£n ph·∫©m</label>
          <input type="text" id="productCode" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ƒê∆°n v·ªã</label>
          <input type="text" id="unitCode" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p ƒë∆°n v·ªã">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° tr·ªã</label>
          <input type="number" id="adjustValue" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p gi√° tr·ªã ƒëi·ªÅu ch·ªânh">
        </div>
      `;
            break;

          // ==== ƒêi·ªÅu ch·ªânh VAT ====
          case 191920001: // VAT SOD
          case 283640001: // VAT SO
          case 283640003: // VAT BOD
          case 283640006: // VAT BO
          case 283640009: // VAT xu·∫•t kho
            container.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√£ ƒë∆°n h√†ng</label>
          <input type="text" id="orderCodeVat" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">VAT</label>
          <select id="vatOption" class="w-full px-4 py-2 border rounded-lg">
            <option value="yes">C√≥ VAT</option>
            <option value="no">Kh√¥ng VAT</option>
            <option value="0">0%</option>
            <option value="5">5%</option>
            <option value="8">8%</option>
            <option value="10">10%</option>
          </select>
        </div>
      `;
            break;

          default:
            container.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Th√¥ng tin th√™m</label>
          <input type="text" id="extraInfo" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p th√¥ng tin...">
        </div>
      `;
        }
      }

      // function setup value ch·ªçn user duy·ªát
      function initApproverChoices() {
        const approverSelect = document.getElementById("ticketApprover");
        if (!approverSelect) return;

        // N·∫øu ch∆∞a c√≥ th√¨ kh·ªüi t·∫°o Choices
        if (!approverChoices) {
          approverChoices = new Choices(approverSelect, {
            removeItemButton: true,
            searchEnabled: true,
            searchResultLimit: 5,
            placeholderValue: "Ch·ªçn ng∆∞·ªùi duy·ªát",
            noResultsText: "Kh√¥ng t√¨m th·∫•y",
            shouldSort: false,
          });
        } else {
          // N·∫øu ƒë√£ init th√¨ clear options c≈©
          approverChoices.clearChoices();
        }

        // Set l·∫°i danh s√°ch t·ª´ approversData
        const options = approversData.map((u) => ({
          value: u.idU,
          label: `${u.useName} (${u.phongban})`,
        }));

        approverChoices.setChoices(options, "value", "label", false);
      }

      // function setup value ch·ªçn ph√≤ng ban
      function loadDepartments() {
        const deptSelect = document.getElementById("ticketDepartment");
        const uniqueDepartments = [
          ...new Set(approversData.map((u) => u.phongban)),
        ];
        deptSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng ban</option>';
        uniqueDepartments.forEach((dept) => {
          const option = document.createElement("option");
          option.value = dept;
          option.textContent = dept;
          deptSelect.appendChild(option);
        });
      }

      // function setup value ch·ªçn ƒë∆°n h√†ng
      // function initOrderChoices() {
      //   const orderSelect = document.getElementById("ticketOrder");
      //   const choices = new Choices(orderSelect, {
      //     removeItemButton: true, // cho ph√©p x√≥a khi ch·ªçn
      //     searchEnabled: true,
      //     searchFields: ["label"],
      //     fuseOptions: {
      //       includeScore: true,
      //       threshold: 0.3, // c√†ng nh·ªè c√†ng kh·ªõp ch√≠nh x√°c, tƒÉng l√™n th√¨ cho ph√©p match m·ªù h∆°n
      //       distance: 100,
      //       minMatchCharLength: 2,
      //       ignoreLocation: false,
      //     }, // b·∫≠t search
      //     searchResultLimit: 10, // t·ªëi ƒëa 10 k·∫øt qu·∫£ khi search
      //     placeholderValue: "Ch·ªçn ƒë∆°n h√†ng",
      //     noResultsText: "Kh√¥ng t√¨m th·∫•y",
      //     shouldSort: false, // gi·ªØ nguy√™n th·ª© t·ª±
      //   });

      //   // map d·ªØ li·ªáu t·ª´ ordersDetailData
      //   const options = ordersDetailData.map((o) => ({
      //     value: o.idSOD,
      //     label: `${o.sodName}`, // c√≥ th·ªÉ th√™m code ho·∫∑c ng√†y t·∫°o n·∫øu mu·ªën
      //   }));

      //   choices.setChoices(options, "value", "label", false);
      // }

      // function login
      function initUserMenu() {
        // ================================
        // 1. L·∫•y c√°c ph·∫ßn t·ª≠ trong DOM
        // ================================
        const btn = document.getElementById("userMenuBtn"); // N√∫t user menu (hi·ªÉn th·ªã avatar + t√™n)
        const dropdown = document.getElementById("userMenuDropdown"); // Menu th·∫£ xu·ªëng (H·ªì s∆°, C√†i ƒë·∫∑t, ƒêƒÉng xu·∫•t/ƒêƒÉng nh·∫≠p)
        const loginModal = document.getElementById("loginModal"); // Modal ƒëƒÉng nh·∫≠p
        const loginForm = document.getElementById("loginForm"); // Form ƒëƒÉng nh·∫≠p
        const usernameInput = document.getElementById("username"); // Input t√†i kho·∫£n
        const passwordInput = document.getElementById("password"); // Input m·∫≠t kh·∫©u
        const userNameSpan = btn.querySelector("span.md\\:block"); // Span hi·ªÉn th·ªã t√™n user
        const links = dropdown.querySelectorAll("a"); // C√°c link trong dropdown
        const logoutLink = links[links.length - 1]; // Link cu·ªëi c√πng = Login/Logout

        const closeLoginBtn = document.getElementById("closeLoginModal"); // N√∫t ƒë√≥ng modal (n·∫øu c√≥)
        const cancelLoginBtn = document.getElementById("cancelLogin"); // N√∫t h·ªßy modal (n·∫øu c√≥)

        // ================================
        // 2. L·∫•y th√¥ng tin user hi·ªán t·∫°i t·ª´ localStorage
        // ================================
        let currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;

        // ================================
        // 3. H√†m c·∫≠p nh·∫≠t giao di·ªán menu theo tr·∫°ng th√°i login
        // ================================
        function updateUI() {
          const avatarSpan = document.getElementById("userAvatar");

          if (currentUser) {
            userNameSpan.textContent = currentUser.useName;
            logoutLink.textContent = "ƒêƒÉng xu·∫•t";

            // ƒë·ªïi avatar theo t√™n user
            const initials = getInitials(currentUser.useName);
            avatarSpan.textContent = initials;
            avatarSpan.className =
              "text-white text-sm font-medium rounded-full w-8 h-8 flex items-center justify-center " +
              getColorFromName(currentUser.useName);
          } else {
            userNameSpan.textContent = "Kh√°ch";
            logoutLink.textContent = "ƒêƒÉng nh·∫≠p";

            avatarSpan.textContent = "AD";
            avatarSpan.className =
              "text-white text-sm font-medium rounded-full w-8 h-8 flex items-center justify-center bg-gray-400";
          }
        }
        updateUI();

        // ================================
        // 4. N·∫øu ch∆∞a login th√¨ b·∫≠t modal ngay, ng∆∞·ª£c l·∫°i th√¨ fetch data
        if (!currentUser) {
          loginModal.classList.remove("hidden");
        } else {
          // ƒê√£ c√≥ user trong localStorage ‚Üí fetch l·∫°i d·ªØ li·ªáu ngay
          refreshData();
        }

        // ================================
        // 5. S·ª± ki·ªán click v√†o n√∫t user menu
        // ================================
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (currentUser) {
            // N·∫øu ƒë√£ login ‚Üí hi·ªán/·∫©n dropdown
            dropdown.classList.toggle("hidden");
          } else {
            // N·∫øu ch∆∞a login ‚Üí b·∫≠t modal login
            loginModal.classList.remove("hidden");
          }
        });

        // ================================
        // 6. ·∫®n dropdown khi click ra ngo√†i
        // ================================
        document.addEventListener("click", (e) => {
          if (
            currentUser &&
            !btn.contains(e.target) &&
            !dropdown.contains(e.target)
          ) {
            dropdown.classList.add("hidden");
          }
        });

        // NgƒÉn vi·ªác click trong modal l√†m ƒë√≥ng modal
        loginModal.addEventListener("click", (e) => e.stopPropagation());

        // ================================
        // 7. X·ª≠ l√Ω login
        // ================================
        const loginHandler = (e) => {
          e.preventDefault();
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();

          let found = null;

          // 7.1 Check trong danh s√°ch Admin
          found = AdminUser.find(
            (u) => u.username === username && u.password === password
          );

          // 7.2 N·∫øu kh√¥ng ph·∫£i admin ‚Üí check trong approversData
          if (!found) {
            found = approversData.find(
              (u) => u.idU === username && u.password === password
            );
          }

          if (found) {
            // N·∫øu login th√†nh c√¥ng
            currentUser = found;
            localStorage.setItem("currentUser", JSON.stringify(found)); // L∆∞u v√†o localStorage
            updateUI(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
            loginModal.classList.add("hidden"); // ·∫®n modal login
            showNotification("ƒêƒÉng nh·∫≠p th√†nh c√¥ng", "success");
            refreshData();
            init(); // G·ªçi h√†m init() ‚Üí render giao di·ªán + d·ªØ li·ªáu
          } else {
            // N·∫øu login th·∫•t b·∫°i
            showNotification("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!", "error");
          }
        };

        // ƒê·∫£m b·∫£o kh√¥ng b·ªã ƒëƒÉng k√Ω nhi·ªÅu l·∫ßn
        loginForm.removeEventListener("submit", loginHandler);
        loginForm.addEventListener("submit", loginHandler);

        // ================================
        // 8. X·ª≠ l√Ω logout / login link trong dropdown
        // ================================
        logoutLink.addEventListener("click", (e) => {
          e.preventDefault();
          dropdown.classList.add("hidden");

          if (currentUser) {
            // N·∫øu ƒëang login ‚Üí ti·∫øn h√†nh logout
            currentUser = null;
            localStorage.removeItem("currentUser"); // X√≥a user kh·ªèi localStorage
            tokenExpiry = null;
            clearUI(); // Reset giao di·ªán v·ªÅ m·∫∑c ƒë·ªãnh
            updateUI(); // Update menu v·ªÅ "Kh√°ch"
            loginModal.classList.remove("hidden"); // Hi·ªán modal login l·∫°i
          } else {
            // N·∫øu ch∆∞a login ‚Üí b·∫≠t modal login
            loginModal.classList.remove("hidden");
          }
        });

        // ================================
        // 9. N√∫t ƒë√≥ng/h·ªßy modal login
        // ================================
        if (closeLoginBtn)
          closeLoginBtn.addEventListener("click", () =>
            loginModal.classList.add("hidden")
          );
        if (cancelLoginBtn)
          cancelLoginBtn.addEventListener("click", () =>
            loginModal.classList.add("hidden")
          );
      }

      function clearUI() {
        // Reset l·∫°i c√°c container d·ªØ li·ªáu
        const ticketContainer = document.getElementById("ticketsTable");
        if (ticketContainer) ticketContainer.innerHTML = "";

        const approvalContainer = document.getElementById("approvalsContainer");
        if (approvalContainer) approvalContainer.innerHTML = "";

        const dashboardContainer =
          document.getElementById("dashboardContainer");
        if (dashboardContainer) dashboardContainer.innerHTML = "";

        // Reset c√°c select box
        const approverSelect = document.getElementById("ticketApprover");
        if (approverSelect) approverSelect.innerHTML = "";

        const deptSelect = document.getElementById("ticketDepartment");
        if (deptSelect)
          deptSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng ban</option>';

        // Reset bi·∫øn d·ªØ li·ªáu trong JS
        tickets = [];
        //approversData = [];
        ordersDetailData = [];
      }

      async function updateTicketStatus(ticketId, newStatus, currentUserEmail) {
        try {
          const token = await getToken(); // l·∫•y token an to√†n

          // 1. T√¨m record approval con d·ª±a tr√™n ticketId v√† email
          const query =
            `${DATAVERSE_URL}/crdfd_support_system_approvals` +
            `?$select=crdfd_support_system_approvalid` +
            `&$filter=_crdfd_masuport_value eq ${ticketId} and crdfd_nguoixacnhan eq '${currentUserEmail}'`;

          const res = await fetch(query, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (!res.ok) {
            throw new Error(
              `L·ªói khi t√¨m approval: ${res.status} ${res.statusText}`
            );
          }

          const data = await res.json();

          // N·∫øu kh√¥ng t√¨m th·∫•y approval record, ch·ªâ th√¥ng b√°o, kh√¥ng n√©m l·ªói
          if (!data.value || data.value.length === 0) {
            console.info(
              `‚ö† User ${currentUserEmail} kh√¥ng c√≥ approval record cho ticket n√†y.`
            );
            showNotification(
              "User n√†y kh√¥ng c√≥ record approval ƒë·ªÉ c·∫≠p nh·∫≠t.",
              "info"
            );
            return false;
          }

          const approvalDetailId =
            data.value[0].crdfd_support_system_approvalid;

          // 2. Update record approval
          const patchUrl = `${DATAVERSE_URL}/crdfd_support_system_approvals(${approvalDetailId})`;
          const body = { cr1bb_trang_thai: newStatus }; // d√πng ƒë√∫ng field trong Dataverse

          const updateRes = await fetch(patchUrl, {
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "Content-Type": "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
            body: JSON.stringify(body),
          });

          if (!updateRes.ok) {
            throw new Error(
              `Update th·∫•t b·∫°i: ${updateRes.status} ${updateRes.statusText}`
            );
          }

          console.log(
            `‚úî Approval updated to ${newStatus} cho user ${currentUserEmail}`
          );
          showNotification(
            "C·∫≠p nh·∫≠t tr·∫°ng th√°i approval th√†nh c√¥ng!",
            "success"
          );

          // Refresh data sau khi update
          refreshData();

          return true;
        } catch (err) {
          console.error("‚ùå Error update ticket:", err);
          showNotification("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + err.message, "error");
          return false;
        }
      }

      // async function updateTicketStatus(ticketId, newStatus, currentUserEmail) {
      //   try {
      //     const token = await getToken(); // d√πng h√†m token safe

      //     // 1. T√¨m record trong b·∫£ng con
      //     const query =
      //       `${DATAVERSE_URL}/crdfd_support_system_approvals` +
      //       `?$select=crdfd_support_system_approvalid` +
      //       `&$filter=_crdfd_masuport_value eq ${ticketId} and crdfd_nguoixacnhan eq '${currentUserEmail}'`;
      //     const res = await fetch(query, {
      //       method: "GET",
      //       headers: {
      //         Authorization: `Bearer ${token}`,
      //         Accept: "application/json",
      //         "OData-MaxVersion": "4.0",
      //         "OData-Version": "4.0",
      //       },
      //     });

      //     if (!res.ok) {
      //       throw new Error(
      //         `L·ªói khi t√¨m approval: ${res.status} ${res.statusText}`
      //       );
      //     }

      //     const data = await res.json();
      //     if (!data.value || data.value.length === 0) {
      //       throw new Error("Kh√¥ng t√¨m th·∫•y approval record cho user n√†y.");
      //     }

      //     const approvalDetailId =
      //       data.value[0].crdfd_support_system_approvalid;

      //     // 2. Update record con
      //     const patchUrl = `${DATAVERSE_URL}/crdfd_support_system_approvals(${approvalDetailId})`;
      //     const body = { cr1bb_trang_thai: newStatus };

      //     const updateRes = await fetch(patchUrl, {
      //       method: "PATCH",
      //       headers: {
      //         Authorization: `Bearer ${token}`,
      //         Accept: "application/json",
      //         "Content-Type": "application/json",
      //         "OData-MaxVersion": "4.0",
      //         "OData-Version": "4.0",
      //       },
      //       body: JSON.stringify(body),
      //     });

      //     if (!updateRes.ok) {
      //       throw new Error(
      //         `Update th·∫•t b·∫°i: ${updateRes.status} ${updateRes.statusText}`
      //       );
      //     }

      //     console.log(
      //       `‚úî Approval updated to ${newStatus} cho user ${currentUserEmail}`
      //     );
      //     refreshData();
      //     return true;
      //   } catch (err) {
      //     console.error("‚ùå Error update ticket:", err);
      //     throw err;
      //   }
      // }

      function getInitials(fullName) {
        if (!fullName) return "AD";
        const parts = fullName.trim().split(" ");
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      // Sinh m√†u ng·∫´u nhi√™n nh∆∞ng c·ªë ƒë·ªãnh theo t√™n user
      function getColorFromName(name) {
        const colors = [
          "bg-red-500",
          "bg-green-500",
          "bg-blue-500",
          "bg-yellow-500",
          "bg-purple-500",
          "bg-pink-500",
          "bg-indigo-500",
          "bg-teal-500",
          "bg-orange-500",
          "bg-cyan-500",
        ];
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % colors.length;
        return colors[index];
      }
    </script>
  </body>
</html>
