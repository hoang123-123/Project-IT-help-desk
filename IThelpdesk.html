<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IT Help Desk - Hệ thống hỗ trợ CNTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="icon" href="data:," />
    <style>
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #374151;
      }

      /* Sidebar transitions */
      .sidebar-transition {
        transition: all 0.3s ease-in-out;
      }

      /* Card hover effects */
      .card-hover {
        transition: all 0.2s ease-in-out;
      }
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      /* Status badges with gradients */
      .status-pending {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
      }
      .status-approved {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .status-rejected {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .status-in-progress {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
      }
      .status-completed {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Table styles */
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        text-align: left;
        padding: 8px 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
      }

      th {
        background-color: #f9fafb;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #6b7280;
      }

      /* Button styles */
      button {
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s ease-in-out;
      }

      button:hover {
        transform: translateY(-1px);
      }

      /* Input styles */
      input,
      select,
      textarea {
        font-family: inherit;
        transition: all 0.2s ease-in-out;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Modal backdrop */
      .modal-backdrop {
        backdrop-filter: blur(4px);
      }

      /* Loading animation */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Pulse animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Fade in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      /* Responsive table wrapper */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Enhanced responsive design */
      @media (max-width: 640px) {
        /* Mobile styles */
        .mobile-hidden {
          display: none !important;
        }

        .mobile-full {
          width: 100% !important;
        }

        .mobile-stack {
          flex-direction: column;
        }

        .mobile-text-sm {
          font-size: 0.75rem;
        }

        /* Compact padding on mobile */
        .mobile-p-2 {
          padding: 0.5rem;
        }

        .mobile-p-3 {
          padding: 0.75rem;
        }

        /* Table on mobile */
        th,
        td {
          padding: 6px 8px;
          font-size: 0.75rem;
        }

        /* Cards on mobile */
        .card-mobile {
          padding: 1rem;
          margin: 0.5rem 0;
        }

        /* Button adjustments */
        .btn-mobile {
          padding: 0.5rem 0.75rem;
          font-size: 0.875rem;
        }
      }

      @media (max-width: 768px) {
        /* Tablet styles */
        .tablet-hidden {
          display: none !important;
        }

        .tablet-stack {
          flex-direction: column;
        }

        .tablet-full {
          width: 100% !important;
        }
      }

      @media (max-width: 1024px) {
        /* Desktop small styles */
        .lg-hidden {
          display: none !important;
        }
      }

      /* Print styles */
      @media print {
        .no-print {
          display: none !important;
        }

        body {
          background: white !important;
        }
      }

      /* Enhanced modal styles for mobile */
      .modal-mobile {
        margin: 0.5rem;
        max-height: calc(100vh - 1rem);
        width: calc(100% - 1rem);
      }

      @media (min-width: 640px) {
        .modal-mobile {
          margin: 2rem;
          max-height: calc(100vh - 4rem);
          width: calc(100% - 4rem);
          max-width: 42rem;
        }
      }

      @media (min-width: 768px) {
        .modal-mobile {
          max-width: 48rem;
        }
      }

      /* Responsive grid adjustments */
      .responsive-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }

      @media (min-width: 640px) {
        .responsive-grid-sm-2 {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 768px) {
        .responsive-grid-md-3 {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .responsive-grid-lg-4 {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      /* Responsive text sizes */
      .text-responsive-xs {
        font-size: 0.75rem;
      }

      @media (min-width: 768px) {
        .text-responsive-xs {
          font-size: 0.875rem;
        }
      }

      .text-responsive-sm {
        font-size: 0.875rem;
      }

      @media (min-width: 768px) {
        .text-responsive-sm {
          font-size: 1rem;
        }
      }

      .text-responsive-base {
        font-size: 1rem;
      }

      @media (min-width: 768px) {
        .text-responsive-base {
          font-size: 1.125rem;
        }
      }

      /* Responsive spacing */
      .space-responsive {
        margin: 0.5rem;
      }

      @media (min-width: 768px) {
        .space-responsive {
          margin: 1rem;
        }
      }

      @media (min-width: 1024px) {
        .space-responsive {
          margin: 1.5rem;
        }
      }

      /* Login Modal Animation */
      .login-modal-animate {
        animation: modalSlideIn 0.3s ease-out forwards;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes modalSlideOut {
        from {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
        to {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
      }

      /* Glass morphism effect */
      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Input focus glow effect */
      .input-glow:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1),
          0 0 20px rgba(59, 130, 246, 0.1);
      }

      /* Button hover glow */
      .btn-glow:hover {
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Sidebar -->
    <div
      id="sidebar"
      class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-transition transform -translate-x-full lg:translate-x-0"
    >
      <div
        class="flex items-center justify-between h-16 px-4 lg:px-6 border-b border-gray-200"
      >
        <div class="flex items-center space-x-2 lg:space-x-3">
          <div
            class="w-6 h-6 lg:w-8 lg:h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center"
          >
            <i class="fas fa-headset text-white text-xs lg:text-sm"></i>
          </div>
          <h1
            class="text-lg lg:text-xl font-bold text-gray-800 mobile-hidden lg:block"
          >
            IT Help Desk
          </h1>
        </div>
        <button
          id="closeSidebar"
          class="lg:hidden text-gray-500 hover:text-gray-700 p-2"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <nav class="mt-6 px-2 lg:px-4">
        <div class="space-y-1 lg:space-y-2">
          <a
            href="#tickets"
            class="nav-item flex items-center px-3 lg:px-4 py-2 lg:py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors active text-responsive-sm"
          >
            <i class="fas fa-ticket-alt w-4 h-4 lg:w-5 lg:h-5 mr-2 lg:mr-3"></i>
            <span>Quản lý Ticket</span>
          </a>
          <a
            href="#dashboard"
            class="nav-item flex items-center px-3 lg:px-4 py-2 lg:py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors text-responsive-sm"
          >
            <i
              class="fas fa-tachometer-alt w-4 h-4 lg:w-5 lg:h-5 mr-2 lg:mr-3"
            ></i>
            <span>Dashboard</span>
          </a>
          <a
            href="#guides"
            class="nav-item flex items-center px-3 lg:px-4 py-2 lg:py-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors text-responsive-sm"
          >
            <i class="fas fa-book w-4 h-4 lg:w-5 lg:h-5 mr-2 lg:mr-3"></i>
            <span class="mobile-hidden sm:block">Quy trình nghiệp vụ</span>
            <span class="sm:hidden">Quy trình</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen">
      <!-- Top Navigation -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div
          class="flex items-center justify-between h-14 lg:h-16 px-3 lg:px-6"
        >
          <div class="flex items-center space-x-2 lg:space-x-4">
            <button
              id="openSidebar"
              class="lg:hidden text-gray-500 hover:text-gray-700 p-2"
            >
              <i class="fas fa-bars"></i>
            </button>
            <h2
              id="pageTitle"
              class="text-lg lg:text-xl font-semibold text-gray-800"
            >
              Dashboard
            </h2>
          </div>

          <div class="flex items-center space-x-2 lg:space-x-4">
            <!-- User Menu -->
            <div class="relative">
              <button
                id="userMenuBtn"
                class="flex items-center space-x-1 lg:space-x-2 p-1.5 lg:p-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <div
                  class="w-6 h-6 lg:w-8 lg:h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center"
                >
                  <span
                    class="text-white text-xs lg:text-sm font-medium"
                    id="userAvatar"
                    >AD</span
                  >
                </div>
                <span class="hidden md:block text-xs lg:text-sm font-medium"
                  >Admin User</span
                >
                <i class="fas fa-chevron-down text-xs mobile-hidden"></i>
              </button>
              <div
                id="userMenuDropdown"
                class="absolute right-0 mt-2 w-40 lg:w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
              >
                <div class="py-2">
                  <a
                    href="#"
                    class="block px-3 lg:px-4 py-2 text-xs lg:text-sm text-gray-700 hover:bg-gray-100"
                    >Hồ sơ</a
                  >
                  <a
                    href="#"
                    class="block px-3 lg:px-4 py-2 text-xs lg:text-sm text-gray-700 hover:bg-gray-100"
                    >Cài đặt</a
                  >
                  <hr class="my-2" />
                  <a
                    href="#"
                    class="block px-3 lg:px-4 py-2 text-xs lg:text-sm text-gray-700 hover:bg-gray-100"
                    >Đăng xuất</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <main class="p-3 lg:p-6">
        <!-- Dashboard Section -->
        <div id="dashboard" class="page-content">
          <!-- Stats Cards -->
          <div
            id="dashboardStats"
            class="responsive-grid responsive-grid-sm-2 responsive-grid-lg-4 gap-3 lg:gap-6 mb-6 lg:mb-8"
          >
            <!-- Stats sẽ được render động bằng JavaScript -->
          </div>

          <!-- Charts Section -->
          <div
            id="chartsSection"
            class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 lg:mb-8"
          >
            <!-- Biểu đồ sẽ được render ở đây -->
          </div>

          <!-- Recent Activities -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-4 lg:p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-base lg:text-lg font-semibold text-gray-800">
                  Hoạt động gần đây
                </h3>
                <button
                  id="showAllActivities"
                  class="text-blue-600 hover:text-blue-700 text-xs lg:text-sm font-medium cursor-pointer"
                >
                  Xem tất cả
                </button>
              </div>
            </div>
            <div class="p-4 lg:p-6">
              <div
                id="recentActivities"
                class="space-y-3 lg:space-y-4 max-h-96 overflow-y-auto"
              >
                <!-- Recent activities will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tickets Section -->
        <div id="tickets" class="page-content hidden">
          <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col min-h-[400px] sm:min-h-[500px] lg:min-h-[600px]"
          >
            <!-- Header -->
            <div class="p-4 lg:p-6 border-b border-gray-200">
              <div
                class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-3 sm:space-y-0"
              >
                <!-- Tiêu đề cho mobile -->
                <div class="sm:hidden">
                  <h3 class="text-base lg:text-lg font-semibold text-gray-800">
                    Quản lý Tickets
                  </h3>
                  <div
                    id="searchResultsMobile"
                    class="text-sm text-gray-600 mt-1 hidden"
                  >
                    <!-- Kết quả tìm kiếm sẽ hiển thị ở đây trên mobile -->
                  </div>
                </div>

                <!-- Tiêu đề cho desktop -->
                <div class="hidden sm:block">
                  <h3 class="text-lg lg:text-xl font-semibold text-gray-800">
                    Quản lý Tickets
                  </h3>
                </div>
                <div
                  class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto"
                >
                  <!-- Ô tìm kiếm -->
                  <div class="relative flex-1 sm:flex-none">
                    <input
                      type="text"
                      id="searchTickets"
                      placeholder="Tìm kiếm tickets..."
                      class="w-full sm:w-48 lg:w-64 pl-8 lg:pl-10 pr-8 lg:pr-10 py-2 text-sm lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <i
                      class="fas fa-search absolute left-2.5 lg:left-3 top-2.5 lg:top-3 text-gray-400 text-sm"
                    ></i>
                    <button
                      id="clearSearch"
                      class="absolute right-2.5 lg:right-3 top-2.5 lg:top-3 text-gray-400 hover:text-gray-600 text-sm hidden"
                      title="Xóa tìm kiếm"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <!-- Bộ lọc trạng thái -->
                  <select
                    id="statusFilter"
                    class="w-full sm:w-auto px-3 lg:px-4 py-2 text-sm lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">Tất cả trạng thái</option>
                    <option value="pending">Chờ phê duyệt</option>
                    <option value="approved">Đã phê duyệt</option>
                    <option value="in-progress">Đang xử lý</option>
                    <option value="completed">Hoàn thành</option>
                    <option value="rejected">Từ chối</option>
                  </select>

                  <!-- Nút tạo Ticket -->
                  <button
                    id="btnCreateTicket"
                    class="w-full sm:w-auto px-3 lg:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center text-sm lg:text-base"
                  >
                    <i class="fas fa-plus-circle mr-2"></i>
                    <span class="mobile-hidden sm:inline">Tạo Ticket</span>
                    <span class="sm:hidden">Tạo</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Table + Scroll -->
            <div class="flex-1 flex flex-col min-h-0">
              <div class="flex-1 overflow-y-auto overflow-x-auto min-h-[300px]">
                <table class="w-full whitespace-nowrap">
                  <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        ID
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Tiêu đề
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Loại
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Người tạo
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Trạng thái
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Ngày tạo
                      </th>
                      <th
                        class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase"
                      >
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="ticketsTable"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Placeholder rows để đảm bảo chiều cao tối thiểu -->
                    <tr class="h-12">
                      <td colspan="7" class="text-center text-gray-500 py-8">
                        Đang tải dữ liệu...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Pagination - Luôn ở vị trí cố định -->
              <div class="flex-shrink-0 p-4 border-t border-gray-200 bg-white h-20 flex items-center">
                <div
                  class="flex flex-col sm:flex-row items-center justify-between gap-3 w-full"
                >
                  <!-- Thông tin trang -->
                  <div class="text-sm text-gray-600 order-2 sm:order-1">
                    <span id="paginationInfo">Hiển thị 1-10 của 0 kết quả</span>
                  </div>

                  <!-- Điều khiển phân trang -->
                  <div
                    id="ticketsPagination"
                    class="flex flex-wrap items-center justify-center gap-1 order-1 sm:order-2"
                  >
                    <button
                      class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50 disabled:text-gray-400 disabled:cursor-not-allowed"
                      disabled
                    >
                      Previous
                    </button>
                    <button
                      class="px-3 py-1 border rounded bg-blue-600 text-white"
                    >
                      1
                    </button>
                    <button
                      class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50 disabled:text-gray-400 disabled:cursor-not-allowed"
                      disabled
                    >
                      Next
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quy trình nghiệp vụ -->
        <div id="guides" class="page-content hidden space-responsive">
          <h2 class="text-xl lg:text-2xl font-bold mb-3 lg:mb-4">
            Quy trình nghiệp vụ
          </h2>
          <div id="guideContent" class="prose max-w-none text-responsive-sm">
            <!-- Nội dung sẽ render theo phòng ban -->
          </div>
        </div>

        <!-- New Ticket Modal -->
        <div
          id="new-ticket"
          class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-2 lg:p-4"
        >
          <div class="modal-mobile mx-auto">
            <div
              class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full max-h-full"
            >
              <!-- Header -->
              <div
                class="p-3 lg:p-6 border-b border-gray-200 flex justify-between items-center flex-shrink-0"
              >
                <h3 class="text-base lg:text-xl font-semibold text-gray-800">
                  Tạo Ticket mới
                </h3>
                <button
                  id="closeNewTicket"
                  class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-100 rounded"
                >
                  <i class="fas fa-times text-sm lg:text-base"></i>
                </button>
              </div>

              <!-- Body -->
              <div class="flex-1 overflow-y-auto p-3 lg:p-6">
                <form id="newTicketForm" class="space-y-3 lg:space-y-6">
                  <!-- Phòng ban -->
                  <div>
                    <label
                      class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2"
                      >Phòng ban *</label
                    >
                    <select
                      id="ticketDepartment"
                      required
                      class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    ></select>
                  </div>

                  <!-- Loại yêu cầu -->
                  <div>
                    <label
                      class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2"
                      >Loại yêu cầu *</label
                    >
                    <select
                      id="ticketCategory"
                      required
                      onchange="onCategoryChange(this.value)"
                      class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    ></select>
                  </div>

                  <!-- Thông tin chung -->
                  <div
                    class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6"
                  >
                    <div>
                      <label
                        class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2"
                        >Người duyệt *</label
                      >
                      <select
                        id="ticketApprover"
                        multiple
                        required
                        class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      ></select>
                    </div>
                    <div>
                      <label
                        class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2"
                        >Thông tin yêu cầu *</label
                      >
                      <input
                        type="text"
                        id="ticketAdjustmentInfo"
                        required
                        class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Nhập thông tin chi tiết"
                      />
                    </div>
                  </div>

                  <!-- Trường động -->
                  <div id="dynamicFields" class="space-y-3 lg:space-y-4"></div>

                  <!-- Mô tả -->
                  <div>
                    <label
                      class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2"
                      >Mô tả chi tiết</label
                    >
                    <textarea
                      id="ticketDescription"
                      rows="3"
                      class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                      placeholder="Mô tả chi tiết vấn đề... "
                      required
                    ></textarea>
                  </div>
                </form>
              </div>

              <!-- Footer -->
              <div
                class="flex flex-col-reverse sm:flex-row items-center justify-end space-y-reverse space-y-2 sm:space-y-0 sm:space-x-4 p-3 lg:p-6 border-t border-gray-200 flex-shrink-0"
              >
                <button
                  type="button"
                  id="cancelTicket"
                  class="w-full sm:w-auto px-3 lg:px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-xs lg:text-sm"
                >
                  Hủy
                </button>
                <button
                  type="button"
                  id="submitTicket"
                  class="w-full sm:w-auto px-3 lg:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mb-2 sm:mb-0 text-xs lg:text-sm opacity-50 cursor-not-allowed"
                  disabled
                  title="Vui lòng nhập đầy đủ thông tin"
                >
                  Tạo Ticket
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Approvals Section -->
        <div id="approvals" class="page-content hidden">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-4 lg:p-6 border-b border-gray-200">
              <h3 class="text-base lg:text-lg font-semibold text-gray-800">
                Phê duyệt Tickets
              </h3>
            </div>
            <div class="table-responsive">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ID
                    </th>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Tiêu đề
                    </th>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider tablet-hidden"
                    >
                      Người tạo
                    </th>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider mobile-hidden"
                    >
                      Loại
                    </th>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider mobile-hidden"
                    >
                      Ngày tạo
                    </th>
                    <th
                      class="px-3 lg:px-6 py-2 lg:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Hành động
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="approvalsTable"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Approval tickets will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal for Ticket Details -->
    <div
      id="ticketModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-2 lg:p-4">
        <div
          class="bg-white rounded-xl shadow-xl w-full max-w-sm sm:max-w-2xl lg:max-w-4xl max-h-[90vh] overflow-y-auto"
        >
          <div class="p-4 lg:p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-base lg:text-lg font-semibold text-gray-800">
                Chi tiết Ticket
              </h3>
              <button
                id="closeTicketModal"
                class="text-gray-500 hover:text-gray-700 p-1"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div id="ticketModalContent" class="p-4 lg:p-6">
            <!-- Ticket details will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Approval -->
    <div
      id="approvalModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-2 lg:p-4">
        <div
          class="bg-white rounded-xl shadow-xl w-full max-w-sm sm:max-w-lg lg:max-w-2xl"
        >
          <div class="p-4 lg:p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-base lg:text-lg font-semibold text-gray-800">
                Phê duyệt Ticket
              </h3>
              <button
                id="closeApprovalModal"
                class="text-gray-500 hover:text-gray-700 p-1"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="p-4 lg:p-6">
            <div id="approvalTicketInfo" class="mb-4 lg:mb-6">
              <!-- Ticket info will be populated here -->
            </div>
            <div class="mb-4 lg:mb-6">
              <label
                class="block text-xs lg:text-sm font-medium text-gray-700 mb-2"
                >Ghi chú (tùy chọn)</label
              >
              <textarea
                id="approvalNotes"
                rows="3"
                class="w-full px-3 lg:px-4 py-2 text-xs lg:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Nhập ghi chú nếu cần..."
              ></textarea>
            </div>
            <div
              class="flex flex-col sm:flex-row items-center justify-end space-y-2 sm:space-y-0 sm:space-x-4"
            >
              <button
                id="rejectTicket"
                class="w-full sm:w-auto px-4 lg:px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-xs lg:text-sm"
              >
                Từ chối
              </button>
              <button
                id="approveTicket"
                class="w-full sm:w-auto px-4 lg:px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs lg:text-sm"
              >
                Phê duyệt
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Login -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-gradient-to-br from-blue-900/20 via-purple-900/20 to-pink-900/20 backdrop-blur-sm hidden z-50"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-md p-8 relative border border-white/20 transform transition-all duration-300 scale-95 opacity-0 login-modal-animate"
        >
          <!-- Close Button -->
          <button
            id="closeLoginModal"
            class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100/80 hover:bg-gray-200/80 text-gray-500 hover:text-gray-700 transition-all duration-200 hover:scale-110"
          >
            <i class="fas fa-times text-sm"></i>
          </button>

          <!-- Header -->
          <div class="text-center mb-8">
            <div
              class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg"
            >
              <i class="fas fa-user-shield text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">
              Chào mừng trở lại
            </h3>
            <p class="text-gray-600 text-sm">
              Đăng nhập để tiếp tục sử dụng hệ thống
            </p>
          </div>

          <!-- Form -->
          <form id="loginForm" class="space-y-6">
            <!-- Username Field -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Tài khoản</label
              >
              <div class="relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <i class="fas fa-user text-gray-400 text-sm"></i>
                </div>
                <input
                  type="text"
                  id="username"
                  required
                  class="w-full pl-10 pr-4 py-3 text-sm bg-gray-50/80 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-200 placeholder-gray-400"
                  placeholder="Nhập tài khoản của bạn"
                />
              </div>
            </div>

            <!-- Password Field -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Mật khẩu</label
              >
              <div class="relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <i class="fas fa-lock text-gray-400 text-sm"></i>
                </div>
                <input
                  type="password"
                  id="password"
                  required
                  class="w-full pl-10 pr-12 py-3 text-sm bg-gray-50/80 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-200 placeholder-gray-400"
                  placeholder="Nhập mật khẩu của bạn"
                />
                <button
                  type="button"
                  id="togglePassword"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors duration-200"
                >
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <!-- Remember Me -->
            <div class="flex items-center justify-between">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                />
                <span class="ml-2 text-sm text-gray-600"
                  >Ghi nhớ đăng nhập</span
                >
              </label>
              <a
                href="#"
                class="text-sm text-blue-600 hover:text-blue-700 font-medium transition-colors duration-200"
                >Quên mật khẩu?</a
              >
            </div>

            <!-- Buttons -->
            <div class="space-y-3">
              <button
                type="submit"
                class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-xl hover:from-blue-700 hover:to-purple-700 focus:ring-4 focus:ring-blue-500/20 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-xl"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>
                Đăng nhập
              </button>
              <button
                type="button"
                id="cancelLogin"
                class="w-full py-3 px-4 bg-gray-100/80 text-gray-700 font-medium rounded-xl hover:bg-gray-200/80 focus:ring-4 focus:ring-gray-500/20 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]"
              >
                <i class="fas fa-times mr-2"></i>
                Hủy bỏ
              </button>
            </div>
          </form>

          <!-- Footer -->
          <div class="mt-8 pt-6 border-t border-gray-200/50 text-center">
            <p class="text-xs text-gray-500">
              Bằng việc đăng nhập, bạn đồng ý với
              <a href="#" class="text-blue-600 hover:text-blue-700 font-medium"
                >Điều khoản sử dụng</a
              >
              và
              <a href="#" class="text-blue-600 hover:text-blue-700 font-medium"
                >Chính sách bảo mật</a
              >
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ======== Setting =============

      let token = null; // Token để xác thực API

      // Dashboard filtering functions
      function filterDashboard(filterType, filterLabel, cardElement) {
        // Toggle filter nếu click vào card đã active
        if (window.currentDashboardFilter === filterType) {
          clearDashboardFilter();
          return;
        }

        // Set filter mới
        window.currentDashboardFilter = filterType;

        // Update visual state của cards
        updateStatsCardsVisualState(cardElement);

        // Filter charts và activities
        filterChartsAndActivities(filterType);

        // Show filter indicator
        showFilterIndicator(filterLabel);
      }

      function clearDashboardFilter() {
        window.currentDashboardFilter = null;

        // Reset visual state của tất cả cards
        document.querySelectorAll("[data-filter]").forEach((card) => {
          card.classList.remove("ring-2", "ring-blue-500", "bg-blue-50");
        });

        // Reload charts và activities với dữ liệu đầy đủ
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";

        if (isAdmin) {
          createStatusChart();
          createTimeChart();
          createAdminCategoryChart();
        } else {
          createUserStatusChart(currentUser.idU);
          createUserActivityChart(currentUser.idU);
        }

        loadRecentActivities();
        hideFilterIndicator();
      }

      function updateStatsCardsVisualState(activeCard) {
        // Reset tất cả cards
        document.querySelectorAll("[data-filter]").forEach((card) => {
          card.classList.remove("ring-2", "ring-blue-500", "bg-blue-50");
        });

        // Highlight card được chọn
        if (activeCard) {
          activeCard.classList.add("ring-2", "ring-blue-500", "bg-blue-50");
        }
      }

      function filterChartsAndActivities(filterType) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";

        // Filter tickets theo status
        let filteredTickets = [];
        switch (filterType) {
          case "pending":
            filteredTickets = tickets.filter((t) => t.status === 191920002);
            break;
          case "approved":
            filteredTickets = tickets.filter((t) => t.status === 191920000);
            break;
          case "rejected":
            filteredTickets = tickets.filter((t) => t.status === 191920001);
            break;
          default:
            filteredTickets = tickets;
        }

        // Update charts với dữ liệu đã filter
        if (isAdmin) {
          createFilteredAdminCharts(filteredTickets, filterType);
        } else {
          createFilteredUserCharts(
            filteredTickets,
            filterType,
            currentUser.idU
          );
        }

        // Update activities với dữ liệu đã filter
        loadFilteredRecentActivities(filteredTickets);
      }

      function showFilterIndicator(filterLabel) {
        // Tạo hoặc update filter indicator
        let indicator = document.getElementById("filterIndicator");
        if (!indicator) {
          indicator = document.createElement("div");
          indicator.id = "filterIndicator";
          indicator.className =
            "mb-4 p-3 bg-blue-100 border border-blue-200 rounded-lg flex items-center justify-between";

          const chartsSection = document.getElementById("chartsSection");
          chartsSection.parentNode.insertBefore(indicator, chartsSection);
        }

        indicator.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-filter text-blue-600 mr-2"></i>
            <span class="text-sm font-medium text-blue-800">Đang lọc: ${filterLabel}</span>
          </div>
          <button onclick="clearDashboardFilter()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
            <i class="fas fa-times mr-1"></i>Xóa bộ lọc
          </button>
        `;
      }

      function hideFilterIndicator() {
        const indicator = document.getElementById("filterIndicator");
        if (indicator) {
          indicator.remove();
        }
      }
      let tickets = [];
      let supportSystemsData = [];
      let ordersDetailData = [];
      let approversData = []; // danh sach user
      let units = []; // danh sách đơn vị
      let approverChoices = null;
      let ticketHandlersInitialized = false;
      let currentTicketPage = 1;
      let unitChoices;
      //const ticketsPerPage = 10;
      let ticketsPerPage = getTicketsPerPage();

      // Biến cho tính năng tìm kiếm và lọc
      let filteredTickets = [];
      let currentSearchTerm = "";
      let currentStatusFilter = "";
      const DATAVERSE_URL = "https://wecare-ii.crm5.dynamics.com/api/data/v9.0";

      const AdminUser = [
        {
          idU: "admin", // dùng thay cho username
          useName: "Admin WC", // đồng bộ với approversData
          phongban: "Hệ thống", // cho admin 1 phòng ban mặc định
          password: "123456",
        },
      ];

      const USER_QUERY =
        "/crdfd_employees" +
        "?$select=cr1bb_emailcal,crdfd_name,crdfd_phongbantext" +
        "&$filter=statecode eq 0 and crdfd_trangthai ne 191920004 and crdfd_local ne 'Sài Gòn' and cr1bb_chucvutext ne null ";

      const Units_QUERY =
        "/crdfd_unitses" +
        "?$select=crdfd_name, crdfd_unitsid" +
        "&$filter=statecode eq 0";
      const categoryByDepartment = {
        "Kho vận": [
          { value: "283640008", text: "Hủy phiếu xuất kho" },
          { value: "283640004", text: "Hủy phiếu nhập kho" },
          
          { value: "283640009", text: "Điều chỉnh phiếu xuất kho" },
          { value: "283640005", text: "Điều chỉnh phiếu nhập kho" },
        ],
        "Phòng Cung ứng": [
          { value: "283640002", text: "Điều chỉnh giá Buy order detail" },
          { value: "283640003", text: "Điều chỉnh VAT Buy order detail" },
          { value: "283640006", text: "Điều chỉnh VAT Buy order" },
        ],
        "Phòng Phát triển Kinh doanh": [
          { value: "191920000", text: "Điều chỉnh giá Sale order detail" },
          { value: "191920001", text: "Điều chỉnh VAT Sale order detail" },
          { value: "283640001", text: "Điều chỉnh VAT Sale order" },
        ],
        "Phòng Nhân sự": [],
        "Phòng Tài chính & Kế toán": [],
        "Phòng R&D": [{ value: "283640007", text: "Điều chỉnh định lượng" }],
        "Phòng Công nghệ": [],
        // add các phòng ban khác nếu cần
      };

      // ========== Load web ================
      // Initialize the application
      document.addEventListener("DOMContentLoaded", async () => {
        token = await getToken(); // chờ token
        await getData();
        initUserMenu(); // init menu + modal login
        const currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;
        if (currentUser) {
          init(); // user đã login trước → render giao diện/data luôn
        }
      });

      window.addEventListener("resize", () => {
        ticketsPerPage = getTicketsPerPage();
        //console.log("Cập nhật ticketsPerPage:", ticketsPerPage);
        loadTickets(); // nếu bạn có hàm render lại
      });

      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("userMenuBtn");
        const dropdown = document.getElementById("userMenuDropdown");

        if (!btn || !dropdown) return; // tránh lỗi null

        btn.addEventListener("click", (e) => {
          e.stopPropagation(); // tránh click ra ngoài kích hoạt sự kiện document
          dropdown.classList.toggle("hidden");
        });

        // Ẩn menu khi click ra ngoài
        document.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        initUserMenu();

        const currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;
        if (currentUser) {
          init(); // render data nếu đã login trước đó
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const btnCreateTicket = document.getElementById("btnCreateTicket");
        const newTicketModal = document.getElementById("new-ticket");
        const closeNewTicket = document.getElementById("closeNewTicket");
        const cancelTicket = document.getElementById("cancelTicket");

        if (btnCreateTicket) {
          btnCreateTicket.addEventListener("click", () => {
            // Kiểm tra user đã đăng nhập chưa
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
              showNotification("Vui lòng đăng nhập để tạo ticket!", "error");
              // Mở modal đăng nhập
              const loginModal = document.getElementById("loginModal");
              if (loginModal) {
                loginModal.classList.remove("hidden");
              }
              return;
            }

            newTicketModal.classList.remove("hidden");
          });
        }

        if (closeNewTicket) {
          closeNewTicket.addEventListener("click", () => {
            resetTicketModal();
            newTicketModal.classList.add("hidden");
          });
        }

        if (cancelTicket) {
          cancelTicket.addEventListener("click", () => {
            resetTicketModal();
            newTicketModal.classList.add("hidden");
          });
        }
        
      });

      // Function để reset modal khi đóng
      function resetTicketModal() {
        // Reset form
        const form = document.getElementById('newTicketForm');
        if (form) {
          form.reset();
        }
        
        // Reset dynamic fields
        const dynamicFields = document.getElementById('dynamicFields');
        if (dynamicFields) {
          dynamicFields.innerHTML = '';
        }
        
        // Reset validation icons cho tất cả cases
         hideOrderValidation();
         hideBuyOrderValidation();
         hideSaleOrderValidation();
         hideBuyOrderMainValidation();
         hideExportOrderValidation();
         hideExportSlipValidation();
         hideExportQuantityValidation();
         hideImportOrderValidation();
         hideImportSlipValidation();
         hideImportQuantityValidation();
         hideProductValidation();
         hideUnitValidation();
         hideAdjustImportOrderValidation();
         hideAdjustImportSlipValidation();
         hideAdjustImportQuantityValidation();
         hideAdjustExportOrderValidation();
         hideAdjustExportSlipValidation();
         hideAdjustExportQuantityValidation();
        
        // Reset validation data
         window.lastOrderValidation = null;
         window.lastBuyOrderValidation = null;
         window.lastSaleOrderValidation = null;
         window.lastBuyOrderMainValidation = null;
         window.lastExportTransactionData = null;
         window.lastTransactionData = null;
         window.lastUnitConversionData = null;
         window.lastAdjustImportData = null;
         window.lastAdjustExportData = null;
        
        // Reset warning messages
         const stockWarning = document.getElementById('stockWarning');
         if (stockWarning) {
           stockWarning.classList.add('hidden');
         }
         
         const exportStockWarning = document.getElementById('exportStockWarning');
         if (exportStockWarning) {
           exportStockWarning.classList.add('hidden');
         }
         
         const unitConversionWarning = document.getElementById('unitConversionWarning');
         if (unitConversionWarning) {
           unitConversionWarning.classList.add('hidden');
         }
         
         const adjustImportWarning = document.getElementById('adjustImportWarning');
         if (adjustImportWarning) {
           adjustImportWarning.classList.add('hidden');
         }
         
         const adjustExportWarning = document.getElementById('adjustExportWarning');
         if (adjustExportWarning) {
           adjustExportWarning.classList.add('hidden');
         }
        
        // Reset submit button state
        checkSubmitButtonState();
      }

      document
        .getElementById("ticketDepartment")
        .addEventListener("change", (e) => {
          onDepartmentChange(e.target.value);
        });

      // Event listener cho textarea mô tả và category để enable/disable nút tạo ticket
      document.addEventListener("DOMContentLoaded", () => {
        const ticketDescription = document.getElementById("ticketDescription");
        const ticketCategory = document.getElementById("ticketCategory");
        const submitTicketBtn = document.getElementById("submitTicket");
        
        if (ticketDescription && submitTicketBtn) {
          ticketDescription.addEventListener("input", () => {
            checkSubmitButtonState();
          });
        }
        
        if (ticketCategory && submitTicketBtn) {
          ticketCategory.addEventListener("change", () => {
            // Reset trạng thái khi thay đổi category
            const stockWarning = document.getElementById("stockWarning");
            if (stockWarning) {
              stockWarning.classList.add("hidden");
            }
            
            checkSubmitButtonState();
          });
        }
      });
      
      // Helper functions cho validation real-time SOD
       async function validateOrderCodeRealtime(orderCode) {
         showOrderValidationLoading();
         
         try {
           const result = await checkSaleOrderDetail(orderCode);
           
           if (result) {
             showOrderValidationSuccess(`Tìm thấy: ${result.crdfd_name}`);
             // Lưu kết quả để sử dụng khi tạo ticket
             window.lastOrderValidation = result;
           } else {
             showOrderValidationError(`Không tìm thấy mã đơn hàng: ${orderCode}`);
             window.lastOrderValidation = null;
           }
         } catch (error) {
           showOrderValidationError('Lỗi khi kiểm tra mã đơn hàng');
           window.lastOrderValidation = null;
         }
       }
       
       // Helper functions cho validation real-time BOD
       async function validateBuyOrderCodeRealtime(orderCode) {
         showBuyOrderValidationLoading();
         
         try {
           const result = await checkBuyOrderDetail(orderCode);
           
           if (result) {
             showBuyOrderValidationSuccess(`Tìm thấy: ${result.crdfd_name}`);
             // Lưu kết quả để sử dụng khi tạo ticket
             window.lastBuyOrderValidation = result;
           } else {
             showBuyOrderValidationError(`Không tìm thấy mã đơn hàng: ${orderCode}`);
             window.lastBuyOrderValidation = null;
           }
         } catch (error) {
           showBuyOrderValidationError('Lỗi khi kiểm tra mã đơn hàng');
           window.lastBuyOrderValidation = null;
         }
       }
       
       // Helper functions cho validation real-time SO
       async function validateSaleOrderRealtime(orderCode) {
         showSaleOrderValidationLoading();
         
         try {
           const result = await checkSaleOrder(orderCode);
           
           if (result) {
             showSaleOrderValidationSuccess(`Tìm thấy: ${result.crdfd_name}`);
             // Lưu kết quả để sử dụng khi tạo ticket
             window.lastSaleOrderValidation = result;
           } else {
             showSaleOrderValidationError(`Không tìm thấy mã đơn hàng: ${orderCode}`);
             window.lastSaleOrderValidation = null;
           }
         } catch (error) {
           showSaleOrderValidationError('Lỗi khi kiểm tra mã đơn hàng');
           window.lastSaleOrderValidation = null;
         }
       }
       
       // Helper functions cho validation real-time BO
       async function validateBuyOrderRealtime(orderCode) {
         showBuyOrderMainValidationLoading();
         
         try {
           const result = await checkBuyOrder(orderCode);
           
           if (result) {
             showBuyOrderMainValidationSuccess(`Tìm thấy: ${result.crdfd_name}`);
             // Lưu kết quả để sử dụng khi tạo ticket
             window.lastBuyOrderMainValidation = result;
           } else {
             showBuyOrderMainValidationError(`Không tìm thấy mã đơn hàng: ${orderCode}`);
             window.lastBuyOrderMainValidation = null;
           }
         } catch (error) {
           showBuyOrderMainValidationError('Lỗi khi kiểm tra mã đơn hàng');
           window.lastBuyOrderMainValidation = null;
         }
       }
       
       function showOrderValidationLoading() {
         const status = document.getElementById('orderValidationStatus');
         const loading = document.getElementById('orderLoadingIcon');
         const valid = document.getElementById('orderValidIcon');
         const invalid = document.getElementById('orderInvalidIcon');
         const message = document.getElementById('orderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showOrderValidationSuccess(msg) {
         const status = document.getElementById('orderValidationStatus');
         const loading = document.getElementById('orderLoadingIcon');
         const valid = document.getElementById('orderValidIcon');
         const invalid = document.getElementById('orderInvalidIcon');
         const message = document.getElementById('orderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden'); // Ẩn message khi tìm thấy
         }
       }
       
       function showOrderValidationError(msg) {
         const status = document.getElementById('orderValidationStatus');
         const loading = document.getElementById('orderLoadingIcon');
         const valid = document.getElementById('orderValidIcon');
         const invalid = document.getElementById('orderInvalidIcon');
         const message = document.getElementById('orderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
           message.classList.remove('hidden');
           message.className = 'text-xs mt-1 text-red-600';
           message.textContent = msg;
         }
       }
       
       function hideOrderValidation() {
         const status = document.getElementById('orderValidationStatus');
         const message = document.getElementById('orderValidationMessage');
         
         if (status && message) {
           status.classList.add('hidden');
           message.classList.add('hidden');
         }
         
         window.lastOrderValidation = null;
       }
       
       // BOD Validation UI Functions
       function showBuyOrderValidationLoading() {
         const status = document.getElementById('buyOrderValidationStatus');
         const loading = document.getElementById('buyOrderLoadingIcon');
         const valid = document.getElementById('buyOrderValidIcon');
         const invalid = document.getElementById('buyOrderInvalidIcon');
         const message = document.getElementById('buyOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showBuyOrderValidationSuccess(msg) {
         const status = document.getElementById('buyOrderValidationStatus');
         const loading = document.getElementById('buyOrderLoadingIcon');
         const valid = document.getElementById('buyOrderValidIcon');
         const invalid = document.getElementById('buyOrderInvalidIcon');
         const message = document.getElementById('buyOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden'); // Ẩn message khi tìm thấy
         }
       }
       
       function showBuyOrderValidationError(msg) {
         const status = document.getElementById('buyOrderValidationStatus');
         const loading = document.getElementById('buyOrderLoadingIcon');
         const valid = document.getElementById('buyOrderValidIcon');
         const invalid = document.getElementById('buyOrderInvalidIcon');
         const message = document.getElementById('buyOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
           message.classList.remove('hidden');
           message.className = 'text-xs mt-1 text-red-600';
           message.textContent = msg;
         }
       }
       
       function hideBuyOrderValidation() {
         const status = document.getElementById('buyOrderValidationStatus');
         const message = document.getElementById('buyOrderValidationMessage');
         
         if (status && message) {
           status.classList.add('hidden');
           message.classList.add('hidden');
         }
         
         window.lastBuyOrderValidation = null;
       }
       
       // Sale Order Validation UI Functions
       function showSaleOrderValidationLoading() {
         const status = document.getElementById('saleOrderValidationStatus');
         const loading = document.getElementById('saleOrderLoadingIcon');
         const valid = document.getElementById('saleOrderValidIcon');
         const invalid = document.getElementById('saleOrderInvalidIcon');
         const message = document.getElementById('saleOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showSaleOrderValidationSuccess(msg) {
         const status = document.getElementById('saleOrderValidationStatus');
         const loading = document.getElementById('saleOrderLoadingIcon');
         const valid = document.getElementById('saleOrderValidIcon');
         const invalid = document.getElementById('saleOrderInvalidIcon');
         const message = document.getElementById('saleOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showSaleOrderValidationError(msg) {
         const status = document.getElementById('saleOrderValidationStatus');
         const loading = document.getElementById('saleOrderLoadingIcon');
         const valid = document.getElementById('saleOrderValidIcon');
         const invalid = document.getElementById('saleOrderInvalidIcon');
         const message = document.getElementById('saleOrderValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
           message.classList.remove('hidden');
           message.className = 'text-xs mt-1 text-red-600';
           message.textContent = msg;
         }
       }
       
       function hideSaleOrderValidation() {
         const status = document.getElementById('saleOrderValidationStatus');
         const message = document.getElementById('saleOrderValidationMessage');
         
         if (status && message) {
           status.classList.add('hidden');
           message.classList.add('hidden');
         }
         
         window.lastSaleOrderValidation = null;
       }
       
       // Buy Order Main Validation UI Functions
       function showBuyOrderMainValidationLoading() {
         const status = document.getElementById('buyOrderMainValidationStatus');
         const loading = document.getElementById('buyOrderMainLoadingIcon');
         const valid = document.getElementById('buyOrderMainValidIcon');
         const invalid = document.getElementById('buyOrderMainInvalidIcon');
         const message = document.getElementById('buyOrderMainValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showBuyOrderMainValidationSuccess(msg) {
         const status = document.getElementById('buyOrderMainValidationStatus');
         const loading = document.getElementById('buyOrderMainLoadingIcon');
         const valid = document.getElementById('buyOrderMainValidIcon');
         const invalid = document.getElementById('buyOrderMainInvalidIcon');
         const message = document.getElementById('buyOrderMainValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
           message.classList.add('hidden');
         }
       }
       
       function showBuyOrderMainValidationError(msg) {
         const status = document.getElementById('buyOrderMainValidationStatus');
         const loading = document.getElementById('buyOrderMainLoadingIcon');
         const valid = document.getElementById('buyOrderMainValidIcon');
         const invalid = document.getElementById('buyOrderMainInvalidIcon');
         const message = document.getElementById('buyOrderMainValidationMessage');
         
         if (status && loading && valid && invalid && message) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
           message.classList.remove('hidden');
           message.className = 'text-xs mt-1 text-red-600';
           message.textContent = msg;
         }
       }
       
       function hideBuyOrderMainValidation() {
         const status = document.getElementById('buyOrderMainValidationStatus');
         const message = document.getElementById('buyOrderMainValidationMessage');
         
         if (status && message) {
           status.classList.add('hidden');
           message.classList.add('hidden');
         }
         
         window.lastBuyOrderMainValidation = null;
       }
       
       // Export Order Validation UI Functions
       function showExportOrderValidationLoading() {
         const status = document.getElementById('exportOrderValidationStatus');
         const loading = document.getElementById('exportOrderLoadingIcon');
         const valid = document.getElementById('exportOrderValidIcon');
         const invalid = document.getElementById('exportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportOrderValidationSuccess() {
         const status = document.getElementById('exportOrderValidationStatus');
         const loading = document.getElementById('exportOrderLoadingIcon');
         const valid = document.getElementById('exportOrderValidIcon');
         const invalid = document.getElementById('exportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportOrderValidationError() {
         const status = document.getElementById('exportOrderValidationStatus');
         const loading = document.getElementById('exportOrderLoadingIcon');
         const valid = document.getElementById('exportOrderValidIcon');
         const invalid = document.getElementById('exportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideExportOrderValidation() {
         const status = document.getElementById('exportOrderValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Export Slip Validation UI Functions
       function showExportSlipValidationLoading() {
         const status = document.getElementById('exportSlipValidationStatus');
         const loading = document.getElementById('exportSlipLoadingIcon');
         const valid = document.getElementById('exportSlipValidIcon');
         const invalid = document.getElementById('exportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportSlipValidationSuccess() {
         const status = document.getElementById('exportSlipValidationStatus');
         const loading = document.getElementById('exportSlipLoadingIcon');
         const valid = document.getElementById('exportSlipValidIcon');
         const invalid = document.getElementById('exportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportSlipValidationError() {
         const status = document.getElementById('exportSlipValidationStatus');
         const loading = document.getElementById('exportSlipLoadingIcon');
         const valid = document.getElementById('exportSlipValidIcon');
         const invalid = document.getElementById('exportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideExportSlipValidation() {
         const status = document.getElementById('exportSlipValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Export Quantity Validation UI Functions
       function showExportQuantityValidationLoading() {
         const status = document.getElementById('exportQuantityValidationStatus');
         const loading = document.getElementById('exportQuantityLoadingIcon');
         const valid = document.getElementById('exportQuantityValidIcon');
         const invalid = document.getElementById('exportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportQuantityValidationSuccess() {
         const status = document.getElementById('exportQuantityValidationStatus');
         const loading = document.getElementById('exportQuantityLoadingIcon');
         const valid = document.getElementById('exportQuantityValidIcon');
         const invalid = document.getElementById('exportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showExportQuantityValidationError() {
         const status = document.getElementById('exportQuantityValidationStatus');
         const loading = document.getElementById('exportQuantityLoadingIcon');
         const valid = document.getElementById('exportQuantityValidIcon');
         const invalid = document.getElementById('exportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideExportQuantityValidation() {
         const status = document.getElementById('exportQuantityValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Import Order Validation UI Functions
       function showImportOrderValidationLoading() {
         const status = document.getElementById('importOrderValidationStatus');
         const loading = document.getElementById('importOrderLoadingIcon');
         const valid = document.getElementById('importOrderValidIcon');
         const invalid = document.getElementById('importOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportOrderValidationSuccess() {
         const status = document.getElementById('importOrderValidationStatus');
         const loading = document.getElementById('importOrderLoadingIcon');
         const valid = document.getElementById('importOrderValidIcon');
         const invalid = document.getElementById('importOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportOrderValidationError() {
         const status = document.getElementById('importOrderValidationStatus');
         const loading = document.getElementById('importOrderLoadingIcon');
         const valid = document.getElementById('importOrderValidIcon');
         const invalid = document.getElementById('importOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideImportOrderValidation() {
         const status = document.getElementById('importOrderValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Import Slip Validation UI Functions
       function showImportSlipValidationLoading() {
         const status = document.getElementById('importSlipValidationStatus');
         const loading = document.getElementById('importSlipLoadingIcon');
         const valid = document.getElementById('importSlipValidIcon');
         const invalid = document.getElementById('importSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportSlipValidationSuccess() {
         const status = document.getElementById('importSlipValidationStatus');
         const loading = document.getElementById('importSlipLoadingIcon');
         const valid = document.getElementById('importSlipValidIcon');
         const invalid = document.getElementById('importSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportSlipValidationError() {
         const status = document.getElementById('importSlipValidationStatus');
         const loading = document.getElementById('importSlipLoadingIcon');
         const valid = document.getElementById('importSlipValidIcon');
         const invalid = document.getElementById('importSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideImportSlipValidation() {
         const status = document.getElementById('importSlipValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Import Quantity Validation UI Functions
       function showImportQuantityValidationLoading() {
         const status = document.getElementById('importQuantityValidationStatus');
         const loading = document.getElementById('importQuantityLoadingIcon');
         const valid = document.getElementById('importQuantityValidIcon');
         const invalid = document.getElementById('importQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportQuantityValidationSuccess() {
         const status = document.getElementById('importQuantityValidationStatus');
         const loading = document.getElementById('importQuantityLoadingIcon');
         const valid = document.getElementById('importQuantityValidIcon');
         const invalid = document.getElementById('importQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showImportQuantityValidationError() {
         const status = document.getElementById('importQuantityValidationStatus');
         const loading = document.getElementById('importQuantityLoadingIcon');
         const valid = document.getElementById('importQuantityValidIcon');
         const invalid = document.getElementById('importQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideImportQuantityValidation() {
         const status = document.getElementById('importQuantityValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Product Validation UI Functions
       function showProductValidationLoading() {
         const status = document.getElementById('productValidationStatus');
         const loading = document.getElementById('productLoadingIcon');
         const valid = document.getElementById('productValidIcon');
         const invalid = document.getElementById('productInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showProductValidationSuccess() {
         const status = document.getElementById('productValidationStatus');
         const loading = document.getElementById('productLoadingIcon');
         const valid = document.getElementById('productValidIcon');
         const invalid = document.getElementById('productInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showProductValidationError() {
         const status = document.getElementById('productValidationStatus');
         const loading = document.getElementById('productLoadingIcon');
         const valid = document.getElementById('productValidIcon');
         const invalid = document.getElementById('productInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideProductValidation() {
         const status = document.getElementById('productValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Unit Validation UI Functions
       function showUnitValidationLoading() {
         const status = document.getElementById('unitValidationStatus');
         const loading = document.getElementById('unitLoadingIcon');
         const valid = document.getElementById('unitValidIcon');
         const invalid = document.getElementById('unitInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showUnitValidationSuccess() {
         const status = document.getElementById('unitValidationStatus');
         const loading = document.getElementById('unitLoadingIcon');
         const valid = document.getElementById('unitValidIcon');
         const invalid = document.getElementById('unitInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showUnitValidationError() {
         const status = document.getElementById('unitValidationStatus');
         const loading = document.getElementById('unitLoadingIcon');
         const valid = document.getElementById('unitValidIcon');
         const invalid = document.getElementById('unitInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideUnitValidation() {
         const status = document.getElementById('unitValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Import Order Validation UI Functions
       function showAdjustImportOrderValidationLoading() {
         const status = document.getElementById('adjustImportOrderValidationStatus');
         const loading = document.getElementById('adjustImportOrderLoadingIcon');
         const valid = document.getElementById('adjustImportOrderValidIcon');
         const invalid = document.getElementById('adjustImportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportOrderValidationSuccess() {
         const status = document.getElementById('adjustImportOrderValidationStatus');
         const loading = document.getElementById('adjustImportOrderLoadingIcon');
         const valid = document.getElementById('adjustImportOrderValidIcon');
         const invalid = document.getElementById('adjustImportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportOrderValidationError() {
         const status = document.getElementById('adjustImportOrderValidationStatus');
         const loading = document.getElementById('adjustImportOrderLoadingIcon');
         const valid = document.getElementById('adjustImportOrderValidIcon');
         const invalid = document.getElementById('adjustImportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustImportOrderValidation() {
         const status = document.getElementById('adjustImportOrderValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Import Slip Validation UI Functions
       function showAdjustImportSlipValidationLoading() {
         const status = document.getElementById('adjustImportSlipValidationStatus');
         const loading = document.getElementById('adjustImportSlipLoadingIcon');
         const valid = document.getElementById('adjustImportSlipValidIcon');
         const invalid = document.getElementById('adjustImportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportSlipValidationSuccess() {
         const status = document.getElementById('adjustImportSlipValidationStatus');
         const loading = document.getElementById('adjustImportSlipLoadingIcon');
         const valid = document.getElementById('adjustImportSlipValidIcon');
         const invalid = document.getElementById('adjustImportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportSlipValidationError() {
         const status = document.getElementById('adjustImportSlipValidationStatus');
         const loading = document.getElementById('adjustImportSlipLoadingIcon');
         const valid = document.getElementById('adjustImportSlipValidIcon');
         const invalid = document.getElementById('adjustImportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustImportSlipValidation() {
         const status = document.getElementById('adjustImportSlipValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Import Quantity Validation UI Functions
       function showAdjustImportQuantityValidationLoading() {
         const status = document.getElementById('adjustImportQuantityValidationStatus');
         const loading = document.getElementById('adjustImportQuantityLoadingIcon');
         const valid = document.getElementById('adjustImportQuantityValidIcon');
         const invalid = document.getElementById('adjustImportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportQuantityValidationSuccess() {
         const status = document.getElementById('adjustImportQuantityValidationStatus');
         const loading = document.getElementById('adjustImportQuantityLoadingIcon');
         const valid = document.getElementById('adjustImportQuantityValidIcon');
         const invalid = document.getElementById('adjustImportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustImportQuantityValidationError() {
         const status = document.getElementById('adjustImportQuantityValidationStatus');
         const loading = document.getElementById('adjustImportQuantityLoadingIcon');
         const valid = document.getElementById('adjustImportQuantityValidIcon');
         const invalid = document.getElementById('adjustImportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustImportQuantityValidation() {
         const status = document.getElementById('adjustImportQuantityValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Export Order Validation UI Functions
       function showAdjustExportOrderValidationLoading() {
         const status = document.getElementById('adjustExportOrderValidationStatus');
         const loading = document.getElementById('adjustExportOrderLoadingIcon');
         const valid = document.getElementById('adjustExportOrderValidIcon');
         const invalid = document.getElementById('adjustExportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportOrderValidationSuccess() {
         const status = document.getElementById('adjustExportOrderValidationStatus');
         const loading = document.getElementById('adjustExportOrderLoadingIcon');
         const valid = document.getElementById('adjustExportOrderValidIcon');
         const invalid = document.getElementById('adjustExportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportOrderValidationError() {
         const status = document.getElementById('adjustExportOrderValidationStatus');
         const loading = document.getElementById('adjustExportOrderLoadingIcon');
         const valid = document.getElementById('adjustExportOrderValidIcon');
         const invalid = document.getElementById('adjustExportOrderInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustExportOrderValidation() {
         const status = document.getElementById('adjustExportOrderValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Export Slip Validation UI Functions
       function showAdjustExportSlipValidationLoading() {
         const status = document.getElementById('adjustExportSlipValidationStatus');
         const loading = document.getElementById('adjustExportSlipLoadingIcon');
         const valid = document.getElementById('adjustExportSlipValidIcon');
         const invalid = document.getElementById('adjustExportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportSlipValidationSuccess() {
         const status = document.getElementById('adjustExportSlipValidationStatus');
         const loading = document.getElementById('adjustExportSlipLoadingIcon');
         const valid = document.getElementById('adjustExportSlipValidIcon');
         const invalid = document.getElementById('adjustExportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportSlipValidationError() {
         const status = document.getElementById('adjustExportSlipValidationStatus');
         const loading = document.getElementById('adjustExportSlipLoadingIcon');
         const valid = document.getElementById('adjustExportSlipValidIcon');
         const invalid = document.getElementById('adjustExportSlipInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustExportSlipValidation() {
         const status = document.getElementById('adjustExportSlipValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Adjust Export Quantity Validation UI Functions
       function showAdjustExportQuantityValidationLoading() {
         const status = document.getElementById('adjustExportQuantityValidationStatus');
         const loading = document.getElementById('adjustExportQuantityLoadingIcon');
         const valid = document.getElementById('adjustExportQuantityValidIcon');
         const invalid = document.getElementById('adjustExportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.remove('hidden');
           valid.classList.add('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportQuantityValidationSuccess() {
         const status = document.getElementById('adjustExportQuantityValidationStatus');
         const loading = document.getElementById('adjustExportQuantityLoadingIcon');
         const valid = document.getElementById('adjustExportQuantityValidIcon');
         const invalid = document.getElementById('adjustExportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.remove('hidden');
           invalid.classList.add('hidden');
         }
       }
       
       function showAdjustExportQuantityValidationError() {
         const status = document.getElementById('adjustExportQuantityValidationStatus');
         const loading = document.getElementById('adjustExportQuantityLoadingIcon');
         const valid = document.getElementById('adjustExportQuantityValidIcon');
         const invalid = document.getElementById('adjustExportQuantityInvalidIcon');
         
         if (status && loading && valid && invalid) {
           status.classList.remove('hidden');
           loading.classList.add('hidden');
           valid.classList.add('hidden');
           invalid.classList.remove('hidden');
         }
       }
       
       function hideAdjustExportQuantityValidation() {
         const status = document.getElementById('adjustExportQuantityValidationStatus');
         
         if (status) {
           status.classList.add('hidden');
         }
       }
       
       // Function kiểm tra sale order từ API
       async function checkSaleOrder(orderCode) {
         try {
           const cachedToken = await getToken();
           const query = `/crdfd_sale_orders?$select=crdfd_sale_orderid,crdfd_name&$filter=crdfd_name eq '${orderCode.trim()}' and statecode eq 0&$top=1`;
           
           const response = await fetch(`${DATAVERSE_URL}${query}`, {
             method: 'GET',
             headers: {
               'Authorization': `Bearer ${cachedToken}`,
               'Content-Type': 'application/json',
               'Accept': 'application/json'
             }
           });
           
           if (!response.ok) {
             console.error('❌ Lỗi API sale order:', response.status, response.statusText);
             return null;
           }
           
           const data = await response.json();
           console.log('📋 Sale order response:', data);
           
           if (data.value && data.value.length > 0) {
             return data.value[0]; // Trả về record đầu tiên
           }
           
           return null;
         } catch (error) {
           console.error('❌ Lỗi khi kiểm tra sale order:', error);
           return null;
         }
       }
       
       // Function kiểm tra buy order từ API
       async function checkBuyOrder(orderCode) {
         try {
           const cachedToken = await getToken();
           const query = `/crdfd_buyorderses?$select=crdfd_buyordersid,crdfd_name&$filter=crdfd_name eq '${orderCode.trim()}' and statecode eq 0&$top=1`;
           
           const response = await fetch(`${DATAVERSE_URL}${query}`, {
             method: 'GET',
             headers: {
               'Authorization': `Bearer ${cachedToken}`,
               'Content-Type': 'application/json',
               'Accept': 'application/json'
             }
           });
           
           if (!response.ok) {
             console.error('❌ Lỗi API buy order:', response.status, response.statusText);
             return null;
           }
           
           const data = await response.json();
           console.log('📋 Buy order response:', data);
           
           if (data.value && data.value.length > 0) {
             return data.value[0]; // Trả về record đầu tiên
           }
           
           return null;
         } catch (error) {
           console.error('❌ Lỗi khi kiểm tra buy order:', error);
           return null;
         }
       }
       
       // Function kiểm tra buy order detail từ API
       async function checkBuyOrderDetail(orderCode) {
         try {
           const cachedToken = await getToken();
           const query = `/crdfd_buyorderdetailses?$select=crdfd_buyorderdetailsid,crdfd_name,crdfd_giagoc&$filter=crdfd_name eq '${orderCode.trim()}' and statecode eq 0&$top=1`;
           
           const response = await fetch(`${DATAVERSE_URL}${query}`, {
             method: 'GET',
             headers: {
               'Authorization': `Bearer ${cachedToken}`,
               'Content-Type': 'application/json',
               'Accept': 'application/json'
             }
           });
           
           if (!response.ok) {
             console.error('❌ Lỗi API buy order detail:', response.status, response.statusText);
             return null;
           }
           
           const data = await response.json();
           console.log('📋 Buy order detail response:', data);
           
           if (data.value && data.value.length > 0) {
             return data.value[0]; // Trả về record đầu tiên
           }
           
           return null;
         } catch (error) {
           console.error('❌ Lỗi khi kiểm tra buy order detail:', error);
           return null;
         }
       }
       
       // Function kiểm tra sale order detail từ API
       async function checkSaleOrderDetail(orderCode) {
        try {
          const cachedToken = await getToken();
          const query = `/crdfd_saleorderdetails?$select=crdfd_saleorderdetailid,crdfd_name,crdfd_giagoc&$filter=crdfd_name eq '${orderCode.trim()}' and statecode eq 0&$top=1`;
          
          const response = await fetch(`${DATAVERSE_URL}${query}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${cachedToken}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API sale order detail:', response.status, response.statusText);
            return null;
          }
          
          const data = await response.json();
          console.log('📋 Sale order detail response:', data);
          
          if (data.value && data.value.length > 0) {
            return data.value[0]; // Trả về record đầu tiên
          }
          
          return null;
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra sale order detail:', error);
          return null;
        }
      }
      
      // Function kiểm tra adjust import transaction từ API
      async function checkAdjustImportTransaction(maDonHang, maPhieu) {
        try {
          const token = await getToken();
          const warning = document.getElementById('adjustImportWarning');
          const warningText = document.getElementById('adjustImportWarningText');
          
          if (!warning || !warningText) return;
          
          // Ẩn warning trước khi kiểm tra
          warning.classList.add('hidden');
          
          // Hiển thị loading cho cả hai field
          showAdjustImportOrderValidationLoading();
          showAdjustImportSlipValidationLoading();
          
          if (!maDonHang || !maPhieu) {
            // Hiển thị lỗi cho cả hai field
            showAdjustImportOrderValidationError();
            showAdjustImportSlipValidationError();
            warningText.textContent = 'Vui lòng nhập đầy đủ thông tin mã đơn hàng và mã phiếu.';
            warning.classList.remove('hidden');
            return;
          }
          
          // Escape ký tự đặc biệt
          const escapedMaPhieu = escapeODataString(maPhieu.trim());
          const escapedMaDonHang = escapeODataString(maDonHang.trim());
          
          // Query transaction buy để lấy thông tin (không có điều kiện số lượng)
          const transactionQuery = `/crdfd_transactionbuies?$filter=crdfd_maphieunhap eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and statecode eq 0&$select=crdfd_soluonganhantheokho,crdfd_transactionbuyid,createdon&$expand=crdfd_IDchitietonhang($select=crdfd_vitrikho,_crdfd_tensanpham_value)&$orderby=createdon desc&$top=1`;
          
          console.log('🔍 Query adjust import transaction:', transactionQuery);
          
          const response = await fetch(`${DATAVERSE_URL}${transactionQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API adjust import transaction:', response.status, response.statusText);
            // Hiển thị lỗi cho cả hai field
            showAdjustImportOrderValidationError();
            showAdjustImportSlipValidationError();
            warningText.textContent = `Lỗi API: ${response.statusText}`;
            warning.classList.remove('hidden');
            return;
          }
          
          const data = await response.json();
          console.log('📋 Adjust import transaction response:', data);
          
          if (!data.value || data.value.length === 0) {
            // Hiển thị lỗi cho cả hai field
            showAdjustImportOrderValidationError();
            showAdjustImportSlipValidationError();
            warningText.textContent = `Không tìm thấy phiếu nhập kho tương ứng với mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}`;
            warning.classList.remove('hidden');
            window.lastAdjustImportData = null;
            return;
          }
          
          const transactionInfo = data.value[0];
          
          // Hiển thị thành công cho cả hai field
          showAdjustImportOrderValidationSuccess();
          showAdjustImportSlipValidationSuccess();
          
          // Lưu thông tin transaction để sử dụng khi tạo ticket
          window.lastAdjustImportData = transactionInfo;
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra adjust import transaction:', error);
          // Hiển thị lỗi cho cả hai field
          showAdjustImportOrderValidationError();
          showAdjustImportSlipValidationError();
          
          const warning = document.getElementById('adjustImportWarning');
          const warningText = document.getElementById('adjustImportWarningText');
          
          if (warning && warningText) {
            warningText.textContent = `Lỗi khi kiểm tra: ${error.message}`;
            warning.classList.remove('hidden');
          }
        }
      }
      
      // Function kiểm tra adjust import quantity từ API
      async function checkAdjustImportQuantity(soLuongTheoKho) {
        try {
          if (!window.lastAdjustImportData) {
            console.log('❌ Không có dữ liệu transaction để kiểm tra');
            return;
          }
          
          const transactionInfo = window.lastAdjustImportData;
          const soLuongNhanHienTai = transactionInfo.crdfd_soluonganhantheokho || 0;
          const soLuongTheoKhoNumber = parseFloat(soLuongTheoKho);
          
          if (isNaN(soLuongTheoKhoNumber)) {
            showAdjustImportQuantityValidationError();
            return;
          }
          
          // Đảm bảo lastAdjustImportData được cập nhật từ checkAdjustImportTransactionForUnit
          if (window.lastAdjustImportData !== transactionInfo) {
            console.log('⚠️ Dữ liệu transaction đã thay đổi, cập nhật lại');
            window.lastAdjustImportData = transactionInfo;
          }
          
          // Tính chênh lệch: số user nhập - số từ API
          const chenhLech = soLuongTheoKhoNumber - soLuongNhanHienTai;
          
          console.log('📊 Tính toán chênh lệch:', {
            soLuongNhanHienTai,
            soLuongTheoKhoNumber,
            chenhLech
          });
          
          // Nếu chênh lệch > 0: tích xanh
          if (chenhLech > 0) {
            showAdjustImportQuantityValidationSuccess();
            const warning = document.getElementById('adjustImportWarning');
            if (warning) {
              warning.classList.add('hidden');
            }
            return;
          }
          
          // Nếu chênh lệch = 0: thông báo không thay đổi
          if (chenhLech === 0) {
            showAdjustImportQuantityValidationError();
            const warning = document.getElementById('adjustImportWarning');
            const warningText = document.getElementById('adjustImportWarningText');
            if (warning && warningText) {
              warningText.textContent = 'Giá trị điều chỉnh không thay đổi so với dữ liệu đang có.';
              warning.classList.remove('hidden');
            }
            return;
          }
          
          // Nếu chênh lệch < 0: kiểm tra tồn kho
          await checkInventoryForAdjustImport(Math.abs(chenhLech), transactionInfo);
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra adjust import quantity:', error);
          showAdjustImportQuantityValidationError();
        }
      }
      
      // Function kiểm tra tồn kho cho adjust import
      async function checkInventoryForAdjustImport(chenhLech, transactionInfo) {
        try {
          const token = await getToken();
          
          if (!transactionInfo.crdfd_IDchitietonhang) {
            console.log('❌ Không có thông tin chi tiết đơn hàng');
            showAdjustImportQuantityValidationError();
            return;
          }
          
          const viTriKho = transactionInfo.crdfd_IDchitietonhang.crdfd_vitrikho;
          const sanPhamId = transactionInfo.crdfd_IDchitietonhang._crdfd_tensanpham_value;
          
          if (!viTriKho || !sanPhamId) {
            console.log('❌ Thiếu thông tin vị trí kho hoặc sản phẩm');
            showAdjustImportQuantityValidationError();
            return;
          }
          
          // Query bảng kho để lấy tồn thực tế
          const inventoryQuery = `/crdfd_kho_binh_dinhs?$filter=crdfd_vitrikhofx eq '${escapeODataString(viTriKho)}' and _crdfd_tensanphamlookup_value eq '${sanPhamId}' and statecode eq 0&$select=crdfd_tonkhothucte&$top=1`;
          
          console.log('🔍 Query inventory:', inventoryQuery);
          
          const response = await fetch(`${DATAVERSE_URL}${inventoryQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API inventory:', response.status, response.statusText);
            showAdjustImportQuantityValidationError();
            return;
          }
          
          const data = await response.json();
          console.log('📋 Inventory response:', data);
          
          if (!data.value || data.value.length === 0) {
            showAdjustImportQuantityValidationError();
            const warning = document.getElementById('adjustImportWarning');
            const warningText = document.getElementById('adjustImportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không tìm thấy thông tin tồn kho cho sản phẩm tại vị trí: ${viTriKho}`;
              warning.classList.remove('hidden');
            }
            return;
          }
          
          const tonThucTe = data.value[0].crdfd_tonkhothucte || 0;
          const tonConLai = tonThucTe - chenhLech;
          
          console.log('📊 Kiểm tra tồn kho:', {
            tonThucTe,
            chenhLech,
            tonConLai
          });
          
          if (tonConLai < 0) {
            showAdjustImportQuantityValidationError();
            const warning = document.getElementById('adjustImportWarning');
            const warningText = document.getElementById('adjustImportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không thể điều chỉnh! Tồn kho hiện tại: ${tonThucTe}, sau khi điều chỉnh sẽ còn: ${tonConLai} (âm kho). Vui lòng kiểm tra lại.`;
              warning.classList.remove('hidden');
            }
          } else {
            showAdjustImportQuantityValidationSuccess();
            const warning = document.getElementById('adjustImportWarning');
            if (warning) {
              warning.classList.add('hidden');
            }
          }
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra inventory:', error);
          showAdjustImportQuantityValidationError();
        }
      }
      
      // Function kiểm tra import transaction để lấy thông tin đơn vị
      async function checkImportTransactionForUnit(maDonHang, maPhieu, quantityLabelId, orderValidationFunctions, slipValidationFunctions) {
        try {
          const token = await getToken();
          
          // Hiển thị loading cho cả hai field
          orderValidationFunctions.showLoading();
          slipValidationFunctions.showLoading();
          
          if (!maDonHang || !maPhieu) {
            // Hiển thị lỗi cho cả hai field
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            return;
          }
          
          const escapedMaPhieu = escapeODataString(maPhieu);
          const escapedMaDonHang = escapeODataString(maDonHang);
          
          // Query để lấy thông tin đơn vị từ transaction buy (phiếu nhập)
          const unitQuery = `/crdfd_transactionbuies?$filter=crdfd_maphieunhap eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and statecode eq 0&$select=crdfd_transactionbuyid,crdfd_onvitheokho,crdfd_onvionhang2&$top=1`;
          
          const response = await fetch(`${DATAVERSE_URL}${unitQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API get import unit info:', response.status, response.statusText);
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            
            // Hiển thị thông báo lỗi API cho import cases
            const adjustImportWarning = document.getElementById('adjustImportWarning');
            const adjustImportWarningText = document.getElementById('adjustImportWarningText');
            const stockWarning = document.getElementById('stockWarning');
            const stockWarningText = document.getElementById('stockWarningText');
            
            if (adjustImportWarning && adjustImportWarningText) {
              adjustImportWarningText.textContent = `Lỗi kết nối API khi kiểm tra thông tin phiếu nhập. Vui lòng thử lại sau.`;
              adjustImportWarning.classList.remove('hidden');
            } else if (stockWarning && stockWarningText) {
              stockWarningText.textContent = `Lỗi kết nối API khi kiểm tra thông tin phiếu nhập. Vui lòng thử lại sau.`;
              stockWarning.classList.remove('hidden');
            }
            return;
          }
          
          const data = await response.json();
          console.log('📋 Import unit info response:', data);
          
          if (!data.value || data.value.length === 0) {
            console.log('❌ Không tìm thấy import transaction');
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            
            // Hiển thị thông báo lỗi chi tiết cho import cases
            const adjustImportWarning = document.getElementById('adjustImportWarning');
            const adjustImportWarningText = document.getElementById('adjustImportWarningText');
            const stockWarning = document.getElementById('stockWarning');
            const stockWarningText = document.getElementById('stockWarningText');
            
            if (adjustImportWarning && adjustImportWarningText) {
              adjustImportWarningText.textContent = `Không tìm thấy phiếu nhập kho với mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}. Vui lòng kiểm tra lại thông tin.`;
              adjustImportWarning.classList.remove('hidden');
            } else if (stockWarning && stockWarningText) {
              stockWarningText.textContent = `Không tìm thấy phiếu nhập kho với mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}. Vui lòng kiểm tra lại thông tin.`;
              stockWarning.classList.remove('hidden');
            }
            return;
          }
          
          const transactionInfo = data.value[0];
          
          // Lấy thông tin đơn vị từ API response
          let warehouseUnit = '';
          let orderUnit = '';
          if (transactionInfo.crdfd_onvitheokho) {
            warehouseUnit = transactionInfo.crdfd_onvitheokho;
          }
          if (transactionInfo.crdfd_onvionhang2) {
            orderUnit = transactionInfo.crdfd_onvionhang2;
          }
          
          // Cập nhật label của trường số lượng với đơn vị
          const quantityLabel = document.getElementById(quantityLabelId);
          if (quantityLabelId === 'cancelImportQuantityLabel') {
            // Case hủy phiếu nhập - chỉ hiển thị đơn vị theo kho
            if (quantityLabel && warehouseUnit) {
              const currentText = quantityLabel.textContent;
              if (!currentText.includes('(') && !currentText.includes(')')) {
                quantityLabel.textContent = `Số lượng (${warehouseUnit}) *`;
              }
            }
          } else if (quantityLabelId === 'adjustImportQuantityLabel') {
            // Case điều chỉnh phiếu nhập - hiển thị cả hai đơn vị
            if (quantityLabel && warehouseUnit) {
              const currentText = quantityLabel.textContent;
              if (!currentText.includes('(') && !currentText.includes(')')) {
                quantityLabel.textContent = `Số lượng theo kho (${warehouseUnit}) *`;
              }
            }
            
            // Cập nhật label cho số lượng theo đơn
            const orderQuantityLabel = document.getElementById('adjustImportOrderQuantityLabel');
            if (orderQuantityLabel && orderUnit) {
              const currentOrderText = orderQuantityLabel.textContent;
              if (!currentOrderText.includes('(') && !currentOrderText.includes(')')) {
                orderQuantityLabel.textContent = `Số lượng theo đơn (${orderUnit})`;
              }
            }
            
            // Lưu thông tin transaction để sử dụng khi kiểm tra số lượng
            if (transactionInfo) {
              console.log('✅ Cập nhật lastAdjustImportData từ checkImportTransactionForUnit');
              window.lastAdjustImportData = transactionInfo;
            }
          }
          
          // Hiển thị thành công cho cả hai field
          orderValidationFunctions.showSuccess();
          slipValidationFunctions.showSuccess();
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra import transaction:', error);
          orderValidationFunctions.showError();
          slipValidationFunctions.showError();
          
          // Hiển thị thông báo lỗi JavaScript cho import cases
          const adjustImportWarning = document.getElementById('adjustImportWarning');
          const adjustImportWarningText = document.getElementById('adjustImportWarningText');
          const stockWarning = document.getElementById('stockWarning');
          const stockWarningText = document.getElementById('stockWarningText');
          
          if (adjustImportWarning && adjustImportWarningText) {
            adjustImportWarningText.textContent = `Có lỗi xảy ra khi kiểm tra thông tin phiếu nhập. Vui lòng thử lại.`;
            adjustImportWarning.classList.remove('hidden');
          } else if (stockWarning && stockWarningText) {
            stockWarningText.textContent = `Có lỗi xảy ra khi kiểm tra thông tin phiếu nhập. Vui lòng thử lại.`;
            stockWarning.classList.remove('hidden');
          }
        }
      }

      // Function wrapper cho cancel import
      async function checkCancelImportTransaction(maDonHang, maPhieu) {
        await checkImportTransactionForUnit(maDonHang, maPhieu, 'cancelImportQuantityLabel', {
          showLoading: showImportOrderValidationLoading,
          showError: showImportOrderValidationError,
          showSuccess: showImportOrderValidationSuccess
        }, {
          showLoading: showImportSlipValidationLoading,
          showError: showImportSlipValidationError,
          showSuccess: showImportSlipValidationSuccess
        });
      }

      // Function wrapper cho adjust import
      async function checkAdjustImportTransactionForUnit(maDonHang, maPhieu) {
        // Gọi hàm chung để hiển thị đơn vị
        await checkImportTransactionForUnit(maDonHang, maPhieu, 'adjustImportQuantityLabel', {
          showLoading: showAdjustImportOrderValidationLoading,
          showError: showAdjustImportOrderValidationError,
          showSuccess: showAdjustImportOrderValidationSuccess
        }, {
          showLoading: showAdjustImportSlipValidationLoading,
          showError: showAdjustImportSlipValidationError,
          showSuccess: showAdjustImportSlipValidationSuccess
        });
        
        // Đảm bảo lastAdjustImportData được cập nhật đầy đủ thông tin
        if (window.lastAdjustImportData) {
          try {
            const token = await getToken();
            const escapedMaPhieu = escapeODataString(maPhieu.trim());
            const escapedMaDonHang = escapeODataString(maDonHang.trim());
            
            // Query để lấy thêm thông tin cần thiết cho kiểm tra số lượng
            const transactionQuery = `/crdfd_transactionbuies?$filter=crdfd_maphieunhap eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and statecode eq 0&$select=crdfd_soluonganhantheokho,crdfd_transactionbuyid&$expand=crdfd_IDchitietonhang($select=crdfd_vitrikho,_crdfd_tensanpham_value)&$top=1`;
            
            const response = await fetch(`${DATAVERSE_URL}${transactionQuery}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              if (data.value && data.value.length > 0) {
                // Cập nhật thông tin bổ sung vào lastAdjustImportData
                window.lastAdjustImportData = {
                  ...window.lastAdjustImportData,
                  ...data.value[0]
                };
                console.log('✅ Đã cập nhật đầy đủ thông tin cho lastAdjustImportData:', window.lastAdjustImportData);
              }
            }
          } catch (error) {
            console.error('❌ Lỗi khi cập nhật thông tin bổ sung cho lastAdjustImportData:', error);
          }
        }
      }
      
      // Function kiểm tra export transaction từ API - chỉ lấy thông tin đơn vị (dùng chung cho cả adjust và cancel)
      async function checkExportTransactionForUnit(maDonHang, maPhieu, quantityLabelId, orderValidationFunctions, slipValidationFunctions) {
        try {
          const token = await getToken();
          
          // Hiển thị loading cho cả hai field
          orderValidationFunctions.showLoading();
          slipValidationFunctions.showLoading();
          
          if (!maDonHang || !maPhieu) {
            // Hiển thị lỗi cho cả hai field
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            return;
          }
          
          const escapedMaPhieu = escapeODataString(maPhieu);
          const escapedMaDonHang = escapeODataString(maDonHang);
          
          // Query chỉ để lấy thông tin đơn vị từ bất kỳ record nào của đơn hàng và phiếu xuất
          const unitQuery = `/crdfd_transactionsaleses?$filter=crdfd_maphieuxuat eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and statecode eq 0&$select=crdfd_transactionsalesid,crdfd_onvitheokho,crdfd_onvionhang&$top=1`;
          
          const response = await fetch(`${DATAVERSE_URL}${unitQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API get unit info:', response.status, response.statusText);
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            
            // Hiển thị thông báo lỗi API
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Lỗi kết nối API khi kiểm tra thông tin phiếu xuất. Vui lòng thử lại sau.`;
              warning.classList.remove('hidden');
            }
            return;
          }
          
          const data = await response.json();
          console.log('📋 Export unit info response:', data);
          
          if (!data.value || data.value.length === 0) {
            console.log('❌ Không tìm thấy transaction');
            orderValidationFunctions.showError();
            slipValidationFunctions.showError();
            
            // Hiển thị thông báo lỗi chi tiết
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không tìm thấy phiếu xuất kho với mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}. Vui lòng kiểm tra lại thông tin.`;
              warning.classList.remove('hidden');
            }
            return;
          }
          
          const transactionInfo = data.value[0];
          
          // Lấy thông tin đơn vị từ API response
          let warehouseUnit = '';
          let orderUnit = '';
          if (transactionInfo.crdfd_onvitheokho) {
            warehouseUnit = transactionInfo.crdfd_onvitheokho;
          }
          if (transactionInfo.crdfd_onvionhang) {
            orderUnit = transactionInfo.crdfd_onvionhang;
          }
          
          // Cập nhật label của trường số lượng với đơn vị
          const quantityLabel = document.getElementById(quantityLabelId);
          if (quantityLabelId === 'cancelExportQuantityLabel') {
            // Case hủy phiếu xuất - chỉ hiển thị đơn vị theo kho
            if (quantityLabel && warehouseUnit) {
              const currentText = quantityLabel.textContent;
              if (!currentText.includes('(') && !currentText.includes(')')) {
                quantityLabel.textContent = `Số lượng (${warehouseUnit}) *`;
              }
            }
          } else {
            // Case điều chỉnh phiếu xuất - hiển thị cả hai đơn vị
            if (quantityLabel && warehouseUnit) {
              const currentText = quantityLabel.textContent;
              if (!currentText.includes('(') && !currentText.includes(')')) {
                quantityLabel.textContent = `Số lượng theo kho (${warehouseUnit})`;
              }
            }
            
            // Tìm và cập nhật label số lượng theo đơn (sẽ tạo sau)
            const orderQuantityLabel = document.getElementById('adjustExportOrderQuantityLabel');
            if (orderQuantityLabel && orderUnit) {
              const currentOrderText = orderQuantityLabel.textContent;
              if (!currentOrderText.includes('(') && !currentOrderText.includes(')')) {
                orderQuantityLabel.textContent = `Số lượng theo đơn (${orderUnit})`;
              }
            }
          }
          
          // Hiển thị thành công cho cả hai field
          orderValidationFunctions.showSuccess();
          slipValidationFunctions.showSuccess();
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra export transaction:', error);
          orderValidationFunctions.showError();
          slipValidationFunctions.showError();
          
          // Hiển thị thông báo lỗi JavaScript
          const warning = document.getElementById('adjustExportWarning');
          const warningText = document.getElementById('adjustExportWarningText');
          if (warning && warningText) {
            warningText.textContent = `Có lỗi xảy ra khi kiểm tra thông tin phiếu xuất. Vui lòng thử lại.`;
            warning.classList.remove('hidden');
          }
        }
      }

      // Function wrapper cho cancel export
      async function checkCancelExportTransaction(maDonHang, maPhieu) {
        await checkExportTransactionForUnit(maDonHang, maPhieu, 'cancelExportQuantityLabel', {
          showLoading: showExportOrderValidationLoading,
          showError: showExportOrderValidationError,
          showSuccess: showExportOrderValidationSuccess
        }, {
          showLoading: showExportSlipValidationLoading,
          showError: showExportSlipValidationError,
          showSuccess: showExportSlipValidationSuccess
        });
      }

      // Function wrapper cho adjust export
      async function checkAdjustExportTransaction(maDonHang, maPhieu) {
        await checkExportTransactionForUnit(maDonHang, maPhieu, 'adjustExportQuantityLabel', {
          showLoading: showAdjustExportOrderValidationLoading,
          showError: showAdjustExportOrderValidationError,
          showSuccess: showAdjustExportOrderValidationSuccess
        }, {
          showLoading: showAdjustExportSlipValidationLoading,
          showError: showAdjustExportSlipValidationError,
          showSuccess: showAdjustExportSlipValidationSuccess
        });
      }
      
      // Function kiểm tra adjust export quantity từ API với đầy đủ 3 thông tin
      async function checkAdjustExportQuantity(soLuongTheoKho) {
        try {
          // Lấy thông tin từ các input fields
          const maDonHang = document.getElementById('maDonPhieuXuat')?.value?.trim();
          const maPhieu = document.getElementById('maPhieuXuat')?.value?.trim();
          
          if (!maDonHang || !maPhieu || !soLuongTheoKho) {
            console.log('❌ Thiếu thông tin để kiểm tra');
            showAdjustExportQuantityValidationError();
            return;
          }
          
          const soLuongTheoKhoNumber = parseFloat(soLuongTheoKho);
          if (isNaN(soLuongTheoKhoNumber)) {
            showAdjustExportQuantityValidationError();
            return;
          }
          
          // Call API với chỉ 2 thông tin (mã đơn hàng + mã phiếu) để tìm record
          const token = await getToken();
          const escapedMaPhieu = escapeODataString(maPhieu);
          const escapedMaDonHang = escapeODataString(maDonHang);
          
          const transactionQuery = `/crdfd_transactionsaleses?$filter=crdfd_maphieuxuat eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and statecode eq 0&$select=crdfd_soluonggiaotheokho,crdfd_transactionsalesid,createdon&$expand=crdfd_IDchitietonhang($select=crdfd_vitrikho,_crdfd_sanpham_value)&$orderby=createdon desc&$top=1`;
          
          const response = await fetch(`${DATAVERSE_URL}${transactionQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API validate quantity:', response.status, response.statusText);
            showAdjustExportQuantityValidationError();
            return;
          }
          
          const data = await response.json();
          console.log('📋 Quantity validation response:', data);
          
          if (!data.value || data.value.length === 0) {
            // Không tìm thấy record với mã đơn hàng và mã phiếu
            showAdjustExportQuantityValidationError();
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không tìm thấy phiếu xuất kho với mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}`;
              warning.classList.remove('hidden');
            }
            return;
          }
          
          // Tìm thấy record - tính toán chênh lệch và kiểm tra tồn kho
          const transactionInfo = data.value[0];
          const soLuongGiaoHienTai = transactionInfo.crdfd_soluonggiaotheokho || 0;
          
          // Tính chênh lệch: số user nhập - số từ API
          const chenhLech = soLuongTheoKhoNumber - soLuongGiaoHienTai;
          
          console.log('📊 Tính toán chênh lệch xuất:', {
            soLuongGiaoHienTai,
            soLuongTheoKhoNumber,
            chenhLech
          });
          
          // Nếu chênh lệch < 0: tích xanh (giảm xuất)
          if (chenhLech < 0) {
            showAdjustExportQuantityValidationSuccess();
            const warning = document.getElementById('adjustExportWarning');
            if (warning) {
              warning.classList.add('hidden');
            }
            // Lưu thông tin transaction để sử dụng khi tạo ticket
            window.lastAdjustExportData = transactionInfo;
            return;
          }
          
          // Nếu chênh lệch = 0: thông báo không thay đổi
          if (chenhLech === 0) {
            showAdjustExportQuantityValidationError();
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = 'Giá trị điều chỉnh không thay đổi so với dữ liệu đang có.';
              warning.classList.remove('hidden');
            }
            return;
          }
          
          // Nếu chênh lệch > 0: kiểm tra tồn kho (tăng xuất)
          await checkInventoryForAdjustExport(chenhLech, transactionInfo);
          
          // Lưu thông tin transaction để sử dụng khi tạo ticket
          window.lastAdjustExportData = transactionInfo;
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra adjust export quantity:', error);
          showAdjustExportQuantityValidationError();
        }
      }
      
      // Function kiểm tra tồn kho cho adjust export
      async function checkInventoryForAdjustExport(chenhLech, transactionInfo) {
        try {
          const token = await getToken();
          
          if (!transactionInfo.crdfd_IDchitietonhang) {
            console.log('❌ Không có thông tin chi tiết đơn hàng');
            showAdjustExportQuantityValidationError();
            return;
          }
          
          const viTriKho = transactionInfo.crdfd_IDchitietonhang.crdfd_vitrikho;
          const sanPhamId = transactionInfo.crdfd_IDchitietonhang._crdfd_sanpham_value;
          
          if (!viTriKho || !sanPhamId) {
            console.log('❌ Thiếu thông tin vị trí kho hoặc sản phẩm');
            showAdjustExportQuantityValidationError();
            return;
          }
          
          // Query bảng kho để lấy tồn thực tế
          const inventoryQuery = `/crdfd_kho_binh_dinhs?$filter=crdfd_vitrikhofx eq '${escapeODataString(viTriKho)}' and _crdfd_tensanphamlookup_value eq '${sanPhamId}' and statecode eq 0&$select=crdfd_tonkhothucte&$top=1`;
          
          console.log('🔍 Query inventory for export:', inventoryQuery);
          
          const response = await fetch(`${DATAVERSE_URL}${inventoryQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API inventory:', response.status, response.statusText);
            showAdjustExportQuantityValidationError();
            return;
          }
          
          const data = await response.json();
          console.log('📋 Inventory response for export:', data);
          
          if (!data.value || data.value.length === 0) {
            showAdjustExportQuantityValidationError();
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không tìm thấy thông tin tồn kho cho sản phẩm tại vị trí: ${viTriKho}`;
              warning.classList.remove('hidden');
            }
            return;
          }
          
          const tonThucTe = data.value[0].crdfd_tonkhothucte || 0;
          const tonConLai = tonThucTe - chenhLech;
          
          console.log('📊 Kiểm tra tồn kho xuất:', {
            tonThucTe,
            chenhLech,
            tonConLai
          });
          
          if (tonConLai < 0) {
            showAdjustExportQuantityValidationError();
            const warning = document.getElementById('adjustExportWarning');
            const warningText = document.getElementById('adjustExportWarningText');
            if (warning && warningText) {
              warningText.textContent = `Không thể điều chỉnh! Tồn kho hiện tại: ${tonThucTe}, sau khi điều chỉnh sẽ còn: ${tonConLai} (âm kho). Vui lòng nhập số lượng nhỏ hơn hoặc bằng ${tonThucTe + parseInt(transactionInfo.crdfd_soluonggiaotheokho)}.`;
              warning.classList.remove('hidden');
            }
          } else {
            showAdjustExportQuantityValidationSuccess();
            const warning = document.getElementById('adjustExportWarning');
            if (warning) {
              warning.classList.add('hidden');
            }
          }
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra inventory:', error);
          showAdjustExportQuantityValidationError();
        }
      }
      
      // Function kiểm tra unit conversion từ API
      async function checkUnitConversion(productCode, unitValue) {
        try {
          const token = await getToken();
          const warning = document.getElementById('unitConversionWarning');
          const warningText = document.getElementById('unitConversionWarningText');
          
          if (!warning || !warningText) return;
          
          // Ẩn warning trước khi kiểm tra
          warning.classList.add('hidden');
          
          // Hiển thị loading cho cả hai field
          showProductValidationLoading();
          showUnitValidationLoading();
          
          if (!productCode || !unitValue) {
            // Hiển thị lỗi cho cả hai field
            showProductValidationError();
            showUnitValidationError();
            warningText.textContent = 'Vui lòng nhập đầy đủ thông tin sản phẩm và đơn vị.';
            warning.classList.remove('hidden');
            return;
          }
          
          // Escape ký tự đặc biệt
          const escapedProductCode = escapeODataString(productCode.trim());
          const escapedUnitValue = escapeODataString(unitValue.trim());
          
          // Query bảng crdfd_unitconvertions
          const query = `/crdfd_unitconvertions?$filter=cr44a_tensanphamtext eq '${escapedProductCode}' and crdfd_onvichuyenoitransfome eq '${escapedUnitValue}' and statecode eq 0&$select=crdfd_unitconvertionid,crdfd_name,crdfd_giatrichuyenoi&$top=1`;
          
          console.log('🔍 Query unit conversion:', query);
          
          const response = await fetch(`${DATAVERSE_URL}${query}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            console.error('❌ Lỗi API unit conversion:', response.status, response.statusText);
            // Hiển thị lỗi cho cả hai field
            showProductValidationError();
            showUnitValidationError();
            warningText.textContent = `Lỗi API: ${response.statusText}`;
            warning.classList.remove('hidden');
            return;
          }
          
          const data = await response.json();
          console.log('📋 Unit conversion response:', data);
          
          if (!data.value || data.value.length === 0) {
            // Hiển thị lỗi cho cả hai field
            showProductValidationError();
            showUnitValidationError();
            warningText.textContent = `Không tìm thấy thông tin chuyển đổi đơn vị cho sản phẩm: ${productCode} với đơn vị: ${unitValue}`;
            warning.classList.remove('hidden');
            window.lastUnitConversionData = null;
            return;
          }
          
          const conversionInfo = data.value[0];
          
          // Hiển thị thành công cho cả hai field
          showProductValidationSuccess();
          showUnitValidationSuccess();
          
          // Lưu thông tin conversion để sử dụng khi tạo ticket
          window.lastUnitConversionData = conversionInfo;
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra unit conversion:', error);
          // Hiển thị lỗi cho cả hai field
          showProductValidationError();
          showUnitValidationError();
          
          const warning = document.getElementById('unitConversionWarning');
          const warningText = document.getElementById('unitConversionWarningText');
          
          if (warning && warningText) {
            warningText.textContent = `Lỗi khi kiểm tra: ${error.message}`;
            warning.classList.remove('hidden');
          }
        }
      }
      
      // Function kiểm tra trạng thái nút submit
      function checkSubmitButtonState() {
        const submitTicketBtn = document.getElementById("submitTicket");
        const ticketDescription = document.getElementById("ticketDescription");
        const ticketCategory = document.getElementById("ticketCategory");
        
        if (!submitTicketBtn || !ticketDescription) return;
        
        const hasDescription = ticketDescription.value.trim().length > 0;
        const selectedCategory = ticketCategory ? ticketCategory.value : null;
        
        // Kiểm tra nếu là case cần check tồn kho (283640004 hoặc 283640008)
        const needsImportStockCheck = selectedCategory === "283640004";
        const needsExportStockCheck = selectedCategory === "283640008";
        
        if (needsImportStockCheck) {
           // Case hủy phiếu nhập kho: chỉ enable khi có mô tả VÀ đã pass stock check
           const stockWarning = document.getElementById("stockWarning");
           const hasStockWarning = stockWarning && !stockWarning.classList.contains("hidden");
           const hasPassedStockCheck = hasStockWarning && stockWarning.classList.contains("text-green-600");
           const hasFailedStockCheck = hasStockWarning && stockWarning.classList.contains("text-red-600");
           
           if (hasDescription && hasPassedStockCheck) {
             enableSubmitButton();
           } else if (hasFailedStockCheck) {
             disableSubmitButton("Không thể tạo ticket vì tồn kho sẽ bị âm");
           } else {
             disableSubmitButton("Vui lòng nhập mô tả và kiểm tra tồn kho");
           }
        } else if (needsExportStockCheck) {
           // Case hủy phiếu xuất kho: chỉ cho phép tạo ticket khi tìm thấy dữ liệu và nhập đầy đủ thông tin
           const exportStockWarning = document.getElementById("exportStockWarning");
           // Kiểm tra trạng thái success dựa trên class, không phụ thuộc vào hidden state
           const hasPassedExportCheck = exportStockWarning && exportStockWarning.classList.contains("text-green-600");
           const hasFailedExportCheck = exportStockWarning && exportStockWarning.classList.contains("text-red-600");
           
           if (hasDescription && hasPassedExportCheck) {
             enableSubmitButton();
           } else if (hasFailedExportCheck) {
             disableSubmitButton("Không thể tạo ticket vì không tìm thấy phiếu xuất hợp lệ");
           } else {
             disableSubmitButton("Vui lòng nhập mô tả và kiểm tra thông tin phiếu xuất");
           }
         } else {
          // Case không cần check: chỉ cần có mô tả
          if (hasDescription) {
            enableSubmitButton();
          } else {
            disableSubmitButton("Vui lòng nhập mô tả chi tiết");
          }
        }
      }
      
      function enableSubmitButton() {
        const submitTicketBtn = document.getElementById("submitTicket");
        if (submitTicketBtn) {
          submitTicketBtn.disabled = false;
          submitTicketBtn.classList.remove("opacity-50", "cursor-not-allowed");
          submitTicketBtn.classList.add("hover:bg-blue-700");
          submitTicketBtn.title = "Tạo Ticket";
        }
      }
      
      function disableSubmitButton(reason) {
        const submitTicketBtn = document.getElementById("submitTicket");
        if (submitTicketBtn) {
          submitTicketBtn.disabled = true;
          submitTicketBtn.classList.add("opacity-50", "cursor-not-allowed");
          submitTicketBtn.classList.remove("hover:bg-blue-700");
          submitTicketBtn.title = reason;
        }
      }

      // ========== Function ================

      // Biến cache token
      let cachedToken = null;
      let tokenExpiry = null;

      async function getToken() {
        // Kiểm tra token còn hạn không (trừ đi 5 phút để đảm bảo an toàn)
        if (
          cachedToken &&
          tokenExpiry &&
          new Date().getTime() < tokenExpiry - 300000
        ) {
          return cachedToken;
        }

        const url =
          "https://de210e4bcd22e60591ca8e841aad4b.8e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d8ccba4cda644d79f66bfe164b2a0bf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Se56wn31gs_1-0gv4sPfYdy25OuhYBuVd4-xykYe8AM";

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key: "value" }),
          });

          if (!response.ok) {
            throw new Error("HTTP status " + response.status);
          }

          const data = await response.json();

          // Xử lý format response mới
          let accessToken;
          if (data.body && data.body.access_token) {
            // Format mới: { statusCode: "200", body: { access_token: "...", expires_in: 3599 } }
            accessToken = data.body.access_token;
            const expiresIn = data.body.expires_in || 3600; // mặc định 1 giờ
            tokenExpiry = new Date().getTime() + expiresIn * 1000;
          } else if (data.access_token) {
            // Format cũ: { access_token: "..." }
            accessToken = data.access_token;
            tokenExpiry = new Date().getTime() + 3600 * 1000; // mặc định 1 giờ
          } else {
            throw new Error("Không tìm thấy access_token trong response");
          }

          cachedToken = accessToken;
          return cachedToken;
        } catch (err) {
          console.error("Error getToken:", err);
          throw err;
        }
      }

      async function getData() {
        const cachedToken = await getToken();
        const [user, units] = await Promise.all([
          //getAllXseptions(token, XSEPTIONS_QUERY, mappingListTickets),
          getAllXseptions(cachedToken, USER_QUERY, mappingUser),
          getAllXseptions(cachedToken, Units_QUERY, mappingUnits),
        ]);
        return { user, units };
      }

      async function refreshData() {
        const cachedToken = await getToken();
        const email = getCurrentUserEmail();
        if (!email) {
          console.warn("❌ Chưa login, bỏ qua fetch data");
          return;
        }

        const query = buildXseptionsQuery(email);
        tickets = await getAllXseptions(cachedToken, query, mappingListTickets);

        // Reset bộ lọc và áp dụng lại
        applyFilters();
      }

      function getCurrentUserEmail() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        return currentUser ? currentUser.idU : null;
      }

      function getTicketsPerPage() {
        const width = window.innerWidth;

        if (width < 640) {
          return 5; // mobile
        } else if (width < 1024) {
          return 7; // tablet
        } else {
          return 10; // pc
        }
      }

      function buildXseptionsQuery(email) {
        if (email === "admin") {
          // 🔹 Admin → lấy tất cả record active
          return (
            "/crdfd_suport_systems" +
            "?$select=crdfd_suport_systemid,crdfd_name,crdfd_nguoiyeucau,crdfd_loaiieuchinh,crdfd_trangthai,crdfd_lydoieuchinh,createdon,cr1bb_giatriexuat,cr1bb_thongtinyeucau" +
            `&$expand=crdfd_support_system_approval_Masuport_crdfd_suport_system($select=crdfd_nguoixacnhan,cr1bb_trang_thai,cr1bb_ghichu)` +
            `&$filter=statecode eq 0`
          );
        }

        // 🔹 User thường → filter theo email
        return (
          "/crdfd_suport_systems" +
          "?$select=crdfd_suport_systemid,crdfd_name,crdfd_nguoiyeucau,crdfd_loaiieuchinh,crdfd_trangthai,crdfd_lydoieuchinh,createdon,cr1bb_giatriexuat,cr1bb_thongtinyeucau" +
          `&$expand=crdfd_support_system_approval_Masuport_crdfd_suport_system($select=crdfd_nguoixacnhan,cr1bb_trang_thai,cr1bb_ghichu)` +
          `&$filter=statecode eq 0 and (contains(crdfd_nguoiduyet,'${email}') or crdfd_nguoiyeucau eq '${email}')`
        );
      }

      async function init() {
        try {
          //console.log("Done, tổng số record:", data.length);
          tickets = [...supportSystemsData];
          filteredTickets = [...tickets]; // Khởi tạo danh sách đã lọc
          initializeNavigation();
          initializeFormHandlers();
          initializeModals();
          initializeSearchAndFilter(); // Khởi tạo tìm kiếm và lọc

          loadTickets();
          loadApprovals();
          loadDashboard();

          initApproverChoices();
          loadDepartments();
          
          // Tự động làm mới dữ liệu mỗi 30 giây
          startAutoRefresh();
        } catch (err) {
          console.error("Error init:", err);
        }
      }

      // Biến lưu trữ interval ID để có thể dừng auto refresh
      let autoRefreshInterval = null;

      // Function tự động làm mới dữ liệu
      function startAutoRefresh() {
        // Dừng interval cũ nếu có
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }

        // Tạo interval mới - làm mới mỗi 30 giây
        autoRefreshInterval = setInterval(async () => {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (currentUser) {
            try {
              //console.log("🔄 Tự động làm mới dữ liệu...");
              await refreshData();
              
              // Cập nhật các component nếu đang hiển thị
              const currentPage = document.querySelector('.page-content:not(.hidden)');
              if (currentPage) {
                const pageId = currentPage.id;
                switch (pageId) {
                  case 'tickets':
                    loadTickets();
                    break;
                  case 'dashboard':
                    loadDashboard();
                    break;
                  case 'approvals':
                    loadApprovals();
                    break;
                }
              }
              
              //console.log("✅ Làm mới dữ liệu thành công");
            } catch (error) {
              console.error("❌ Lỗi khi tự động làm mới dữ liệu:", error);
            }
          }
        }, 30000); // 30 giây
        
        //console.log("🚀 Đã bật tự động làm mới dữ liệu mỗi 30 giây");
      }

      // Function dừng auto refresh
      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          //console.log("⏹️ Đã dừng tự động làm mới dữ liệu");
        }
      }

      // Navigation functions
      function initializeNavigation() {
        const navItems = document.querySelectorAll(".nav-item");
        const pageContents = document.querySelectorAll(".page-content");
        const pageTitle = document.getElementById("pageTitle");

        navItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();

            // Đóng sidebar trên mobile khi click vào menu item
            const sidebar = document.getElementById("sidebar");
            if (sidebar) {
              sidebar.classList.add("-translate-x-full");
            }

            navItems.forEach((nav) =>
              nav.classList.remove("active", "bg-blue-50", "text-blue-600")
            );
            this.classList.add("active", "bg-blue-50", "text-blue-600");

            pageContents.forEach((content) => content.classList.add("hidden"));

            const targetId = this.getAttribute("href").substring(1);
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
              targetContent.classList.remove("hidden");
              const title = this.querySelector("span").textContent;
              pageTitle.textContent = title;

              switch (targetId) {
                case "dashboard":
                  loadDashboard();
                  break;
                case "tickets":
                  loadTickets();
                  break;
                case "approvals":
                  loadApprovals();
                  break;
                case "guides":
                  loadGuides();
                  break;
              }
            }
          });
        });
        // Set default page to tickets
        const defaultNavItem = document.querySelector('a[href="#tickets"]');
        if (defaultNavItem) {
          defaultNavItem.click();
        }

        // Mobile sidebar
        const openSidebar = document.getElementById("openSidebar");
        const closeSidebar = document.getElementById("closeSidebar");
        const sidebar = document.getElementById("sidebar");

        openSidebar.addEventListener("click", () =>
          sidebar.classList.remove("-translate-x-full")
        );
        closeSidebar.addEventListener("click", () =>
          sidebar.classList.add("-translate-x-full")
        );
      }

      // Dashboard functions
      function loadDashboard() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));

        // Kiểm tra user đã đăng nhập chưa
        if (!currentUser) {
          const dashboardStats = document.getElementById("dashboardStats");
          const chartsSection = document.getElementById("chartsSection");
          const recentActivities = document.getElementById("recentActivities");

          if (dashboardStats) {
            dashboardStats.innerHTML = `
              <div class="col-span-full bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                <i class="fas fa-sign-in-alt text-4xl text-gray-400 mb-4 block"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Vui lòng đăng nhập</h3>
                <p class="text-gray-500">Đăng nhập để xem thống kê dashboard</p>
              </div>
            `;
          }

          if (chartsSection) {
            chartsSection.innerHTML = "";
          }

          if (recentActivities) {
            recentActivities.innerHTML = `
              <div class="text-center py-8 text-gray-500">
                <i class="fas fa-sign-in-alt text-3xl mb-2 block"></i>
                <p>Vui lòng đăng nhập để xem hoạt động</p>
              </div>
            `;
          }

          return;
        }

        const isAdmin = currentUser?.idU === "admin";

        if (isAdmin) {
          loadAdminDashboard();
        } else {
          loadUserDashboard();
        }

        loadDashboardCharts();
        loadRecentActivities();

        // Gắn event handler cho nút "Xem tất cả" chỉ một lần
        initializeShowAllActivitiesHandler();
      }

      function loadAdminDashboard() {
        const stats = calculateAdminStats();
        renderDashboardStats(stats, true);
      }

      function loadUserDashboard() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const userEmail = currentUser?.idU;
        const stats = calculateUserStats(userEmail);
        renderDashboardStats(stats, false);
      }

      function calculateAdminStats() {
        const total = tickets.length;
        const pending = tickets.filter((t) => t.status === 191920002).length;
        const approved = tickets.filter((t) => t.status === 191920000).length;
        const rejected = tickets.filter((t) => t.status === 191920001).length;
        const inProgress = tickets.filter(
          (t) => t.status === "in-progress"
        ).length;
        const completed = tickets.filter(
          (t) => t.status === "completed"
        ).length;

        // Tính toán xu hướng (giả lập - có thể cải thiện với dữ liệu thực tế)
        const thisMonth = new Date().getMonth();
        const thisMonthTickets = tickets.filter((t) => {
          const ticketMonth = new Date(t.createdAt).getMonth();
          return ticketMonth === thisMonth;
        }).length;

        const lastMonthTickets = tickets.filter((t) => {
          const ticketMonth = new Date(t.createdAt).getMonth();
          return ticketMonth === thisMonth - 1;
        }).length;

        const trend =
          lastMonthTickets > 0
            ? Math.round(
                ((thisMonthTickets - lastMonthTickets) / lastMonthTickets) * 100
              )
            : 0;

        return {
          total: { value: total, trend: trend, label: "Tổng Tickets" },
          pending: {
            value: pending,
            trend: Math.round(Math.random() * 20 - 10),
            label: "Chờ phê duyệt",
          },
          approved: {
            value: approved,
            trend: Math.round(Math.random() * 15),
            label: "Đã phê duyệt",
          },
          rejected: {
            value: rejected,
            trend: Math.round(Math.random() * 10 - 5),
            label: "Từ chối",
          },
        };
      }

      function calculateUserStats(userEmail) {
        const userTickets = tickets.filter((t) => t.createdBy === userEmail);
        const total = userTickets.length;
        const pending = userTickets.filter(
          (t) => t.status === 191920002
        ).length;
        const approved = userTickets.filter(
          (t) => t.status === 191920000
        ).length;
        const rejected = userTickets.filter(
          (t) => t.status === 191920001
        ).length;

        // Tickets cần phê duyệt (user là approver)
        const needsApproval = tickets.filter((t) => {
          if (t.status !== 191920002) return false;
          // Kiểm tra nếu user này có trong danh sách approver
          return t.userTickets && t.userTickets.includes(userEmail);
        }).length;

        return {
          total: { value: total, trend: 0, label: "Tickets của tôi" },
          pending: { value: pending, trend: 0, label: "Đang chờ duyệt" },
          approved: { value: approved, trend: 0, label: "Đã được duyệt" },
          rejected: { value: rejected, trend: 0, label: "Từ chối" },
        };
      }

      function renderDashboardStats(stats, isAdmin) {
        const statsContainer = document.getElementById("dashboardStats");

        const statsArray = isAdmin
          ? [stats.total, stats.pending, stats.approved, stats.rejected]
          : [stats.total, stats.pending, stats.approved, stats.rejected];

        const colors = [
          { bg: "bg-blue-100", text: "text-blue-600", icon: "fa-ticket-alt" },
          { bg: "bg-yellow-100", text: "text-yellow-600", icon: "fa-clock" },
          {
            bg: "bg-green-100",
            text: "text-green-600",
            icon: "fa-check-circle",
          },
          { bg: "bg-red-100", text: "text-red-600", icon: "fa-times-circle" },
        ];

        // Biến global để lưu filter hiện tại
        window.currentDashboardFilter = null;

        statsContainer.innerHTML = statsArray
          .map((stat, index) => {
            const color = colors[index];
            const trendColor =
              stat.trend >= 0 ? "text-green-600" : "text-red-600";
            const trendIcon = stat.trend >= 0 ? "fa-arrow-up" : "fa-arrow-down";

            // Xác định filter value cho từng stat
            let filterValue = null;
            if (stat.label.includes("Chờ") || stat.label.includes("chờ"))
              filterValue = "pending";
            else if (stat.label.includes("Đã") || stat.label.includes("được"))
              filterValue = "approved";
            else if (stat.label.includes("Từ chối")) filterValue = "rejected";
            else if (stat.label.includes("Tổng")) filterValue = null; // Tổng tickets không filter

            return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6 card-hover cursor-pointer transition-all duration-200 hover:shadow-lg" 
                 onclick="filterDashboard('${filterValue}', '${
              stat.label
            }', this)" 
                 data-filter="${filterValue}">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs lg:text-sm font-medium text-gray-600">
                    ${stat.label}
                  </p>
                  <p class="text-xl lg:text-2xl font-bold text-gray-900">
                    ${stat.value.toLocaleString()}
                  </p>
                </div>
                <div class="w-10 h-10 lg:w-12 lg:h-12 ${
                  color.bg
                } rounded-lg flex items-center justify-center">
                  <i class="fas ${color.icon} ${
              color.text
            } text-sm lg:text-base"></i>
                </div>
              </div>
              ${
                stat.trend !== 0
                  ? `
                <div class="mt-3 lg:mt-4 flex items-center text-xs lg:text-sm">
                  <span class="${trendColor} flex items-center">
                    <i class="fas ${trendIcon} mr-1"></i>
                    ${Math.abs(stat.trend)}%
                  </span>
                  <span class="text-gray-500 ml-2">so với tháng trước</span>
                </div>
              `
                  : ""
              }
              <div class="mt-2 text-xs text-blue-600 opacity-0 transition-opacity duration-200 hover:opacity-100">
                <i class="fas fa-filter mr-1"></i>Click để lọc dữ liệu
              </div>
            </div>
          `;
          })
          .join("");
      }

      function loadDashboardCharts() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";

        if (isAdmin) {
          renderAdminCharts();
        } else {
          renderUserCharts();
        }
      }

      function renderAdminCharts() {
        const chartsSection = document.getElementById("chartsSection");

        chartsSection.innerHTML = `
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 col-span-full">
             <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
               <h4 class="text-base lg:text-lg font-semibold text-gray-800 mb-4">Phân bố trạng thái Tickets</h4>
               <div style="height: 300px; position: relative;">
                 <canvas id="statusChart"></canvas>
               </div>
             </div>
             <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
               <h4 class="text-base lg:text-lg font-semibold text-gray-800 mb-4">Tickets theo thời gian</h4>
               <div style="height: 300px; position: relative;">
                 <canvas id="timeChart"></canvas>
               </div>
             </div>
             <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6 lg:col-span-2">
               <h4 class="text-base lg:text-lg font-semibold text-gray-800 mb-4">Phân tích loại yêu cầu phổ biến</h4>
               <div style="height: 300px; position: relative;">
                 <canvas id="adminCategoryChart"></canvas>
               </div>
             </div>
           </div>
         `;

        setTimeout(() => {
          createStatusChart();
          createTimeChart();
          createAdminCategoryChart();
        }, 100);
      }

      function renderUserCharts() {
        const chartsSection = document.getElementById("chartsSection");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const userEmail = currentUser?.idU;

        chartsSection.innerHTML = `
           <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
             <h4 class="text-base lg:text-lg font-semibold text-gray-800 mb-4">Tickets của tôi</h4>
             <div style="height: 300px; position: relative;">
               <canvas id="userStatusChart"></canvas>
             </div>
           </div>
           <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
             <h4 class="text-base lg:text-lg font-semibold text-gray-800 mb-4">Phân tích loại yêu cầu</h4>
             <div style="height: 300px; position: relative;">
               <canvas id="userActivityChart"></canvas>
             </div>
           </div>
         `;

        setTimeout(() => {
          createUserStatusChart(userEmail);
          createUserActivityChart(userEmail);
        }, 100);
      }

      // Biến lưu trữ các chart instances
      let chartInstances = {};

      function createStatusChart() {
        const ctx = document.getElementById("statusChart");
        if (!ctx) return;

        // Destroy chart cũ nếu tồn tại
        if (chartInstances.statusChart) {
          chartInstances.statusChart.destroy();
        }

        const pending = tickets.filter((t) => t.status === 191920002).length;
        const approved = tickets.filter((t) => t.status === 191920000).length;
        const rejected = tickets.filter((t) => t.status === 191920001).length;

        const total = pending + approved + rejected;

        chartInstances.statusChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Chờ phê duyệt", "Đã phê duyệt", "Từ chối"],
            datasets: [
              {
                data: [pending, approved, rejected],
                backgroundColor: ["#fbbf24", "#10b981", "#ef4444"],
                borderWidth: 2,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
              tooltip: {
                enabled: false,
              },
            },
          },
          plugins: [
            {
              afterDraw: function (chart) {
                const ctx = chart.ctx;
                const data = chart.data;
                const datasets = data.datasets[0];

                // Vẽ phần trăm ở giữa từng phần của chart
                chart.data.labels.forEach((label, index) => {
                  const meta = chart.getDatasetMeta(0);
                  const arc = meta.data[index];
                  const value = datasets.data[index];
                  const percentage =
                    total > 0 ? ((value / total) * 100).toFixed(1) : 0;

                  // Chỉ hiển thị phần trăm nếu giá trị > 0
                  if (value > 0) {
                    // Tính toán vị trí giữa arc
                    const angle = (arc.startAngle + arc.endAngle) / 2;
                    const radius = (arc.innerRadius + arc.outerRadius) / 2;
                    const x = arc.x + Math.cos(angle) * radius;
                    const y = arc.y + Math.sin(angle) * radius;

                    // Vẽ phần trăm
                    ctx.fillStyle = "#ffffff";
                    ctx.font = "bold 14px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(`${percentage}%`, x, y);
                  }
                });
              },
            },
          ],
        });
      }

      function createTimeChart() {
        const ctx = document.getElementById("timeChart");
        if (!ctx) return;

        // Destroy chart cũ nếu tồn tại
        if (chartInstances.timeChart) {
          chartInstances.timeChart.destroy();
        }

        // Tạo dữ liệu cho 30 ngày gần nhất
        const last30Days = [];
        const ticketCounts = [];

        for (let i = 29; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toLocaleDateString("vi-VN", {
            day: "numeric",
            month: "numeric",
          });
          last30Days.push(dateStr);

          const count = tickets.filter((ticket) => {
            const ticketDate = new Date(ticket.createdAt);
            return ticketDate.toDateString() === date.toDateString();
          }).length;

          ticketCounts.push(count);
        }

        chartInstances.timeChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: last30Days,
            datasets: [
              {
                label: "Tickets mới",
                data: ticketCounts,
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
              x: {
                ticks: {
                  maxTicksLimit: 10,
                  maxRotation: 45,
                },
              },
            },
          },
        });
      }

      function createAdminCategoryChart() {
        const ctx = document.getElementById("adminCategoryChart");
        if (!ctx) return;

        // Destroy chart cũ nếu tồn tại
        if (chartInstances.adminCategoryChart) {
          chartInstances.adminCategoryChart.destroy();
        }

        // Đếm số lượng theo từng category cho toàn hệ thống
        const categoryCount = {};
        const categoryColors = {
          283640007: "#3b82f6", // Điều chỉnh định lượng
          283640004: "#ef4444", // Hủy phiếu nhập kho
          283640008: "#f59e0b", // Hủy phiếu xuất kho
          283640005: "#10b981", // Điều chỉnh phiếu nhập kho
          283640009: "#8b5cf6", // Điều chỉnh phiếu xuất kho
          191920000: "#06b6d4", // Điều chỉnh giá SOD
          283640002: "#84cc16", // Điều chỉnh giá BOD
          191920001: "#f97316", // VAT SOD
          283640001: "#ec4899", // VAT SO
          283640003: "#6366f1", // VAT BOD
          283640006: "#14b8a6", // VAT BO
        };

        tickets.forEach((ticket) => {
          const category = ticket.category;
          if (categoryCount[category]) {
            categoryCount[category]++;
          } else {
            categoryCount[category] = 1;
          }
        });

        // Sắp xếp theo số lượng giảm dần và lấy top 8
        const sortedCategories = Object.entries(categoryCount)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 8);

        const labels = [];
        const data = [];
        const backgroundColor = [];

        sortedCategories.forEach(([category, count]) => {
          labels.push(getCategoryText(parseInt(category)));
          data.push(count);
          backgroundColor.push(categoryColors[category] || "#6b7280");
        });

        chartInstances.adminCategoryChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Số lượng tickets",
                data: data,
                backgroundColor: backgroundColor,
                borderRadius: 8,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 0,
                },
              },
            },
          },
        });
      }

      // Filtered chart functions
      function createFilteredAdminCharts(filteredTickets, filterType) {
        // Update status chart với dữ liệu đã filter
        const ctx1 = document.getElementById("statusChart");
        if (ctx1 && chartInstances.statusChart) {
          chartInstances.statusChart.destroy();

          const pending = filteredTickets.filter(
            (t) => t.status === 191920002
          ).length;
          const approved = filteredTickets.filter(
            (t) => t.status === 191920000
          ).length;
          const rejected = filteredTickets.filter(
            (t) => t.status === 191920001
          ).length;
          const total = pending + approved + rejected;

          chartInstances.statusChart = new Chart(ctx1, {
            type: "doughnut",
            data: {
              labels: ["Chờ phê duyệt", "Đã phê duyệt", "Từ chối"],
              datasets: [
                {
                  data: [pending, approved, rejected],
                  backgroundColor: ["#fbbf24", "#10b981", "#ef4444"],
                  borderWidth: 2,
                  borderColor: "#ffffff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    padding: 20,
                    usePointStyle: true,
                  },
                },
                title: {
                  display: true,
                  text: `Filtered: ${getFilterLabel(filterType)}`,
                  color: "#3b82f6",
                },
                tooltip: {
                  enabled: false,
                },
              },
            },
            plugins: [
              {
                afterDraw: function (chart) {
                  const ctx = chart.ctx;
                  const data = chart.data;
                  const datasets = data.datasets[0];

                  // Vẽ phần trăm ở giữa từng phần của chart
                  chart.data.labels.forEach((label, index) => {
                    const meta = chart.getDatasetMeta(0);
                    const arc = meta.data[index];
                    const value = datasets.data[index];
                    const percentage =
                      total > 0 ? ((value / total) * 100).toFixed(1) : 0;

                    // Chỉ hiển thị phần trăm nếu giá trị > 0
                    if (value > 0) {
                      // Tính toán vị trí giữa arc
                      const angle = (arc.startAngle + arc.endAngle) / 2;
                      const radius = (arc.innerRadius + arc.outerRadius) / 2;
                      const x = arc.x + Math.cos(angle) * radius;
                      const y = arc.y + Math.sin(angle) * radius;

                      // Vẽ phần trăm
                      ctx.fillStyle = "#ffffff";
                      ctx.font = "bold 14px Arial";
                      ctx.textAlign = "center";
                      ctx.textBaseline = "middle";
                      ctx.fillText(`${percentage}%`, x, y);
                    }
                  });
                },
              },
            ],
          });
        }

        // Update time chart với dữ liệu đã filter
        const ctx2 = document.getElementById("timeChart");
        if (ctx2 && chartInstances.timeChart) {
          chartInstances.timeChart.destroy();

          const last30Days = [];
          const ticketCounts = [];

          for (let i = 29; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toLocaleDateString("vi-VN", {
              day: "numeric",
              month: "numeric",
            });
            last30Days.push(dateStr);

            const count = filteredTickets.filter((ticket) => {
              const ticketDate = new Date(ticket.createdAt);
              return ticketDate.toDateString() === date.toDateString();
            }).length;

            ticketCounts.push(count);
          }

          chartInstances.timeChart = new Chart(ctx2, {
            type: "line",
            data: {
              labels: last30Days,
              datasets: [
                {
                  label: "Tickets mới",
                  data: ticketCounts,
                  borderColor: "#3b82f6",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: `Filtered: ${getFilterLabel(filterType)}`,
                  color: "#3b82f6",
                },
              },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: {
                  ticks: {
                    maxTicksLimit: 10,
                    maxRotation: 45,
                  },
                },
              },
            },
          });
        }

        // Update category chart với dữ liệu đã filter
        const ctx3 = document.getElementById("adminCategoryChart");
        if (ctx3 && chartInstances.adminCategoryChart) {
          chartInstances.adminCategoryChart.destroy();

          const categoryCount = {};
          const categoryColors = {
            283640007: "#3b82f6",
            283640004: "#ef4444",
            283640008: "#f59e0b",
            283640005: "#10b981",
            283640009: "#8b5cf6",
            191920000: "#06b6d4",
            283640002: "#84cc16",
            191920001: "#f97316",
            283640001: "#ec4899",
            283640003: "#6366f1",
            283640006: "#14b8a6",
          };

          filteredTickets.forEach((ticket) => {
            const category = ticket.category;
            categoryCount[category] = (categoryCount[category] || 0) + 1;
          });

          const sortedCategories = Object.entries(categoryCount)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 8);

          const labels = sortedCategories.map(([category]) =>
            getCategoryText(parseInt(category))
          );
          const data = sortedCategories.map(([, count]) => count);
          const backgroundColor = sortedCategories.map(
            ([category]) => categoryColors[category] || "#6b7280"
          );

          chartInstances.adminCategoryChart = new Chart(ctx3, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Số lượng tickets",
                  data: data,
                  backgroundColor: backgroundColor,
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: `Filtered: ${getFilterLabel(filterType)}`,
                  color: "#3b82f6",
                },
              },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { ticks: { maxRotation: 45, minRotation: 0 } },
              },
            },
          });
        }
      }

      function createFilteredUserCharts(
        filteredTickets,
        filterType,
        userEmail
      ) {
        // Filter tickets của user
        const userFilteredTickets = filteredTickets.filter(
          (t) => t.createdBy === userEmail
        );

        // Update user status chart
        const ctx1 = document.getElementById("userStatusChart");
        if (ctx1 && chartInstances.userStatusChart) {
          chartInstances.userStatusChart.destroy();

          const pending = userFilteredTickets.filter(
            (t) => t.status === 191920002
          ).length;
          const approved = userFilteredTickets.filter(
            (t) => t.status === 191920000
          ).length;
          const rejected = userFilteredTickets.filter(
            (t) => t.status === 191920001
          ).length;

          chartInstances.userStatusChart = new Chart(ctx1, {
            type: "bar",
            data: {
              labels: ["Chờ duyệt", "Đã duyệt", "Từ chối"],
              datasets: [
                {
                  label: "Số lượng",
                  data: [pending, approved, rejected],
                  backgroundColor: ["#fbbf24", "#10b981", "#ef4444"],
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: `Filtered: ${getFilterLabel(filterType)}`,
                  color: "#3b82f6",
                },
              },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
              },
            },
          });
        }

        // Update user activity chart (category analysis)
        const ctx2 = document.getElementById("userActivityChart");
        if (ctx2 && chartInstances.userActivityChart) {
          chartInstances.userActivityChart.destroy();

          const categoryCount = {};
          const categoryColors = {
            283640007: "#3b82f6",
            283640004: "#ef4444",
            283640008: "#f59e0b",
            283640005: "#10b981",
            283640009: "#8b5cf6",
            191920000: "#06b6d4",
            283640002: "#84cc16",
            191920001: "#f97316",
            283640001: "#ec4899",
            283640003: "#6366f1",
            283640006: "#14b8a6",
          };

          userFilteredTickets.forEach((ticket) => {
            const category = ticket.category;
            categoryCount[category] = (categoryCount[category] || 0) + 1;
          });

          const labels = Object.keys(categoryCount).map((cat) =>
            getCategoryText(parseInt(cat))
          );
          const data = Object.values(categoryCount);
          const backgroundColor = Object.keys(categoryCount).map(
            (cat) => categoryColors[cat] || "#6b7280"
          );

          chartInstances.userActivityChart = new Chart(ctx2, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: backgroundColor,
                  borderWidth: 2,
                  borderColor: "#ffffff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { padding: 20, usePointStyle: true },
                },
                title: {
                  display: true,
                  text: `Filtered: ${getFilterLabel(filterType)}`,
                  color: "#3b82f6",
                },
              },
            },
          });
        }
      }

      function loadFilteredRecentActivities(filteredTickets) {
        const recentActivities = document.getElementById("recentActivities");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";
        const userEmail = currentUser?.idU;

        // Lọc tickets theo quyền và filter
        let relevantTickets = [];
        if (isAdmin) {
          relevantTickets = filteredTickets;
        } else {
          relevantTickets = filteredTickets.filter(
            (ticket) =>
              ticket.createdBy === userEmail ||
              (ticket.userTickets && ticket.userTickets.includes(userEmail))
          );
        }

        // Tạo activities từ filtered tickets
        const activities = [];
        relevantTickets.forEach((ticket) => {
          let activity;
          if (ticket.status === 191920000) {
            activity = {
              type: "approved",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000,
              description: isAdmin
                ? `Ticket ${ticket.name} đã được phê duyệt`
                : ticket.createdBy === userEmail
                ? `Ticket của bạn đã được phê duyệt: ${ticket.title}`
                : `Đã phê duyệt ticket: ${ticket.title}`,
            };
          } else if (ticket.status === 191920001) {
            activity = {
              type: "rejected",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000,
              description: isAdmin
                ? `Ticket ${ticket.name} đã bị từ chối`
                : ticket.createdBy === userEmail
                ? `Ticket của bạn đã bị từ chối: ${ticket.title}`
                : `Đã từ chối ticket: ${ticket.title}`,
            };
          } else {
            activity = {
              type: "created",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime(),
              description: isAdmin
                ? `${getUserNameByEmail(ticket.createdBy)} tạo ticket: ${
                    ticket.title
                  }`
                : ticket.createdBy === userEmail
                ? `Bạn đã tạo ticket: ${ticket.title}`
                : `Ticket mới cần phê duyệt: ${ticket.title}`,
            };
          }
          activities.push(activity);
        });

        activities.sort((a, b) => b.time - a.time);
        const recentActivitiesList = activities.slice(0, 10);

        if (recentActivitiesList.length === 0) {
          recentActivities.innerHTML = `
             <div class="text-center py-8 text-gray-500">
               <i class="fas fa-filter text-3xl mb-2 block"></i>
               <p>Không có hoạt động nào với bộ lọc này</p>
             </div>
           `;
          return;
        }

        recentActivities.innerHTML = recentActivitiesList
          .map(
            (activity) => `
             <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="viewTicket('${
               activity.ticket.id
             }')">
               <div class="flex-shrink-0">
                 <div class="w-8 h-8 rounded-full flex items-center justify-center ${getActivityIconClass(
                   activity.type
                 )}">
                   <i class="fas ${getActivityIcon(
                     activity.type
                   )} text-white text-xs"></i>
                 </div>
               </div>
               <div class="flex-1 min-w-0">
                 <div class="flex items-center justify-between">
                   <p class="text-sm text-gray-900 truncate font-medium">${
                     activity.description
                   }</p>
                   <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${formatTimeAgo(
                     activity.time
                   )}</span>
                 </div>
                 <div class="flex items-center space-x-2 mt-1">
                   <span class="text-xs text-gray-500">${getCategoryText(
                     activity.ticket.category
                   )}</span>
                   <span class="text-xs text-gray-400">•</span>
                   <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full ${getStatusClass(
                     activity.ticket.status
                   )}">
                     ${getStatusText(activity.ticket.status)}
                   </span>
                 </div>
               </div>
             </div>
           `
          )
          .join("");
      }

      function getFilterLabel(filterType) {
        switch (filterType) {
          case "pending":
            return "Chờ phê duyệt";
          case "approved":
            return "Đã phê duyệt";
          case "rejected":
            return "Từ chối";
          default:
            return "Tất cả";
        }
      }

      function createUserStatusChart(userEmail) {
        const ctx = document.getElementById("userStatusChart");
        if (!ctx) return;

        // Destroy chart cũ nếu tồn tại
        if (chartInstances.userStatusChart) {
          chartInstances.userStatusChart.destroy();
        }

        const userTickets = tickets.filter((t) => t.createdBy === userEmail);
        const pending = userTickets.filter(
          (t) => t.status === 191920002
        ).length;
        const approved = userTickets.filter(
          (t) => t.status === 191920000
        ).length;
        const rejected = userTickets.filter(
          (t) => t.status === 191920001
        ).length;

        chartInstances.userStatusChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Chờ duyệt", "Đã duyệt", "Từ chối"],
            datasets: [
              {
                label: "Số lượng",
                data: [pending, approved, rejected],
                backgroundColor: ["#fbbf24", "#10b981", "#ef4444"],
                borderRadius: 8,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      function createUserActivityChart(userEmail) {
        const ctx = document.getElementById("userActivityChart");
        if (!ctx) return;

        // Destroy chart cũ nếu tồn tại
        if (chartInstances.userActivityChart) {
          chartInstances.userActivityChart.destroy();
        }

        // Lấy tickets của user
        const userTickets = tickets.filter((t) => t.createdBy === userEmail);

        // Đếm số lượng theo từng category
        const categoryCount = {};
        const categoryColors = {
          283640007: "#3b82f6", // Điều chỉnh định lượng
          283640004: "#ef4444", // Hủy phiếu nhập kho
          283640008: "#f59e0b", // Hủy phiếu xuất kho
          283640005: "#10b981", // Điều chỉnh phiếu nhập kho
          283640009: "#8b5cf6", // Điều chỉnh phiếu xuất kho
          191920000: "#06b6d4", // Điều chỉnh giá SOD
          283640002: "#84cc16", // Điều chỉnh giá BOD
          191920001: "#f97316", // VAT SOD
          283640001: "#ec4899", // VAT SO
          283640003: "#6366f1", // VAT BOD
          283640006: "#14b8a6", // VAT BO
        };

        userTickets.forEach((ticket) => {
          const category = ticket.category;
          if (categoryCount[category]) {
            categoryCount[category]++;
          } else {
            categoryCount[category] = 1;
          }
        });

        // Chuyển đổi thành arrays cho Chart.js
        const labels = [];
        const data = [];
        const backgroundColor = [];

        Object.entries(categoryCount).forEach(([category, count]) => {
          labels.push(getCategoryText(parseInt(category)));
          data.push(count);
          backgroundColor.push(categoryColors[category] || "#6b7280");
        });

        chartInstances.userActivityChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: backgroundColor,
                borderWidth: 2,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
            },
          },
        });
      }

      let allActivities = []; // Biến global để lưu tất cả hoạt động
      let showingAllActivities = false; // Trạng thái hiển thị
      let showAllActivitiesHandlerInitialized = false; // Flag để tránh gắn handler nhiều lần

      function initializeShowAllActivitiesHandler() {
        if (showAllActivitiesHandlerInitialized) return;

        const showAllActivitiesBtn =
          document.getElementById("showAllActivities");
        if (showAllActivitiesBtn) {
          showAllActivitiesBtn.addEventListener("click", function () {
            loadRecentActivities(!showingAllActivities);
          });
          showAllActivitiesHandlerInitialized = true;
        }
      }

      function loadRecentActivities(showAll = false) {
        const recentActivities = document.getElementById("recentActivities");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";
        const userEmail = currentUser?.idU;

        // Lọc tickets theo quyền
        let relevantTickets = [];
        if (isAdmin) {
          relevantTickets = tickets; // Admin thấy tất cả
        } else {
          // User thường chỉ thấy tickets liên quan đến mình
          relevantTickets = tickets.filter(
            (ticket) =>
              ticket.createdBy === userEmail ||
              (ticket.userTickets && ticket.userTickets.includes(userEmail))
          );
        }

        // Tạo danh sách hoạt động từ tickets
        const activities = [];

        relevantTickets.forEach((ticket) => {
          // Chỉ hiển thị activity quan trọng nhất cho mỗi ticket
          let activity;

          if (ticket.status === 191920000) {
            // Ticket đã được phê duyệt - ưu tiên hiển thị trạng thái này
            activity = {
              type: "approved",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000, // +1 giờ
              description: isAdmin
                ? `Ticket ${ticket.name} đã được phê duyệt`
                : ticket.createdBy === userEmail
                ? `Ticket của bạn đã được phê duyệt: ${ticket.title}`
                : `Đã phê duyệt ticket: ${ticket.title}`,
            };
          } else if (ticket.status === 191920001) {
            // Ticket bị từ chối - ưu tiên hiển thị trạng thái này
            activity = {
              type: "rejected",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime() + 3600000, // +1 giờ
              description: isAdmin
                ? `Ticket ${ticket.name} đã bị từ chối`
                : ticket.createdBy === userEmail
                ? `Ticket của bạn đã bị từ chối: ${ticket.title}`
                : `Đã từ chối ticket: ${ticket.title}`,
            };
          } else {
            // Ticket chưa được xử lý - hiển thị hoạt động tạo
            activity = {
              type: "created",
              ticket: ticket,
              time: new Date(ticket.createdAt).getTime(),
              description: isAdmin
                ? `${getUserNameByEmail(ticket.createdBy)} tạo ticket: ${
                    ticket.title
                  }`
                : ticket.createdBy === userEmail
                ? `Bạn đã tạo ticket: ${ticket.title}`
                : `Ticket mới cần phê duyệt: ${ticket.title}`,
            };
          }

          activities.push(activity);
        });

        // Sắp xếp theo thời gian (mới nhất trước)
        activities.sort((a, b) => b.time - a.time);
        allActivities = activities; // Lưu tất cả hoạt động

        // Quyết định số lượng hiển thị
        const recentActivitiesList = showAll
          ? activities
          : activities.slice(0, 10);
        showingAllActivities = showAll;

        // Cập nhật text nút
        const showAllBtn = document.getElementById("showAllActivities");
        if (showAllBtn) {
          showAllBtn.textContent = showAll ? "Thu gọn" : "Xem tất cả";
        }

        if (recentActivitiesList.length === 0) {
          recentActivities.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-history text-3xl mb-2 block"></i>
              <p>Chưa có hoạt động nào</p>
            </div>
          `;
          return;
        }

        recentActivities.innerHTML = recentActivitiesList
          .map(
            (activity) => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="viewTicket('${
                  activity.ticket.id
                }')">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${getActivityIconClass(
                          activity.type
                        )}">
                            <i class="fas ${getActivityIcon(
                              activity.type
                            )} text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-900 truncate font-medium">${
                              activity.description
                            }</p>
                            <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${formatTimeAgo(
                              activity.time
                            )}</span>
                        </div>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="text-xs text-gray-500">${getCategoryText(
                              activity.ticket.category
                            )}</span>
                            <span class="text-xs text-gray-400">•</span>
                            <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full ${getStatusClass(
                              activity.ticket.status
                            )}">
                                ${getStatusText(activity.ticket.status)}
                            </span>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function getActivityIcon(type) {
        switch (type) {
          case "created":
            return "fa-plus-circle";
          case "approved":
            return "fa-check-circle";
          case "rejected":
            return "fa-times-circle";
          case "completed":
            return "fa-flag-checkered";
          default:
            return "fa-info-circle";
        }
      }

      function getActivityIconClass(type) {
        switch (type) {
          case "created":
            return "bg-blue-500";
          case "approved":
            return "bg-green-500";
          case "rejected":
            return "bg-red-500";
          case "completed":
            return "bg-purple-500";
          default:
            return "bg-gray-500";
        }
      }

      // Search and Filter functions
      function initializeSearchAndFilter() {
        const searchInput = document.getElementById("searchTickets");
        const statusFilter = document.getElementById("statusFilter");
        const clearSearchBtn = document.getElementById("clearSearch");

        if (searchInput) {
          searchInput.addEventListener("input", handleSearch);
        }

        if (statusFilter) {
          statusFilter.addEventListener("change", handleStatusFilter);
        }

        if (clearSearchBtn) {
          clearSearchBtn.addEventListener("click", clearAllFilters);
        }
      }

      function handleSearch(event) {
        currentSearchTerm = event.target.value.toLowerCase().trim();

        // Hiển thị/ẩn nút xóa tìm kiếm
        const clearSearchBtn = document.getElementById("clearSearch");
        if (clearSearchBtn) {
          if (currentSearchTerm) {
            clearSearchBtn.classList.remove("hidden");
          } else {
            clearSearchBtn.classList.add("hidden");
          }
        }

        applyFilters();
      }

      function handleStatusFilter(event) {
        currentStatusFilter = event.target.value;
        applyFilters();
      }

      function clearAllFilters() {
        // Reset các input
        const searchInput = document.getElementById("searchTickets");
        const statusFilter = document.getElementById("statusFilter");
        const clearSearchBtn = document.getElementById("clearSearch");

        if (searchInput) {
          searchInput.value = "";
        }

        if (statusFilter) {
          statusFilter.value = "";
        }

        if (clearSearchBtn) {
          clearSearchBtn.classList.add("hidden");
        }

        // Reset biến
        currentSearchTerm = "";
        currentStatusFilter = "";

        // Áp dụng lại bộ lọc (sẽ hiển thị tất cả)
        applyFilters();
      }

      function applyFilters() {
        filteredTickets = tickets.filter((ticket) => {
          // Lọc theo từ khóa tìm kiếm
          const matchesSearch =
            !currentSearchTerm ||
            ticket.name.toLowerCase().includes(currentSearchTerm) ||
            ticket.title.toLowerCase().includes(currentSearchTerm) ||
            getCategoryText(ticket.category)
              .toLowerCase()
              .includes(currentSearchTerm) ||
            getUserNameByEmail(ticket.createdBy)
              .toLowerCase()
              .includes(currentSearchTerm) ||
            getStatusText(ticket.status)
              .toLowerCase()
              .includes(currentSearchTerm);

          // Lọc theo trạng thái
          const matchesStatus =
            !currentStatusFilter ||
            getStatusFilterValue(ticket.status) === currentStatusFilter;

          return matchesSearch && matchesStatus;
        });

        // Cập nhật thông báo kết quả tìm kiếm trên mobile
        updateSearchResultsDisplay();

        // Reset về trang đầu và load lại
        currentTicketPage = 1;
        loadTickets(1);
      }

      function updateSearchResultsDisplay() {
        const searchResultsMobile = document.getElementById(
          "searchResultsMobile"
        );

        if (searchResultsMobile) {
          if (currentSearchTerm || currentStatusFilter) {
            const resultText = `Tìm thấy ${filteredTickets.length} kết quả`;
            const filterInfo = [];

            if (currentSearchTerm) {
              filterInfo.push(`"${currentSearchTerm}"`);
            }

            if (currentStatusFilter) {
              const statusText = getStatusTextFromFilter(currentStatusFilter);
              filterInfo.push(`trạng thái: ${statusText}`);
            }

            searchResultsMobile.textContent = `${resultText}${
              filterInfo.length > 0 ? ` cho ${filterInfo.join(", ")}` : ""
            }`;
            searchResultsMobile.classList.remove("hidden");
          } else {
            searchResultsMobile.classList.add("hidden");
          }
        }
      }

      function getStatusTextFromFilter(filterValue) {
        switch (filterValue) {
          case "pending":
            return "Chờ phê duyệt";
          case "approved":
            return "Đã phê duyệt";
          case "rejected":
            return "Từ chối";
          case "in-progress":
            return "Đang xử lý";
          case "completed":
            return "Hoàn thành";
          default:
            return "";
        }
      }

      function getStatusFilterValue(status) {
        switch (status) {
          case 191920002:
            return "pending";
          case 191920000:
            return "approved";
          case 191920001:
            return "rejected";
          case "in-progress":
            return "in-progress";
          case "completed":
            return "completed";
          default:
            return "";
        }
      }

      // Tickets management

      function loadTickets(page = 1) {
        // Kiểm tra user đã đăng nhập chưa
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          const ticketsTable = document.getElementById("ticketsTable");
          const paginationContainer =
            document.getElementById("ticketsPagination");
          const paginationInfo = document.getElementById("paginationInfo");

          if (ticketsTable) {
            ticketsTable.innerHTML = `
              <tr>
                <td colspan="7" class="text-center text-gray-500 py-8">
                  <i class="fas fa-sign-in-alt text-3xl mb-2 block"></i>
                  Vui lòng đăng nhập để xem dữ liệu
                </td>
              </tr>
            `;
          }

          if (paginationInfo) {
            paginationInfo.textContent = "Chưa đăng nhập";
          }

          if (paginationContainer) {
            paginationContainer.innerHTML = "";
          }

          return;
        }

        currentTicketPage = page;
        const ticketsTable = document.getElementById("ticketsTable");
        const paginationContainer =
          document.getElementById("ticketsPagination");
        const paginationInfo = document.getElementById("paginationInfo");

        // Sử dụng filteredTickets thay vì tickets gốc
        const ticketsToShow =
          filteredTickets.length > 0 || currentSearchTerm || currentStatusFilter
            ? filteredTickets
            : tickets;
        const totalPages = Math.ceil(ticketsToShow.length / ticketsPerPage);
        const start = (page - 1) * ticketsPerPage;
        const end = Math.min(start + ticketsPerPage, ticketsToShow.length);
        const ticketsToRender = ticketsToShow.slice(start, end);

        // Cập nhật thông tin pagination
        if (ticketsToShow.length === 0) {
          if (currentSearchTerm || currentStatusFilter) {
            paginationInfo.textContent = "Không tìm thấy kết quả phù hợp";
          } else {
            paginationInfo.textContent = "Không có dữ liệu";
          }
        } else {
          const totalText =
            currentSearchTerm || currentStatusFilter
              ? `${ticketsToShow.length} kết quả tìm thấy`
              : `${ticketsToShow.length} kết quả`;
          paginationInfo.textContent = `Hiển thị ${
            start + 1
          }-${end} của ${totalText}`;
        }

        // Render bảng tickets
        if (ticketsToRender.length === 0) {
          ticketsTable.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-gray-500 py-8">
                <i class="fas fa-inbox text-3xl mb-2 block"></i>
                Không có tickets nào
              </td>
            </tr>
          `;
        } else {
          ticketsTable.innerHTML = ticketsToRender
            .map(
              (ticket) => `
          <tr class="hover:bg-gray-50 cursor-pointer transition-colors" onclick="handleTicketRowClick('${
            ticket.id
          }', ${ticket.status})">
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate">${
              ticket.name
            }</td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm text-gray-900 truncate">${
              ticket.title
            }</td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm text-gray-500 truncate">${getCategoryText(
              ticket.category
            )}</td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm text-gray-500 truncate">${getUserNameByEmail(
              ticket.createdBy
            )}</td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap truncate">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(
                ticket.status
              )}">
                ${getStatusText(ticket.status)}
              </span>
            </td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm text-gray-500 truncate">${formatDate(
              ticket.createdAt
            )}</td>
            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap text-sm font-medium truncate">
              <div class="flex items-center space-x-2">
                <i class="fas fa-eye text-blue-600"></i>
                ${
                  ticket.status === 191920002
                    ? `<i class="fas fa-check-circle text-green-600"></i>`
                    : `<i class="fas fa-info-circle text-gray-400"></i>`
                }
              </div>
            </td>
          </tr>
        `
            )
            .join("");
        }

        // Render phân trang với thiết kế mới
        let paginationHTML = "";

        if (totalPages > 1) {
          // Nút Previous
          paginationHTML += `
            <button ${page === 1 ? "disabled" : ""} onclick="loadTickets(${
            page - 1
          })"
              class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50 disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:bg-white">
              <i class="fas fa-chevron-left mr-1"></i>Previous
            </button>
          `;

          // Logic hiển thị số trang thông minh
          const maxVisiblePages = 5;
          let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
          let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

          if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
          }

          // Hiển thị trang đầu và dấu ...
          if (startPage > 1) {
            paginationHTML += `
              <button onclick="loadTickets(1)"
                class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50">
                1
              </button>
            `;
            if (startPage > 2) {
              paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
          }

          // Các số trang
          for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
              <button onclick="loadTickets(${i})"
                class="px-3 py-1 border rounded ${
                  i === page
                    ? "bg-blue-600 text-white border-blue-600"
                    : "text-blue-600 hover:bg-blue-50"
                }">
                ${i}
              </button>
            `;
          }

          // Hiển thị dấu ... và trang cuối
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
            paginationHTML += `
              <button onclick="loadTickets(${totalPages})"
                class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50">
                ${totalPages}
              </button>
            `;
          }

          // Nút Next
          paginationHTML += `
            <button ${
              page === totalPages ? "disabled" : ""
            } onclick="loadTickets(${page + 1})"
              class="px-3 py-1 border rounded text-blue-600 hover:bg-blue-50 disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:bg-white">
              Next<i class="fas fa-chevron-right ml-1"></i>
            </button>
          `;
        } else {
          // Nếu chỉ có 1 trang, hiển thị pagination đơn giản
          paginationHTML = `
            <button disabled class="px-3 py-1 border rounded text-gray-400 cursor-not-allowed">
              <i class="fas fa-chevron-left mr-1"></i>Previous
            </button>
            <button class="px-3 py-1 border rounded bg-blue-600 text-white border-blue-600">
              1
            </button>
            <button disabled class="px-3 py-1 border rounded text-gray-400 cursor-not-allowed">
              Next<i class="fas fa-chevron-right ml-1"></i>
            </button>
          `;
        }

        paginationContainer.innerHTML = paginationHTML;
      }

      // Approvals management
      function loadApprovals() {
        // Kiểm tra user đã đăng nhập chưa
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          const approvalsTable = document.getElementById("approvalsTable");
          if (approvalsTable) {
            approvalsTable.innerHTML = `
              <tr>
                <td colspan="6" class="text-center text-gray-500 py-8">
                  <i class="fas fa-sign-in-alt text-3xl mb-2 block"></i>
                  Vui lòng đăng nhập để xem dữ liệu
                </td>
              </tr>
            `;
          }
          return;
        }

        const approvalsTable = document.getElementById("approvalsTable");
        const pendingTickets = tickets.filter((t) => t.status === 191920002);

        approvalsTable.innerHTML = pendingTickets
          .map(
            (ticket) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                      ticket.id
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                      ticket.title
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                      ticket.createdBy
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getCategoryText(
                      ticket.category
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(
                          ticket.priority
                        )}">
                            ${getPriorityText(ticket.priority)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(
                      ticket.createdAt
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openApprovalModal('${
                          ticket.id
                        }')" class="text-green-600 hover:text-green-900 mr-3">Phê duyệt</button>
                        <button onclick="viewTicket('${
                          ticket.id
                        }')" class="text-blue-600 hover:text-blue-900">Xem</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Form handlers

      function initializeFormHandlers() {
        if (ticketHandlersInitialized) return; // đã gắn rồi thì thoát
        ticketHandlersInitialized = true;

        const submitTicket = document.getElementById("submitTicket");
        const cancelTicket = document.getElementById("cancelTicket");
        const newTicketForm = document.getElementById("newTicketForm");

        submitTicket.addEventListener("click", function (e) {
          e.preventDefault(); // Ngăn form submit mặc định

          // Kiểm tra validation riêng cho trường người duyệt (Choices.js)
          // Bỏ qua validation người duyệt cho case "Điều chỉnh định lượng" (283640007)
          const ticketCategory = document.getElementById("ticketCategory");
          const selectedCategory = ticketCategory ? ticketCategory.value : null;
          
          if (selectedCategory !== "283640007") { // Không phải "Điều chỉnh định lượng"
            const selectedApprovers = approverChoices
              ? approverChoices.getValue(true)
              : [];
            if (!selectedApprovers || selectedApprovers.length === 0) {
              showNotification("Vui lòng chọn ít nhất một người duyệt!", "error");
              // Focus vào trường người duyệt
              const approverContainer = document.querySelector(
                ".choices[data-type='select-multiple']"
              );
              if (approverContainer) {
                approverContainer.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
                approverContainer.classList.add("border-red-500");
                setTimeout(() => {
                  approverContainer.classList.remove("border-red-500");
                }, 3000);
              }
              return;
            }
          }

          // Kiểm tra validation HTML5 cho các trường khác
          if (!newTicketForm.checkValidity()) {
            newTicketForm.reportValidity();
            return;
          }

          // Nếu tất cả đều hợp lệ thì tạo ticket
          createNewTicket();
        });

        cancelTicket.addEventListener("click", function () {
          newTicketForm.reset();
          document.querySelector('a[href="#tickets"]').click();
        });
      }
      // ============ Create ticket =====================
      async function createNewTicket() {
        // Lấy user từ localStorage
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const selectedApprovers = approverChoices.getValue(true);
        const approversText = Array.isArray(selectedApprovers)
          ? selectedApprovers.join(",")
          : selectedApprovers;

        let newTicket = {
          crdfd_nguoiyeucau: currentUser.idU,
          crdfd_trangthai: 191920002,
          //crdfd_nguoiduyet: approversText,
          crdfd_lydoieuchinh:
            document.getElementById("ticketDescription").value,
          crdfd_loaiieuchinh: parseInt(
            document.getElementById("ticketCategory").value
          ),
          cr1bb_thongtinyeucau: document.getElementById("ticketAdjustmentInfo")
            .value,
          cr1bb_phongban: document.getElementById("ticketDepartment").value,
        };
        
        // Convert numeric fields to strings to avoid OData type conversion errors
        if (typeof newTicket.crdfd_trangthai === 'number') {
          newTicket.crdfd_trangthai = newTicket.crdfd_trangthai.toString();
        }
        if (typeof newTicket.crdfd_loaiieuchinh === 'number') {
          newTicket.crdfd_loaiieuchinh = newTicket.crdfd_loaiieuchinh.toString();
        }

        // tuỳ loại case mà bổ sung thêm field
        switch (parseInt(document.getElementById("ticketCategory").value)) {
          case 283640007: // điều chỉnh định lượng
            // Kiểm tra validation data từ API
            if (!window.lastUnitConversionData) {
              showNotification('Vui lòng nhập sản phẩm và chọn đơn vị hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastUnitConversionData.crdfd_unitconvertionid,
              cr1bb_giatriexuat:
                document.getElementById("dieuchinhdinhluong").value,
              cr1bb_giatrihientai: window.lastUnitConversionData.crdfd_giatrichuyenoi,
              crdfd_nguoiduyet: "Hệ thống",
            });
            break;

          case 283640008: // hủy phiếu xuất kho
            // Sử dụng kết quả validation đã lưu
            if (!window.lastExportTransactionData) {
              showNotification('Vui lòng nhập và kiểm tra thông tin phiếu xuất hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastExportTransactionData.crdfd_transactionsalesid,
              crdfd_nguoiduyet: approversText,
              cr1bb_giatriexuat: window.lastExportTransactionData.crdfd_soluonggiaotheokho,
              cr1bb_giatrihientai: window.lastExportTransactionData.crdfd_soluonggiaotheokho,
            });
            break;
          case 283640004: // hủy phiếu nhập kho 
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastTransactionData.crdfd_transactionbuyid,
              crdfd_nguoiduyet: approversText,
              cr1bb_giatriexuat: window.lastTransactionData.crdfd_soluonganhantheokho,
              cr1bb_giatrihientai: window.lastTransactionData.crdfd_soluonganhantheokho,
            });
            break;

          case 283640005: // chỉnh phiếu nhập kho
            // Kiểm tra validation data từ API
            if (!window.lastAdjustImportData) {
              showNotification('Vui lòng nhập mã đơn hàng và mã phiếu hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastAdjustImportData.crdfd_transactionbuyid,
              cr1bb_giatriexuat:
                document.getElementById("numberNhapDon").value +
                "|" +
                document.getElementById("numberNhapKho").value, // số lượng theo đơn|số lượng theo kho
              crdfd_nguoiduyet: approversText,
            });
            break;
            
          case 283640009: // chỉnh phiếu xuất kho
            // Kiểm tra validation data từ API
            if (!window.lastAdjustExportData) {
              showNotification('Vui lòng nhập mã đơn hàng và mã phiếu hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastAdjustExportData.crdfd_transactionsalesid,
              cr1bb_giatriexuat:
                document.getElementById("numberXuatDon").value +
                "|" +
                document.getElementById("numberXuatKho").value, // số lượng theo đơn|số lượng theo kho
              crdfd_nguoiduyet: approversText,
            });
            break;
            
          case 283640002: // Điều chỉnh giá BOD
            // Sử dụng kết quả validation đã lưu
            if (!window.lastBuyOrderValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastBuyOrderValidation.crdfd_buyorderdetailsid,
              cr1bb_giatriexuat: document.getElementById("priceSodBod").value,
              cr1bb_giatrihientai: window.lastBuyOrderValidation.crdfd_giagoc,
              crdfd_nguoiduyet: approversText,
            });
            break;

          case 191920000: // Điều chỉnh giá SOD
            // Sử dụng kết quả validation đã lưu
            if (!window.lastOrderValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastOrderValidation.crdfd_saleorderdetailid,
              cr1bb_giatriexuat: document.getElementById("priceSodBod").value,
              cr1bb_giatrihientai: window.lastOrderValidation.crdfd_giagoc,
              crdfd_nguoiduyet: approversText,
            });
            break;

          case 191920001: // VAT SOD
            // Sử dụng kết quả validation đã lưu
            if (!window.lastOrderValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastOrderValidation.crdfd_saleorderdetailid,
              cr1bb_giatriexuat: document.getElementById("vatOption").value,
              crdfd_nguoiduyet: approversText,
            });
            break;
            
          case 283640003: // VAT BOD
            // Sử dụng kết quả validation đã lưu
            if (!window.lastBuyOrderValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastBuyOrderValidation.crdfd_buyorderdetailsid,
              cr1bb_giatriexuat: document.getElementById("vatOption").value,
              crdfd_nguoiduyet: approversText,
            });
            break;
            
          case 283640001: // VAT SO
            // Sử dụng kết quả validation đã lưu
            if (!window.lastSaleOrderValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastSaleOrderValidation.crdfd_sale_orderid,
              cr1bb_giatriexuat: document.getElementById("vatOption").value,
              crdfd_nguoiduyet: approversText,
            });
            break;
            
          case 283640006: // VAT BO
            // Sử dụng kết quả validation đã lưu
            if (!window.lastBuyOrderMainValidation) {
              showNotification('Vui lòng nhập và kiểm tra mã đơn hàng hợp lệ!', 'error');
              return;
            }
            
            Object.assign(newTicket, {
              crdfd_maonhangchitiet: window.lastBuyOrderMainValidation.crdfd_buyordersid,
              cr1bb_giatriexuat: document.getElementById("vatOption").value,
              crdfd_nguoiduyet: approversText,
            });
            break;

          default:
            console.warn(
              "❌ Case không hợp lệ:",
              document.getElementById("ticketCategory").value
            );
            break;
        }

        // Convert all numeric values to strings to avoid OData conversion errors
        Object.keys(newTicket).forEach(key => {
          if (typeof newTicket[key] === 'number') {
            newTicket[key] = newTicket[key].toString();
          }
        });
        
        //console.log("newTicket:", newTicket);

        // Validation dữ liệu trước khi gửi
        const validationErrors = [];
        
        if (!newTicket.crdfd_nguoiyeucau) {
          validationErrors.push('Thiếu thông tin người yêu cầu');
        }
        
        if (!newTicket.crdfd_lydoieuchinh || newTicket.crdfd_lydoieuchinh.trim() === '') {
          validationErrors.push('Thiếu mô tả chi tiết');
        }
        
        if (!newTicket.crdfd_loaiieuchinh) {
          validationErrors.push('Thiếu loại yêu cầu');
        }
        
        if (!newTicket.cr1bb_thongtinyeucau || newTicket.cr1bb_thongtinyeucau.trim() === '') {
          validationErrors.push('Thiếu thông tin yêu cầu');
        }
        
        if (!newTicket.cr1bb_phongban || newTicket.cr1bb_phongban.trim() === '') {
          validationErrors.push('Thiếu thông tin phòng ban');
        }
        
        if (validationErrors.length > 0) {
          console.error('❌ Validation errors:', validationErrors);
          showNotification(`Dữ liệu không hợp lệ: ${validationErrors.join(', ')}`, 'error');
          return;
        }

        try {
          const cachedToken = await getToken();
          const response = await fetch(
            `${DATAVERSE_URL}/crdfd_suport_systems`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${cachedToken}`,
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(newTicket),
            }
          );

          if (!response.ok) {
            // Lấy chi tiết lỗi từ response
            let errorDetails = '';
            let rawErrorText = '';
            
            try {
              rawErrorText = await response.text();
              //console.log('📋 Raw error response:', rawErrorText);
              
              if (rawErrorText) {
                try {
                  const errorData = JSON.parse(rawErrorText);
                  errorDetails = errorData.error?.message || errorData.message || rawErrorText;
                } catch (jsonError) {
                  // Nếu không parse được JSON, sử dụng raw text
                  errorDetails = rawErrorText;
                }
              }
            } catch (textError) {
              console.error('❌ Không thể đọc error response:', textError);
              errorDetails = 'Không thể đọc chi tiết lỗi';
            }
            
            // Log chi tiết để debug
            console.error('❌ Lỗi tạo ticket:', {
              status: response.status,
              statusText: response.statusText,
              url: response.url,
              headers: Object.fromEntries(response.headers.entries()),
              rawErrorText: rawErrorText,
              errorDetails: errorDetails,
              requestData: newTicket
            });
            
            throw new Error(
              `Lỗi ${response.status}: ${response.statusText || 'Bad Request'}${errorDetails ? ` - ${errorDetails}` : ''}`
            );
          }

          // Chỉ parse JSON nếu response có content
          let createdRecord = null;
          const text = await response.text();
          if (text) {
            createdRecord = JSON.parse(text);
            //console.log("Ticket đã tạo trên Dataverse:", createdRecord);
          } else {
            //console.log("Ticket đã tạo trên Dataverse, nhưng không có dữ liệu trả về.");
          }

          document.getElementById("newTicketForm").reset();
          resetTicketModal(); // Reset validation icons và data
          showNotification(
            "Ticket đã được tạo thành công trên Dataverse!",
            "success"
          );
          document.querySelector('a[href="#tickets"]').click();
          await refreshData(); // render lại dữ liệu titkets
          document.getElementById("new-ticket").classList.add("hidden");
        } catch (err) {
          console.error(err);
          showNotification("Tạo ticket thất bại: " + err.message, "error");
        }
      }

      // Modal functions
      function initializeModals() {
        const ticketModal = document.getElementById("ticketModal");
        const closeTicketModal = document.getElementById("closeTicketModal");
        const approvalModal = document.getElementById("approvalModal");
        const closeApprovalModal =
          document.getElementById("closeApprovalModal");

        closeTicketModal.addEventListener("click", () =>
          ticketModal.classList.add("hidden")
        );
        closeApprovalModal.addEventListener("click", () =>
          approvalModal.classList.add("hidden")
        );

        ticketModal.addEventListener("click", (e) => {
          if (e.target === ticketModal) ticketModal.classList.add("hidden");
        });

        approvalModal.addEventListener("click", (e) => {
          if (e.target === approvalModal) approvalModal.classList.add("hidden");
        });

        document
          .getElementById("approveTicket")
          .addEventListener("click", approveCurrentTicket);
        document
          .getElementById("rejectTicket")
          .addEventListener("click", rejectCurrentTicket);
      }

      let currentApprovalTicket = null;

      function openApprovalModal(ticketId) {
        const ticket = tickets.find((t) => t.id === ticketId);
        if (!ticket) return;

        currentApprovalTicket = ticket;
        const approvalModal = document.getElementById("approvalModal");
        const approvalTicketInfo =
          document.getElementById("approvalTicketInfo");

        approvalTicketInfo.innerHTML = `
                <div class="bg-white shadow-md rounded-2xl p-5 border border-gray-200">
  <!-- Tiêu đề -->
  <h4 class="text-lg font-bold text-gray-900 mb-2">
    ${ticket.name}
  </h4>
   
  <!-- Grid thông tin -->
  <div class="grid grid-cols-2 gap-y-3 gap-x-6 text-sm text-gray-700">
    <div>
      <span class="font-medium text-gray-800">Loại:</span>
      <span class="ml-1">${getCategoryText(ticket.category)}</span>
    </div>
    
    <div>
      <span class="font-medium text-gray-800">Người yêu cầu:</span>
      <span class="ml-1 inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-700">
        ${getUserNameByEmail(ticket.createdBy)}
      </span>
    </div>
    
    <div>
      <span class="font-medium text-gray-800">Giá trị đề xuất:</span>
      <span class="ml-1 text-green-600 font-semibold">
        ${formatGiaTriDeXuat(ticket.giaTriDeXuat, ticket.category)}
      </span>
    </div>
    
    <div>
      <span class="font-medium text-gray-800">Ngày tạo:</span>
      <span class="ml-1 text-gray-500">
        ${formatDate(ticket.createdAt)}
      </span>
    </div>
     <!-- Mô tả -->
  <p class="text-sm text-gray-600 mb-4 leading-relaxed">
    ${ticket.description}
  </p>
  </div>
</div>

            `;

        approvalModal.classList.remove("hidden");
      }

      //=========== User Approval ===========
      async function approveCurrentTicket() {
        if (!currentApprovalTicket) return;

        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser || !currentUser.idU) {
            throw new Error("Không tìm thấy user login");
          }

          // update lên Dataverse
          const updated = await updateTicketStatus(
            currentApprovalTicket.id,
            283640001,
            currentUser.idU
          );
          document.getElementById("approvalModal").classList.add("hidden");
          if (updated) {
            showNotification("Ticket đã được phê duyệt!", "success");
          } else {
            showNotification(
              "User này không có record approval để phê duyệt.",
              "info"
            );
          }

          // refresh lại từ server
          await refreshData();
          loadApprovals();
          loadDashboard();
        } catch (err) {
          showNotification("Phê duyệt thất bại: " + err.message, "error");
        }
      }

      async function rejectCurrentTicket() {
        if (!currentApprovalTicket) return;

        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser || !currentUser.idU) {
            throw new Error("Không tìm thấy user login");
          }

          const updated = await updateTicketStatus(
            currentApprovalTicket.id,
            283640002,
            currentUser.idU // 👈 email của user login
          );

          document.getElementById("approvalModal").classList.add("hidden");
          if (updated) {
            showNotification("Ticket đã bị từ chối!", "error");
          } else {
            showNotification(
              "User này không có record approval để phê duyệt.",
              "info"
            );
          }

          await refreshData();
          loadApprovals();
          loadDashboard();
        } catch (err) {
          showNotification("Từ chối thất bại: " + err.message, "error");
        }
      }

      // Hàm xử lý click vào hàng ticket
      function handleTicketRowClick(ticketId, status) {
        // Nếu trạng thái là chờ phê duyệt (191920002), mở popup approval
        if (status === 191920002) {
          openApprovalModal(ticketId);
        } else {
          // Các trạng thái khác, mở popup xem chi tiết
          viewTicket(ticketId);
        }
      }

      function viewTicket(ticketId) {
        const ticket = tickets.find((t) => t.id === ticketId);
        if (!ticket) return;
        const ticketModal = document.getElementById("ticketModal");
        const ticketModalContent =
          document.getElementById("ticketModalContent");

        ticketModalContent.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-xl font-semibold text-gray-800 mb-2">${
                          ticket.name
                        }</h4>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>Người yêu cầu: </span>
                            <span>${getUserNameByEmail(ticket.createdBy)}</span>
                            <span>Ngày tạo: </span>
                            <span>${formatDate(ticket.createdAt)}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">Trạng thái</h5>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(
                              ticket.status
                            )}">
                                ${getStatusText(ticket.status)}
                            </span>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">Loại</h5>
                            <span class="text-sm text-gray-600">${getCategoryText(
                              ticket.category
                            )}</span>
                        </div>

                           <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-2">Giá trị đề xuất</h5>
                           <span class="text-sm text-gray-600">
                              ${formatGiaTriDeXuat(ticket.giaTriDeXuat, ticket.category)}
                           </span>
                        </div>
                    </div>
                  <div>
  <h5 class="font-medium text-gray-800 mb-2">Mô tả</h5>
  <p class="text-gray-600">${ticket.description}</p>

  ${
    ticket.notes
      ? `<h5 class="font-medium text-gray-800 mt-4 mb-2">Ghi chú</h5>
         <ul class="space-y-2 list-disc list-inside text-gray-700 bg-gray-50 p-3 rounded-lg border border-gray-200">
           ${ticket.notes
             .split("\n")
             .map((line) => `<li class="pl-1">${line}</li>`)
             .join("")}
         </ul>`
      : ""
  }
</div>
                </div>
            `;

        ticketModal.classList.remove("hidden");
      }

      // Notifications
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
          type === "success"
            ? "bg-green-500 text-white"
            : type === "error"
            ? "bg-red-500 text-white"
            : "bg-blue-500 text-white"
        }`;

        notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <i class="fas ${
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : "fa-info-circle"
        }"></i>
        <span>${message}</span>
      </div>
    `;

        document.body.appendChild(notification);

        setTimeout(
          () => notification.classList.remove("translate-x-full"),
          100
        );
        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Utility functions
      function getStatusClass(status) {
        switch (status) {
          case 191920002:
            return "status-pending text-white";
          case 191920000:
            return "status-approved text-white";
          case 191920001:
            return "status-rejected text-white";
          case "in-progress":
            return "status-in-progress text-white";
          case "completed":
            return "status-completed text-white";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case 191920002:
            return "Chờ phê duyệt";
          case 191920000:
            return "Đã phê duyệt";
          case 191920001:
            return "Từ chối";
          case "in-progress":
            return "Đang xử lý";
          case "completed":
            return "Hoàn thành";
          default:
            return "Không xác định";
        }
      }

      function getPriorityClass(priority) {
        switch (priority) {
          case "low":
            return "bg-gray-100 text-gray-800";
          case "medium":
            return "bg-yellow-100 text-yellow-800";
          case "high":
            return "bg-orange-100 text-orange-800";
          case "urgent":
            return "bg-red-100 text-red-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      function getPriorityText(priority) {
        switch (priority) {
          case "low":
            return "Thấp";
          case "medium":
            return "Trung bình";
          case "high":
            return "Cao";
          case "urgent":
            return "Khẩn cấp";
          default:
            return "Không xác định";
        }
      }

      function getCategoryText(category) {
        switch (category) {
          case 191920000:
            return "Điều chỉnh giá SOD";
          case 191920001:
            return "Điều chỉnh VAT SOD";
          case 283640001:
            return "Điều chỉnh VAT SO";
          case 283640002:
            return "Điều chỉnh giá BOD";
          case 283640003:
            return "Điều chỉnh VAT BOD";
          case 283640004:
            return "Hủy phiếu nhập kho";
          case 283640005:
            return "Điều chỉnh phiếu nhập kho";
          case 283640006:
            return "Điều chỉnh VAT BO";
          case 283640007:
            return "Điều chỉnh định lượng";
          case 283640008:
            return "Hủy phiếu xuất kho";
          case 283640009:
            return "Điều chỉnh phiếu xuất kho";
          default:
            return "Không xác định";
        }
      }

      function formatGiaTriDeXuat(giaTriDeXuat, category) {
        if (!giaTriDeXuat || giaTriDeXuat === "Chưa xác định") {
          return giaTriDeXuat;
        }
        
        // For cases that use quantity format (order|warehouse)
        const quantityCases = [283640005, 283640009];
        
        if (quantityCases.includes(parseInt(category)) && giaTriDeXuat.includes('|')) {
          const [orderQty, warehouseQty] = giaTriDeXuat.split('|');
          return `Số lượng theo đơn: ${orderQty} - Số lượng theo kho: ${warehouseQty}`;
        }
        
        return giaTriDeXuat;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) {
          return "Vừa xong";
        } else if (diffInSeconds < 3600) {
          const minutes = Math.floor(diffInSeconds / 60);
          return `${minutes} phút trước`;
        } else if (diffInSeconds < 86400) {
          const hours = Math.floor(diffInSeconds / 3600);
          return `${hours} giờ trước`;
        } else if (diffInSeconds < 2592000) {
          const days = Math.floor(diffInSeconds / 86400);
          return `${days} ngày trước`;
        } else {
          return date.toLocaleDateString("vi-VN", {
            month: "2-digit",
            day: "2-digit",
          });
        }
      }

      async function getAllXseptions(token, query, callback) {
        let url = DATAVERSE_URL + query;
        let allData = [];
        let page = 1;

        while (url) {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          allData = allData.concat(data.value);

          page++;

          url = data["@odata.nextLink"] || null;
        }
        if (typeof callback === "function") {
          return callback(allData);
        }
        return allData; // <-- quan trọng
      }

      function mappingListTickets(allData) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const email = currentUser?.idU;

        let filteredData = [];
        // console.log("Current user email:", email);
        // console.log("All data count:", allData.length);
        if (email == "admin") {
          // 🔹 Admin → thấy tất cả records
          filteredData = allData;
          // console.log("Admin user - all records visible");
        } else {
          // 🔹 User thường → chỉ thấy ticket liên quan
          filteredData = allData.filter((item) => {
            // 1️⃣ Người yêu cầu luôn thấy
            if (item.crdfd_nguoiyeucau === email) return true;

            // 2️⃣ Nếu có approvals expand từ server
            if (
              item.crdfd_support_system_approval_Masuport_crdfd_suport_system
            ) {
              const pendingApproval =
                item.crdfd_support_system_approval_Masuport_crdfd_suport_system.find(
                  (a) =>
                    a.crdfd_nguoixacnhan === email &&
                    a.cr1bb_trang_thai !== 283640001 &&
                    a.cr1bb_trang_thai !== 283640002
                );
              return !!pendingApproval;
            }

            return false;
          });
        }

        supportSystemsData = filteredData.map((item) => {
          const approvals =
            item.crdfd_support_system_approval_Masuport_crdfd_suport_system ||
            [];
          let notes = "";

          if (email === "admin" || item.crdfd_nguoiyeucau === email) {
            // 🔹 Admin hoặc người yêu cầu → gom tất cả note
            notes = approvals
              .filter((a) => a.cr1bb_ghichu)
              .map((a) => {
                const approver = approversData.find(
                  (u) => u.idU === a.crdfd_nguoixacnhan
                );
                const approverName = approver
                  ? approver.useName
                  : a.crdfd_nguoixacnhan;
                return `${approverName}: ${a.cr1bb_ghichu}`;
              })
              .join("\n");
          } else {
            // 🔹 Approver → chỉ lấy note của mình
            const myApproval = approvals.find(
              (a) => a.crdfd_nguoixacnhan === email
            );
            if (myApproval?.cr1bb_ghichu) {
              const approver = approversData.find(
                (u) => u.idU === myApproval.crdfd_nguoixacnhan
              );
              const approverName = approver
                ? approver.useName
                : myApproval.crdfd_nguoixacnhan;
              notes = `${approverName}: ${myApproval.cr1bb_ghichu}`;
            }
          }

          return {
            id: item.crdfd_suport_systemid || "",
            title: item.cr1bb_thongtinyeucau || "Không có tiêu đề",
            description: item.crdfd_lydoieuchinh || "Không có mô tả",
            category: item.crdfd_loaiieuchinh || "other",
            priority: "medium",
            status: item.crdfd_trangthai || "Chưa xác định",
            createdBy: item.crdfd_nguoiyeucau || "Ẩn danh",
            createdAt: item.createdon || "Chưa xác định",
            userTickets: item.crdfd_nguoiduyet || "Chưa xác định",
            name: item.crdfd_name || "",
            giaTriDeXuat: item.cr1bb_giatriexuat || "Chưa xác định",
            notes: notes,
          };
        });

        supportSystemsData.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );

        return supportSystemsData;
      }
      function mappingUser(allData) {
        approversData = allData.map((item, index) => ({
          idU: item.cr1bb_emailcal || "Không xác định",
          useName: item.crdfd_name || "Không xác định",
          phongban: item.crdfd_phongbantext || "Không xác định",
          password: "wecare123@",
        }));
        return approversData;
      }

      function mappingSOD(allData) {
        ordersDetailData = allData.map((item, index) => ({
          idSOD: item.crdfd_saleorderdetailid || "Không xác định",
          sodName: item.crdfd_name || "Không xác định",
        }));
        return ordersDetailData;
      }

      function mappingUnits(dataUnits) {
        units = dataUnits.map((item) => ({
          unitID: item.crdfd_unitsid || "",
          unitName: item.crdfd_name || "Không xác định",
        }));
        return units;
      }

      function renderUnitsDropdown(units) {
        const dropdown = document.getElementById("unitsDropdown");
        if (!dropdown) return;

        // Luôn khởi tạo lại Choices khi select bị thay mới
        if (unitChoices) {
          unitChoices.destroy(); // hủy instance cũ
          unitChoices = null;
        }

        unitChoices = new Choices(dropdown, {
          removeItemButton: false,
          searchEnabled: true,
          searchResultLimit: 10,
          placeholderValue: "Chọn đơn vị",
          noResultsText: "Không tìm thấy",
          shouldSort: false,
        });

        unitChoices.setChoices(
          units.map((u) => ({
            value: u.unitId || u.unitName,
            label: u.unitName,
            selected: false,
            disabled: false,
          })),
          "value",
          "label",
          false
        );
      }

      function onCategoryChange(category) {
        const container = document.getElementById("dynamicFields");
        container.innerHTML = ""; // reset

        switch (parseInt(category)) {
          // ==== Điều chỉnh giá SOD ====
          case 191920000: // Điều chỉnh giá SOD
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng chi tiết..." required>
              <div id="orderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="orderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="orderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="orderInvalidIcon"></i>
              </div>
            </div>
            <div id="orderValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Giá trị điều chỉnh</label>
            <input type="number" id="priceSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập giá trị mới" required>
          </div>
        </div>
      `;
            // Thêm event listener cho validation real-time SOD
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideOrderValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateOrderCodeRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            
            // Hiện lại trường người duyệt cho điều chỉnh giá SOD
            setTimeout(() => {
              const approverField = document.querySelector('#ticketApprover');
              const approverContainer = approverField ? approverField.parentElement : null;
              if (approverContainer) {
                approverContainer.style.display = 'block';
              }
            }, 50);
            break;
            
          // ==== Điều chỉnh giá BOD ====
          case 283640002: // Điều chỉnh giá BOD
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng chi tiết..." required>
              <div id="buyOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="buyOrderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="buyOrderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="buyOrderInvalidIcon"></i>
              </div>
            </div>
            <div id="buyOrderValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Giá trị điều chỉnh</label>
            <input type="number" id="priceSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập giá trị mới" required>
          </div>
        </div>
      `;
            // Thêm event listener cho validation real-time BOD
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideBuyOrderValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateBuyOrderCodeRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            break;
          // ==== Hủy phiếu nhập kho ====
          case 283640004: // Hủy phiếu nhập kho
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng *</label>
            <div class="relative">
              <input type="text" id="IDMaDonHang" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="importOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="importOrderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="importOrderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="importOrderInvalidIcon"></i>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã phiếu nhập *</label>
            <div class="relative">
              <input type="text" id="IDPhieuHuy" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã phiếu nhập..." required>
              <div id="importSlipValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="importSlipLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="importSlipValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="importSlipInvalidIcon"></i>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label id="cancelImportQuantityLabel" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Số lượng *</label>
          <div class="relative">
            <input type="number" step="any" id="numberPhieuHuy" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập số lượng cần hủy theo kho..." required>
            <div id="importQuantityValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
              <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="importQuantityLoadingIcon"></i>
              <i class="fas fa-check-circle text-green-500 hidden" id="importQuantityValidIcon"></i>
              <i class="fas fa-times-circle text-red-500 hidden" id="importQuantityInvalidIcon"></i>
            </div>
          </div>
          <div id="stockWarning" class="mt-2 text-sm text-red-600 hidden">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="stockWarningText"></span>
          </div>
        </div>
      `;
            
            // Thêm event listener cho kiểm tra tồn kho khi user nhập số lượng hủy
              setTimeout(() => {
                const numberPhieuHuyInput = document.getElementById('numberPhieuHuy');
                const IDPhieuHuyInput = document.getElementById('IDPhieuHuy');
                const IDMaDonHangInput = document.getElementById('IDMaDonHang');
                const submitTicketBtn = document.getElementById('submitTicket');
                
                if (numberPhieuHuyInput && IDPhieuHuyInput && IDMaDonHangInput) {
                  // Reset nút về trạng thái ban đầu khi user thay đổi input
                  const resetSubmitButton = () => {
                    // Ẩn warning khi user thay đổi input
                    const stockWarning = document.getElementById('stockWarning');
                    if (stockWarning) {
                      stockWarning.classList.add('hidden');
                    }
                    // Ẩn tất cả validation icons
                    hideImportOrderValidation();
                    hideImportSlipValidation();
                    hideImportQuantityValidation();
                    // Clear transaction data khi user thay đổi input
                    window.lastTransactionData = null;
                    // Gọi function kiểm tra trạng thái nút submit
                    checkSubmitButtonState();
                  };
                  
                  // Reset khi user thay đổi bất kỳ field nào
                  numberPhieuHuyInput.addEventListener('input', resetSubmitButton);
                  IDPhieuHuyInput.addEventListener('input', resetSubmitButton);
                  IDMaDonHangInput.addEventListener('input', resetSubmitButton);
                  
                  // Trigger validation khi user blur khỏi số lượng (field cuối cùng)
                  numberPhieuHuyInput.addEventListener('blur', async () => {
                    const soLuongHuy = parseFloat(numberPhieuHuyInput.value);
                    const maPhieu = IDPhieuHuyInput.value.trim();
                    const maDonHang = IDMaDonHangInput.value.trim();
                    
                    if (soLuongHuy > 0 && maPhieu && maDonHang && parseInt(category) === 283640004) {
                      await checkInventoryStock(maPhieu, soLuongHuy, 'huy_phieu_nhap');
                    }
                  });
                  
                  // Hàm chung để kiểm tra khi có đủ thông tin
                  const validateCancelImport = async () => {
                    const soLuongHuy = parseFloat(numberPhieuHuyInput.value);
                    const maPhieu = IDPhieuHuyInput.value.trim();
                    const maDonHang = IDMaDonHangInput.value.trim();
                    
                    // Kiểm tra unit info khi có đủ thông tin mã đơn hàng và mã phiếu
                    if (maPhieu && maDonHang) {
                      await checkCancelImportTransaction(maDonHang, maPhieu);
                    }
                    
                    if (soLuongHuy > 0 && maPhieu && maDonHang && parseInt(category) === 283640004) {
                      await checkInventoryStock(maPhieu, soLuongHuy, 'huy_phieu_nhap');
                    }
                  };
                  
                  // Thêm event listener cho input để tự động gọi API khi nhập đủ thông tin
                  IDPhieuHuyInput.addEventListener('input', () => {
                    const maPhieu = IDPhieuHuyInput.value.trim();
                    const maDonHang = IDMaDonHangInput.value.trim();
                    if (maPhieu && maDonHang) {
                      validateCancelImport();
                    }
                  });
                  
                  IDMaDonHangInput.addEventListener('input', () => {
                    const maPhieu = IDPhieuHuyInput.value.trim();
                    const maDonHang = IDMaDonHangInput.value.trim();
                    if (maPhieu && maDonHang) {
                      validateCancelImport();
                    }
                  });
                  
                  // Giữ lại event blur để đảm bảo hoạt động như cũ
                  IDPhieuHuyInput.addEventListener('blur', validateCancelImport);
                  IDMaDonHangInput.addEventListener('blur', validateCancelImport);
                }
              }, 100);
            break;
            
          // ==== Hủy phiếu xuất kho ====
          case 283640008: // Hủy phiếu xuất kho
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng *</label>
            <div class="relative">
              <input type="text" id="IDMaDonHangXuat" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="exportOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="exportOrderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="exportOrderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="exportOrderInvalidIcon"></i>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã phiếu xuất *</label>
            <div class="relative">
              <input type="text" id="IDPhieuXuat" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã phiếu xuất..." required>
              <div id="exportSlipValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="exportSlipLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="exportSlipValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="exportSlipInvalidIcon"></i>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2" id="cancelExportQuantityLabel">Số lượng *</label>
          <div class="relative">
            <input type="number" step="any" id="numberPhieuXuat" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập số lượng cần hủy theo kho..." required>
            <div id="exportQuantityValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
              <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="exportQuantityLoadingIcon"></i>
              <i class="fas fa-check-circle text-green-500 hidden" id="exportQuantityValidIcon"></i>
              <i class="fas fa-times-circle text-red-500 hidden" id="exportQuantityInvalidIcon"></i>
            </div>
          </div>
          <div id="exportStockWarning" class="mt-2 text-sm text-red-600 hidden">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="exportStockWarningText"></span>
          </div>
        </div>
      `;
            
            // Thêm event listener cho kiểm tra tồn kho khi user nhập số lượng hủy
            setTimeout(() => {
              const numberPhieuXuatInput = document.getElementById('numberPhieuXuat');
              const IDPhieuXuatInput = document.getElementById('IDPhieuXuat');
              const IDMaDonHangXuatInput = document.getElementById('IDMaDonHangXuat');
              const submitTicketBtn = document.getElementById('submitTicket');
              
              if (numberPhieuXuatInput && IDPhieuXuatInput && IDMaDonHangXuatInput) {
                // Reset nút về trạng thái ban đầu khi user thay đổi input
                const resetExportSubmitButton = () => {
                  // Ẩn warning khi user thay đổi input
                  const exportStockWarning = document.getElementById('exportStockWarning');
                  const exportStockWarningText = document.getElementById('exportStockWarningText');
                  if (exportStockWarning) {
                    exportStockWarning.classList.add('hidden');
                    // Reset về trạng thái ban đầu - xóa tất cả class màu
                    exportStockWarning.classList.remove('text-green-600', 'text-red-600');
                  }
                  if (exportStockWarningText) {
                    // Clear nội dung text cũ
                    exportStockWarningText.textContent = '';
                  }
                  // Ẩn tất cả validation icons
                  hideExportOrderValidation();
                  hideExportSlipValidation();
                  hideExportQuantityValidation();
                  
                  // Reset unit label về giá trị mặc định
                  const cancelExportQuantityLabel = document.getElementById('cancelExportQuantityLabel');
                  if (cancelExportQuantityLabel) {
                    cancelExportQuantityLabel.textContent = 'Số lượng *';
                  }
                  
                  // Clear transaction data khi user thay đổi input
                  window.lastExportTransactionData = null;
                  // Gọi function kiểm tra trạng thái nút submit
                  checkSubmitButtonState();
                };

                // Debounce function để tránh call API quá nhiều cho cancel export
                let cancelExportValidationTimeout;
                const debouncedValidateCancelExport = () => {
                  clearTimeout(cancelExportValidationTimeout);
                  cancelExportValidationTimeout = setTimeout(async () => {
                    const maDonHang = IDMaDonHangXuatInput.value.trim();
                    const maPhieu = IDPhieuXuatInput.value.trim();
                    
                    // Chỉ call API khi cả hai field đều có dữ liệu
                    if (maDonHang && maPhieu) {
                      await checkCancelExportTransaction(maDonHang, maPhieu);
                    }
                  }, 500); // Đợi 500ms sau khi user ngừng nhập
                };
                
                // Reset khi user thay đổi bất kỳ field nào
                numberPhieuXuatInput.addEventListener('input', resetExportSubmitButton);
                IDPhieuXuatInput.addEventListener('input', () => {
                  resetExportSubmitButton();
                  debouncedValidateCancelExport();
                });
                IDMaDonHangXuatInput.addEventListener('input', () => {
                  resetExportSubmitButton();
                  debouncedValidateCancelExport();
                });
                
                // Trigger validation khi user blur khỏi số lượng (field cuối cùng)
                numberPhieuXuatInput.addEventListener('blur', async () => {
                  const soLuongHuy = parseFloat(numberPhieuXuatInput.value);
                  const maPhieu = IDPhieuXuatInput.value.trim();
                  const maDonHang = IDMaDonHangXuatInput.value.trim();
                  
                  if (soLuongHuy > 0 && maPhieu && maDonHang) {
                    await checkExportStock(maPhieu, soLuongHuy, 'huy_phieu_xuat');
                  }
                });
                
                // Trigger validation khi user blur khỏi mã phiếu xuất
                IDPhieuXuatInput.addEventListener('blur', async () => {
                  const soLuongHuy = parseFloat(numberPhieuXuatInput.value);
                  const maPhieu = IDPhieuXuatInput.value.trim();
                  const maDonHang = IDMaDonHangXuatInput.value.trim();
                  
                  if (soLuongHuy > 0 && maPhieu && maDonHang) {
                    await checkExportStock(maPhieu, soLuongHuy, 'huy_phieu_xuat');
                  }
                });
                
                // Trigger validation khi user blur khỏi mã đơn hàng
                IDMaDonHangXuatInput.addEventListener('blur', async () => {
                  const soLuongHuy = parseFloat(numberPhieuXuatInput.value);
                  const maPhieu = IDPhieuXuatInput.value.trim();
                  const maDonHang = IDMaDonHangXuatInput.value.trim();
                  
                  if (soLuongHuy > 0 && maPhieu && maDonHang) {
                    await checkExportStock(maPhieu, soLuongHuy, 'huy_phieu_xuat');
                  }
                });
              }
            }, 100);
            break;
            
          // ==== Điều chỉnh định lượng ====
          case 283640007:
            container.innerHTML = `
    <div>
      <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Sản phẩm *</label>
      <div class="relative">
        <input type="text" id="productCode" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã sản phẩm" required>
        <div id="productValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
          <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="productLoadingIcon"></i>
          <i class="fas fa-check-circle text-green-500 hidden" id="productValidIcon"></i>
          <i class="fas fa-times-circle text-red-500 hidden" id="productInvalidIcon"></i>
        </div>
      </div>
    </div>
    
<div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6 mt-3 lg:mt-4">
  <div>
    <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Đơn vị *</label>
    <div class="relative">
      <select id="unitsDropdown" name="unitsDropdown" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" required>
 
      </select>
      <div id="unitValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
        <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="unitLoadingIcon"></i>
        <i class="fas fa-check-circle text-green-500 hidden" id="unitValidIcon"></i>
        <i class="fas fa-times-circle text-red-500 hidden" id="unitInvalidIcon"></i>
      </div>
    </div>
  </div>
  <div>
    <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Giá trị *</label>
    <input type="number" id="dieuchinhdinhluong" step="0.01" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập giá trị điều chỉnh" required>
  </div>
</div>
<div id="unitConversionWarning" class="mt-2 text-sm text-red-600 hidden">
  <i class="fas fa-exclamation-triangle mr-1"></i>
  <span id="unitConversionWarningText"></span>
</div>
  `;
            renderUnitsDropdown(units);
            
            // Set default system approver for quantity adjustment
            setTimeout(() => {
              const approverSelect = document.getElementById("ticketApprover");
              if (approverSelect && approverChoices) {
                // Clear existing choices
                approverChoices.clearChoices();
                
                // Set system as default approver
                const systemApprover = {
                  value: "admin",
                  label: "Admin WC (Hệ thống)"
                };
                
                approverChoices.setChoices([systemApprover], "value", "label", false);
                approverChoices.setChoiceByValue("admin");
              }
            }, 50);
            
            // Thêm event listeners cho validation
            setTimeout(() => {
              const productCodeInput = document.getElementById('productCode');
              const unitsDropdownInput = document.getElementById('unitsDropdown');
              
              if (productCodeInput && unitsDropdownInput) {
                // Reset validation khi user thay đổi input
                const resetUnitConversionValidation = () => {
                  hideProductValidation();
                  hideUnitValidation();
                  const warning = document.getElementById('unitConversionWarning');
                  if (warning) {
                    warning.classList.add('hidden');
                  }
                  window.lastUnitConversionData = null;
                };
                
                productCodeInput.addEventListener('input', resetUnitConversionValidation);
                unitsDropdownInput.addEventListener('change', resetUnitConversionValidation);
                
                // Trigger validation chỉ khi user chọn đơn vị (tránh call API nhiều lần)
                unitsDropdownInput.addEventListener('change', async () => {
                  const productCode = productCodeInput.value.trim();
                  const unitValue = unitsDropdownInput.value;
                  
                  // Chỉ call API khi user đã chọn đơn vị và nhập sản phẩm
                  if (productCode && unitValue && unitValue !== '') {
                    await checkUnitConversion(productCode, unitValue);
                  }
                });
              }
            }, 100);
            break;

          // ==== Điều chỉnh phiếu phiếu xuất, nhập kho =====
          case 283640005: // điều chỉnh phiếu nhập kho
            container.innerHTML = `
    <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6 mt-3 lg:mt-4">
      <div>
        <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
        <div class="relative">
          <input type="text" id="maDonPhieuNhap" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập mã đơn hàng chi tiết..." required>
          <div id="adjustImportOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustImportOrderLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustImportOrderValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustImportOrderInvalidIcon"></i>
          </div>
        </div>
      </div>
      <div>
        <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã phiếu</label>
        <div class="relative">
          <input type="text" id="maPhieuNhap" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập mã phiếu..." required>
          <div id="adjustImportSlipValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustImportSlipLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustImportSlipValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustImportSlipInvalidIcon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6 mt-3 lg:mt-4">
      <div>
        <label id="adjustImportOrderQuantityLabel" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Số lượng theo đơn</label>
        <input type="number" id="numberNhapDon" 
          class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" 
          placeholder="Nhập số lượng"
          min="1" step="any" required>
      </div>
      <div>
        <label id="adjustImportQuantityLabel" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Số lượng theo kho *</label>
        <div class="relative">
          <input type="number" id="numberNhapKho" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập số lượng"
            min="1" step="any" required>
          <div id="adjustImportQuantityValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustImportQuantityLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustImportQuantityValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustImportQuantityInvalidIcon"></i>
          </div>
        </div>
      </div>
    </div>
    <div id="adjustImportWarning" class="mt-2 text-sm text-red-600 hidden">
      <i class="fas fa-exclamation-triangle mr-1"></i>
      <span id="adjustImportWarningText"></span>
    </div>
    `;
            
            // Thêm event listeners cho validation
            setTimeout(() => {
              const maDonPhieuNhapInput = document.getElementById('maDonPhieuNhap');
              const maPhieuNhapInput = document.getElementById('maPhieuNhap');
              const numberNhapKhoInput = document.getElementById('numberNhapKho');
              
              if (maDonPhieuNhapInput && maPhieuNhapInput && numberNhapKhoInput) {
                // Reset validation khi user thay đổi input
                const resetAdjustImportValidation = () => {
                  hideAdjustImportOrderValidation();
                  hideAdjustImportSlipValidation();
                  hideAdjustImportQuantityValidation();
                  const warning = document.getElementById('adjustImportWarning');
                  if (warning) {
                    warning.classList.add('hidden');
                  }
                  window.lastAdjustImportData = null;
                };
                
                maDonPhieuNhapInput.addEventListener('input', resetAdjustImportValidation);
                maPhieuNhapInput.addEventListener('input', resetAdjustImportValidation);
                numberNhapKhoInput.addEventListener('input', () => {
                  hideAdjustImportQuantityValidation();
                  const warning = document.getElementById('adjustImportWarning');
                  if (warning) {
                    warning.classList.add('hidden');
                  }
                });
                
                // Trigger validation khi user blur khỏi bất kỳ field nào hoặc khi nhập đủ thông tin
                let lastValidationData = { maDonHang: '', maPhieu: '' };
                let isValidating = false;
                
                const validateAdjustImport = async () => {
                  const maDonHang = maDonPhieuNhapInput.value.trim();
                  const maPhieu = maPhieuNhapInput.value.trim();
                  
                  // Chỉ call API khi cả hai field đều có dữ liệu
                  if (!maDonHang || !maPhieu) {
                    return;
                  }
                  
                  // Tránh duplicate calls với cùng dữ liệu
                  if (lastValidationData.maDonHang === maDonHang && 
                      lastValidationData.maPhieu === maPhieu) {
                    return;
                  }
                  
                  // Tránh multiple calls đồng thời
                  if (isValidating) {
                    return;
                  }
                  
                  isValidating = true;
                  lastValidationData = { maDonHang, maPhieu };
                  
                  try {
                    await checkAdjustImportTransactionForUnit(maDonHang, maPhieu);
                  } finally {
                    isValidating = false;
                  }
                };
                
                // Thêm event listener cho input để tự động gọi API khi nhập đủ thông tin
                maDonPhieuNhapInput.addEventListener('input', () => {
                  const maDonHang = maDonPhieuNhapInput.value.trim();
                  const maPhieu = maPhieuNhapInput.value.trim();
                  if (maDonHang && maPhieu) {
                    validateAdjustImport();
                  }
                });
                
                maPhieuNhapInput.addEventListener('input', () => {
                  const maDonHang = maDonPhieuNhapInput.value.trim();
                  const maPhieu = maPhieuNhapInput.value.trim();
                  if (maDonHang && maPhieu) {
                    validateAdjustImport();
                  }
                });
                
                // Giữ lại event blur để đảm bảo hoạt động như cũ
                maDonPhieuNhapInput.addEventListener('blur', validateAdjustImport);
                maPhieuNhapInput.addEventListener('blur', validateAdjustImport);
                
                // Trigger quantity validation khi user blur khỏi số lượng theo kho
                numberNhapKhoInput.addEventListener('blur', async () => {
                  const soLuongTheoKho = numberNhapKhoInput.value.trim();
                  
                  if (soLuongTheoKho && window.lastAdjustImportData) {
                    showAdjustImportQuantityValidationLoading();
                    await checkAdjustImportQuantity(soLuongTheoKho);
                  }
                });
              }
            }, 100);
            break;
            
          case 283640009: // điều chỉnh phiếu xuất kho
            container.innerHTML = `
    <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6 mt-3 lg:mt-4">
      <div>
        <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
        <div class="relative">
          <input type="text" id="maDonPhieuXuat" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập mã đơn hàng chi tiết..." required>
          <div id="adjustExportOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustExportOrderLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustExportOrderValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustExportOrderInvalidIcon"></i>
          </div>
        </div>
      </div>
      <div>
        <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã phiếu</label>
        <div class="relative">
          <input type="text" id="maPhieuXuat" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập mã phiếu..." required>
          <div id="adjustExportSlipValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustExportSlipLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustExportSlipValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustExportSlipInvalidIcon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6 mt-3 lg:mt-4">
      <div>
        <label id="adjustExportOrderQuantityLabel" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Số lượng theo đơn</label>
        <input type="number" id="numberXuatDon" 
          class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" 
          placeholder="Nhập số lượng"
          min="1" step="any" required>
      </div>
      <div>
        <label id="adjustExportQuantityLabel" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Số lượng theo kho</label>
        <div class="relative">
          <input type="number" id="numberXuatKho" 
            class="w-full px-2 lg:px-4 py-1.5 lg:py-2 pr-8 text-xs lg:text-base border rounded-lg" 
            placeholder="Nhập số lượng"
            min="1" step="any" required>
          <div id="adjustExportQuantityValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 hidden" id="adjustExportQuantityLoadingIcon"></i>
            <i class="fas fa-check-circle text-green-500 hidden" id="adjustExportQuantityValidIcon"></i>
            <i class="fas fa-times-circle text-red-500 hidden" id="adjustExportQuantityInvalidIcon"></i>
          </div>
        </div>
      </div>
    </div>
    <div id="adjustExportWarning" class="mt-2 text-sm text-red-600 hidden">
      <i class="fas fa-exclamation-triangle mr-1"></i>
      <span id="adjustExportWarningText"></span>
    </div>
    `;
            
            // Thêm event listeners cho validation
            setTimeout(() => {
              const maDonPhieuXuatInput = document.getElementById('maDonPhieuXuat');
              const maPhieuXuatInput = document.getElementById('maPhieuXuat');
              const numberXuatKhoInput = document.getElementById('numberXuatKho');
              
              if (maDonPhieuXuatInput && maPhieuXuatInput && numberXuatKhoInput) {
                // Reset validation khi user thay đổi input
                const resetAdjustExportValidation = () => {
                  hideAdjustExportOrderValidation();
                  hideAdjustExportSlipValidation();
                  hideAdjustExportQuantityValidation();
                  const warning = document.getElementById('adjustExportWarning');
                  if (warning) {
                    warning.classList.add('hidden');
                  }
                  
                  // Reset unit labels về giá trị mặc định
                  const adjustExportQuantityLabel = document.getElementById('adjustExportQuantityLabel');
                  const adjustExportOrderQuantityLabel = document.getElementById('adjustExportOrderQuantityLabel');
                  
                  if (adjustExportQuantityLabel) {
                    adjustExportQuantityLabel.textContent = 'Số lượng theo kho';
                  }
                  if (adjustExportOrderQuantityLabel) {
                    adjustExportOrderQuantityLabel.textContent = 'Số lượng theo đơn';
                  }
                  
                  window.lastAdjustExportData = null;
                };

                // Debounce function để tránh call API quá nhiều
                let validationTimeout;
                const debouncedValidateAdjustExport = () => {
                  clearTimeout(validationTimeout);
                  validationTimeout = setTimeout(async () => {
                    const maDonHang = maDonPhieuXuatInput.value.trim();
                    const maPhieu = maPhieuXuatInput.value.trim();
                    
                    // Chỉ call API khi cả hai field đều có dữ liệu
                    if (maDonHang && maPhieu) {
                      await validateAdjustExport();
                    }
                  }, 500); // Đợi 500ms sau khi user ngừng nhập
                };
                
                maDonPhieuXuatInput.addEventListener('input', () => {
                  resetAdjustExportValidation();
                  debouncedValidateAdjustExport();
                });
                maPhieuXuatInput.addEventListener('input', () => {
                  resetAdjustExportValidation();
                  debouncedValidateAdjustExport();
                });
                numberXuatKhoInput.addEventListener('input', () => {
                  hideAdjustExportQuantityValidation();
                  const warning = document.getElementById('adjustExportWarning');
                  if (warning) {
                    warning.classList.add('hidden');
                  }
                });
                
                // Trigger validation khi user blur khỏi bất kỳ field nào
                let lastValidationData = { maDonHang: '', maPhieu: '' };
                let isValidating = false;
                
                const validateAdjustExport = async () => {
                  const maDonHang = maDonPhieuXuatInput.value.trim();
                  const maPhieu = maPhieuXuatInput.value.trim();
                  
                  // Chỉ call API khi cả hai field đều có dữ liệu
                  if (!maDonHang || !maPhieu) {
                    return;
                  }
                  
                  // Tránh duplicate calls với cùng dữ liệu
                  if (lastValidationData.maDonHang === maDonHang && 
                      lastValidationData.maPhieu === maPhieu) {
                    return;
                  }
                  
                  // Tránh multiple calls đồng thời
                  if (isValidating) {
                    return;
                  }
                  
                  isValidating = true;
                  lastValidationData = { maDonHang, maPhieu };
                  
                  try {
                    await checkAdjustExportTransaction(maDonHang, maPhieu);
                  } finally {
                    isValidating = false;
                  }
                };
                
                maDonPhieuXuatInput.addEventListener('blur', validateAdjustExport);
                maPhieuXuatInput.addEventListener('blur', validateAdjustExport);
                
                // Trigger quantity validation khi user blur khỏi số lượng theo kho
                numberXuatKhoInput.addEventListener('blur', async () => {
                  const soLuongTheoKho = numberXuatKhoInput.value.trim();
                  
                  if (soLuongTheoKho) {
                    showAdjustExportQuantityValidationLoading();
                    await checkAdjustExportQuantity(soLuongTheoKho);
                  }
                });
              }
            }, 100);
            break;

          // ==== Điều chỉnh VAT ====
          case 191920001: // VAT SOD
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="orderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="orderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="orderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="orderInvalidIcon"></i>
              </div>
            </div>
            <div id="orderValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">VAT</label>
            <select id="vatOption" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" required>
              <option value="0%">0%</option>
              <option value="5%">5%</option>
              <option value="8%">8%</option>
              <option value="10%">10%</option>
            </select>
          </div>
        </div>
      `;
            // Thêm event listener cho validation real-time
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideOrderValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateOrderCodeRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            break;
            
          case 283640003: // VAT BOD
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="buyOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="buyOrderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="buyOrderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="buyOrderInvalidIcon"></i>
              </div>
            </div>
            <div id="buyOrderValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">VAT</label>
            <select id="vatOption" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" required>
              <option value="0%">0%</option>
              <option value="5%">5%</option>
              <option value="8%">8%</option>
              <option value="10%">10%</option>
            </select>
          </div>
        </div>
      `;
            // Thêm event listener cho validation real-time BOD
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideBuyOrderValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateBuyOrderCodeRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            break;
          case 283640001: // VAT SO
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="saleOrderValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="saleOrderLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="saleOrderValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="saleOrderInvalidIcon"></i>
              </div>
            </div>
            <div id="saleOrderValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">VAT</label>
            <select id="vatOption" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" required>
              <option value="Có VAT">Có VAT</option>
              <option value="Không VAT">Không VAT</option>
              <option value="0%">0%</option>
              <option value="5%">5%</option>
              <option value="8%">8%</option>
              <option value="10%">10%</option>
            </select>
          </div>
        </div>
      `;
            // Thêm event listener cho validation real-time SO
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideSaleOrderValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateSaleOrderRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            break;
            
          case 283640006: // VAT BO
            container.innerHTML = `
        <div class="responsive-grid responsive-grid-sm-2 gap-3 lg:gap-6">
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Mã đơn hàng</label>
            <div class="relative">
              <input type="text" id="maDonHangSodBod" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập mã đơn hàng..." required>
              <div id="buyOrderMainValidationStatus" class="absolute right-2 top-1/2 transform -translate-y-1/2 hidden">
                <i class="fas fa-spinner fa-spin text-blue-500" id="buyOrderMainLoadingIcon"></i>
                <i class="fas fa-check-circle text-green-500 hidden" id="buyOrderMainValidIcon"></i>
                <i class="fas fa-times-circle text-red-500 hidden" id="buyOrderMainInvalidIcon"></i>
              </div>
            </div>
            <div id="buyOrderMainValidationMessage" class="text-xs mt-1 hidden"></div>
          </div>
          <div>
            <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">VAT</label>
            <select id="vatOption" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" required>
              <option value="Có VAT">Có VAT</option>
              <option value="Không VAT">Không VAT</option>
              <option value="0%">0%</option>
              <option value="5%">5%</option>
              <option value="8%">8%</option>
              <option value="10%">10%</option>
            </select>
          </div>
        </div>
       `;
            // Thêm event listener cho validation real-time BO
            setTimeout(() => {
              const orderInput = document.getElementById('maDonHangSodBod');
              if (orderInput) {
                let validationTimeout;
                orderInput.addEventListener('input', (e) => {
                  clearTimeout(validationTimeout);
                  const orderCode = e.target.value.trim();
                  
                  if (orderCode.length < 3) {
                    hideBuyOrderMainValidation();
                    return;
                  }
                  
                  // Debounce validation call
                  validationTimeout = setTimeout(() => {
                    validateBuyOrderRealtime(orderCode);
                  }, 500);
                });
              }
            }, 100);
            break;

          default:
            container.innerHTML = `
        <div>
          <label class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">Thông tin thêm</label>
          <input type="text" id="extraInfo" class="w-full px-2 lg:px-4 py-1.5 lg:py-2 text-xs lg:text-base border rounded-lg" placeholder="Nhập thông tin..." required>
        </div>
       `;
            // Hiện lại trường người duyệt cho các category khác
            setTimeout(() => {
              const approverField = document.querySelector('#ticketApprover');
              const approverContainer = approverField ? approverField.parentElement : null;
              if (approverContainer) {
                approverContainer.style.display = 'block';
              }
            }, 50);
        }
        
        // Reset approver field to API list for all cases except quantity adjustment
        if (parseInt(category) !== 283640007) {
          console.log('Resetting approver for category:', category);
          setTimeout(() => {
            const approverSelect = document.getElementById("ticketApprover");
            if (approverSelect && approverChoices) {
              console.log('Clearing approver choices and resetting to API list');
              // Clear current selection and choices first
              approverChoices.clearStore();
              approverChoices.clearChoices();
              
              // Reset to full API list
              initApproverChoices();
            }
          }, 100);
        }
      }

      // function setup value chọn user duyệt
      function initApproverChoices() {
        const approverSelect = document.getElementById("ticketApprover");
        if (!approverSelect) return;

        // Nếu chưa có thì khởi tạo Choices
        if (!approverChoices) {
          approverChoices = new Choices(approverSelect, {
            removeItemButton: true,
            searchEnabled: true,
            searchResultLimit: 5,
            placeholderValue: "Chọn người duyệt",
            noResultsText: "Không tìm thấy",
            shouldSort: false,
          });
        } else {
          // Nếu đã init thì clear options cũ
          approverChoices.clearChoices();
        }

        // Set lại danh sách từ approversData
        const options = approversData.map((u) => ({
          value: u.idU,
          label: `${u.useName} (${u.phongban})`,
        }));

        approverChoices.setChoices(options, "value", "label", false);
      }

      // function setup value chọn phòng ban
      function loadDepartments() {
        const deptSelect = document.getElementById("ticketDepartment");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";
        
        if (isAdmin) {
          // Admin có thể chọn tất cả phòng ban
          const uniqueDepartments = [
            ...new Set(approversData.map((u) => u.phongban)),
          ];
          deptSelect.innerHTML = '<option value="">Chọn phòng ban</option>';
          uniqueDepartments.forEach((dept) => {
            const option = document.createElement("option");
            option.value = dept;
            option.textContent = dept;
            deptSelect.appendChild(option);
          });
          deptSelect.disabled = false; // Đảm bảo admin có thể chọn
        } else {
          // User thường chỉ có phòng ban của mình
          const userDepartment = currentUser?.phongban || "";
          deptSelect.innerHTML = `<option value="${userDepartment}">${userDepartment}</option>`;
          deptSelect.value = userDepartment;
          deptSelect.disabled = true; // Không cho phép thay đổi
          
          // Tự động load loại yêu cầu cho phòng ban của user
          onDepartmentChange(userDepartment);
        }
      }

      // function login
      function initUserMenu() {
        // ================================
        // 1. Lấy các phần tử trong DOM
        // ================================
        const btn = document.getElementById("userMenuBtn"); // Nút user menu (hiển thị avatar + tên)
        const dropdown = document.getElementById("userMenuDropdown"); // Menu thả xuống (Hồ sơ, Cài đặt, Đăng xuất/Đăng nhập)
        const loginModal = document.getElementById("loginModal"); // Modal đăng nhập
        const loginForm = document.getElementById("loginForm"); // Form đăng nhập
        const usernameInput = document.getElementById("username"); // Input tài khoản
        const passwordInput = document.getElementById("password"); // Input mật khẩu
        const userNameSpan = btn.querySelector("span.md\\:block"); // Span hiển thị tên user
        const links = dropdown.querySelectorAll("a"); // Các link trong dropdown
        const logoutLink = links[links.length - 1]; // Link cuối cùng = Login/Logout

        const closeLoginBtn = document.getElementById("closeLoginModal"); // Nút đóng modal (nếu có)
        const cancelLoginBtn = document.getElementById("cancelLogin"); // Nút hủy modal (nếu có)

        // ================================
        // 2. Lấy thông tin user hiện tại từ localStorage
        // ================================
        let currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || null;

        // ================================
        // 3. Hàm cập nhật giao diện menu theo trạng thái login
        // ================================
        function updateUI() {
          const avatarSpan = document.getElementById("userAvatar");

          if (currentUser) {
            userNameSpan.textContent = currentUser.useName;
            logoutLink.textContent = "Đăng xuất";

            // đổi avatar theo tên user
            const initials = getInitials(currentUser.useName);
            avatarSpan.textContent = initials;
            avatarSpan.className =
              "text-white text-sm font-medium rounded-full w-8 h-8 flex items-center justify-center " +
              getColorFromName(currentUser.useName);
          } else {
            userNameSpan.textContent = "Khách";
            logoutLink.textContent = "Đăng nhập";

            avatarSpan.textContent = "AD";
            avatarSpan.className =
              "text-white text-sm font-medium rounded-full w-8 h-8 flex items-center justify-center bg-gray-400";
          }
        }
        updateUI();

        // ================================
        // 4. Nếu chưa login thì bật modal ngay, ngược lại thì fetch data
        if (!currentUser) {
          loginModal.classList.remove("hidden");
        } else {
          // Đã có user trong localStorage → fetch lại dữ liệu ngay
          refreshData();
        }

        // ================================
        // 5. Sự kiện click vào nút user menu
        // ================================
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (currentUser) {
            // Nếu đã login → hiện/ẩn dropdown
            dropdown.classList.toggle("hidden");
          } else {
            // Nếu chưa login → bật modal login
            loginModal.classList.remove("hidden");
          }
        });

        // ================================
        // 6. Ẩn dropdown khi click ra ngoài
        // ================================
        document.addEventListener("click", (e) => {
          if (
            currentUser &&
            !btn.contains(e.target) &&
            !dropdown.contains(e.target)
          ) {
            dropdown.classList.add("hidden");
          }
        });

        // Ngăn việc click trong modal làm đóng modal
        loginModal.addEventListener("click", (e) => e.stopPropagation());

        // ================================
        // 7. Xử lý login
        // ================================
        const loginHandler = (e) => {
          e.preventDefault();
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();

          let found = null;

          // 7.1 Check trong danh sách Admin
          found = AdminUser.find(
            (u) => u.idU === username && u.password === password
          );

          // 7.2 Nếu không phải admin → check trong approversData
          if (!found) {
            found = approversData.find(
              (u) => u.idU === username && u.password === password
            );
          }

          if (found) {
            // Nếu login thành công
            currentUser = found;
            localStorage.setItem("currentUser", JSON.stringify(found)); // Lưu vào localStorage
            updateUI(); // Cập nhật lại giao diện
            loginModal.classList.add("hidden"); // Ẩn modal login
            showNotification("Đăng nhập thành công", "success");
            refreshData();
            init(); // Gọi hàm init() → render giao diện + dữ liệu
          } else {
            // Nếu login thất bại
            showNotification("Sai tài khoản hoặc mật khẩu!", "error");
          }
        };

        // Đảm bảo không bị đăng ký nhiều lần
        loginForm.removeEventListener("submit", loginHandler);
        loginForm.addEventListener("submit", loginHandler);

        // ================================
        // 8. Xử lý logout / login link trong dropdown
        // ================================
        logoutLink.addEventListener("click", (e) => {
          e.preventDefault();
          dropdown.classList.add("hidden");

          if (currentUser) {
            // Nếu đang login → tiến hành logout
            currentUser = null;
            localStorage.removeItem("currentUser"); // Xóa user khỏi localStorage
            tokenExpiry = null;
            stopAutoRefresh(); // Dừng tự động làm mới dữ liệu
            clearUI(); // Reset giao diện về mặc định
            updateUI(); // Update menu về "Khách"
            loginModal.classList.remove("hidden"); // Hiện modal login lại
          } else {
            // Nếu chưa login → bật modal login
            loginModal.classList.remove("hidden");
          }
        });

        // ================================
        // 9. Nút đóng/hủy modal login
        // ================================
        if (closeLoginBtn)
          closeLoginBtn.addEventListener("click", () => {
            const modalContent = loginModal.querySelector(
              ".login-modal-animate"
            );
            modalContent.style.animation =
              "modalSlideOut 0.3s ease-in forwards";
            setTimeout(() => {
              loginModal.classList.add("hidden");
              modalContent.style.animation = "";
            }, 300);
          });
        if (cancelLoginBtn)
          cancelLoginBtn.addEventListener("click", () => {
            const modalContent = loginModal.querySelector(
              ".login-modal-animate"
            );
            modalContent.style.animation =
              "modalSlideOut 0.3s ease-in forwards";
            setTimeout(() => {
              loginModal.classList.add("hidden");
              modalContent.style.animation = "";
            }, 300);
          });

        // ================================
        // 10. Toggle password visibility
        // ================================
        const togglePasswordBtn = document.getElementById("togglePassword");
        if (togglePasswordBtn) {
          togglePasswordBtn.addEventListener("click", () => {
            const passwordField = document.getElementById("password");
            const icon = togglePasswordBtn.querySelector("i");

            if (passwordField.type === "password") {
              passwordField.type = "text";
              icon.classList.remove("fa-eye");
              icon.classList.add("fa-eye-slash");
            } else {
              passwordField.type = "password";
              icon.classList.remove("fa-eye-slash");
              icon.classList.add("fa-eye");
            }
          });
        }

        // ================================
        // 11. Enhanced modal animation
        // ================================
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              const modal = mutation.target;
              if (!modal.classList.contains("hidden")) {
                // Modal được mở
                const modalContent = modal.querySelector(
                  ".login-modal-animate"
                );
                if (modalContent) {
                  modalContent.style.animation =
                    "modalSlideIn 0.3s ease-out forwards";
                }
              }
            }
          });
        });
        observer.observe(loginModal, { attributes: true });
      }

      function clearUI() {
        // Reset lại các container dữ liệu
        const ticketContainer = document.getElementById("ticketsTable");
        if (ticketContainer) ticketContainer.innerHTML = "";

        const approvalContainer = document.getElementById("approvalsContainer");
        if (approvalContainer) approvalContainer.innerHTML = "";

        const dashboardContainer =
          document.getElementById("dashboardContainer");
        if (dashboardContainer) dashboardContainer.innerHTML = "";

        // Reset các select box
        const approverSelect = document.getElementById("ticketApprover");
        if (approverSelect) approverSelect.innerHTML = "";

        const deptSelect = document.getElementById("ticketDepartment");
        if (deptSelect)
          deptSelect.innerHTML = '<option value="">Chọn phòng ban</option>';

        // Reset biến dữ liệu trong JS
        tickets = [];
        filteredTickets = [];
        supportSystemsData = [];
        ordersDetailData = [];
        currentSearchTerm = "";
        currentStatusFilter = "";
        currentTicketPage = 1;

        // Reset token cache
        cachedToken = null;
        tokenExpiry = null;

        // Reset dashboard stats
        const dashboardStats = document.getElementById("dashboardStats");
        if (dashboardStats) dashboardStats.innerHTML = "";

        // Reset charts section
        const chartsSection = document.getElementById("chartsSection");
        if (chartsSection) chartsSection.innerHTML = "";

        // Reset recent activities
        const recentActivities = document.getElementById("recentActivities");
        if (recentActivities) recentActivities.innerHTML = "";

        // Reset search input
        const searchInput = document.getElementById("searchTickets");
        if (searchInput) {
          searchInput.value = "";
        }

        // Reset status filter
        const statusFilter = document.getElementById("statusFilter");
        if (statusFilter) {
          statusFilter.value = "";
        }

        // Hide clear search button
        const clearSearchBtn = document.getElementById("clearSearch");
        if (clearSearchBtn) {
          clearSearchBtn.classList.add("hidden");
        }
      }

      async function updateTicketStatus(ticketId, newStatus, currentUserEmail) {
        try {
          const token = await getToken(); // lấy token an toàn

          // 1. Tìm record approval con dựa trên ticketId và email
          const query =
            `${DATAVERSE_URL}/crdfd_support_system_approvals` +
            `?$select=crdfd_support_system_approvalid` +
            `&$filter=_crdfd_masuport_value eq ${ticketId} and crdfd_nguoixacnhan eq '${currentUserEmail}'`;

          const res = await fetch(query, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
          });

          if (!res.ok) {
            throw new Error(
              `Lỗi khi tìm approval: ${res.status} ${res.statusText}`
            );
          }

          const data = await res.json();

          // Nếu không tìm thấy approval record, chỉ thông báo, không ném lỗi
          if (!data.value || data.value.length === 0) {
            console.info(
              `⚠ User ${currentUserEmail} không có approval record cho ticket này.`
            );
            showNotification(
              "User này không có record approval để cập nhật.",
              "info"
            );
            return false;
          }

          const approvalDetailId =
            data.value[0].crdfd_support_system_approvalid;

          // 2. Update record approval
          const patchUrl = `${DATAVERSE_URL}/crdfd_support_system_approvals(${approvalDetailId})`;
          const body = { cr1bb_trang_thai: newStatus }; // dùng đúng field trong Dataverse

          const updateRes = await fetch(patchUrl, {
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
              "Content-Type": "application/json",
              "OData-MaxVersion": "4.0",
              "OData-Version": "4.0",
            },
            body: JSON.stringify(body),
          });

          if (!updateRes.ok) {
            throw new Error(
              `Update thất bại: ${updateRes.status} ${updateRes.statusText}`
            );
          }

          //console.log(`✔ Approval updated to ${newStatus} cho user ${currentUserEmail}`);
          // Refresh data sau khi update
          refreshData();

          return true;
        } catch (err) {
          console.error("❌ Error update ticket:", err);
          showNotification("Cập nhật thất bại: " + err.message, "error");
          return false;
        }
      }

      function getInitials(fullName) {
        if (!fullName) return "AD";
        const parts = fullName.trim().split(" ");
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      // Sinh màu ngẫu nhiên nhưng cố định theo tên user
      function getColorFromName(name) {
        const colors = [
          "bg-red-500",
          "bg-green-500",
          "bg-blue-500",
          "bg-yellow-500",
          "bg-purple-500",
          "bg-pink-500",
          "bg-indigo-500",
          "bg-teal-500",
          "bg-orange-500",
          "bg-cyan-500",
        ];
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % colors.length;
        return colors[index];
      }

      function onDepartmentChange(deptName) {
        //console.log("depname: ", deptName);
        const categorySelect = document.getElementById("ticketCategory");
        categorySelect.innerHTML =
          '<option value="">Chọn loại yêu cầu</option>'; // reset

        if (deptName && categoryByDepartment[deptName]) {
          categoryByDepartment[deptName].forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.text;
            categorySelect.appendChild(option);
          });
        }
      }

      // funciton get name user use email user
      function getUserNameByEmail(email) {
        const user = approversData.find((u) => u.idU === email);
        return user ? user.useName : email; // fallback: nếu ko có thì trả về email
      }

      function loadGuides() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const isAdmin = currentUser?.idU === "admin";
        const phongban = currentUser?.phongban || "Khác";

        const guidesByDepartment = {
          "Kho vận": `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-warehouse text-blue-600 mr-3"></i>
                Kho vận - Hướng dẫn tạo Ticket
              </h3>
              
              <div class="space-y-6">
                <div class="border-l-4 border-yellow-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">1. Hủy phiếu xuất kho</h4>
                  <p class="text-gray-600 mb-2">Khi cần hủy phiếu xuất kho đã tạo:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Hủy phiếu xuất kho"</li>
                    <li>
                        Chọn người duyệt 
                        <span class="text-red-600 font-semibold ml-1">(yêu cầu: ít nhất 1 user)</span>
                    </li>
                    <li>Nhập mã đơn hàng SOD
                        <span class="text-red-600 font-semibold ml-1">(vd: "SO_10164392_12-09-2025_KH - CH Cẩm Bào ( Ninh Hoà)_Đơn 10/9 nước - có hóa đơn/2672206")</span>
                    </li>
                    <li>Nhập phiếu xuất kho cần hủy
                        <span class="text-red-600 font-semibold ml-1">(vd: "PXK_10164392")</span>
                    </li>
                    <li>Nhập số lượng cần hủy theo kho
                        <span class="text-red-600 font-semibold ml-1">(vd: "100")</span>
                    </li>
                    <li>Mô tả lý do hủy phiếu</li>
                  </ul>
                </div>
                
                <div class="border-l-4 border-red-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">2. Hủy phiếu nhập kho</h4>
                  <p class="text-gray-600 mb-2">Khi cần hủy phiếu nhập kho đã tạo:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Hủy phiếu nhập kho"</li>
                    <li>
                        Chọn người duyệt 
                        <span class="text-red-600 font-semibold ml-1">(yêu cầu: ít nhất 1 user)</span>
                    </li>
                    <li>Nhập mã đơn hàng BOD
                        <span class="text-red-600 font-semibold ml-1">(vd: "BO_10037860_13-09-2025_Bắc Hà (Đinh Thép Việt)_Đinh TV_[Bình Định]/10126923")</span>
                    </li>
                    <li>Nhập số phiếu nhập kho cần hủy
                        <span class="text-red-600 font-semibold ml-1">(vd: "PNK_10037860")</span>
                    </li>
                    <li>Nhập số lượng cần hủy theo kho : là số lượng đã nhập kho của phiếu cần hủy
                        <span class="text-red-600 font-semibold ml-1">(vd: "100")</span>
                    </li>
                    <li>Mô tả lý do hủy phiếu</li>
                  </ul>
                </div>
                
                <div class="border-l-4 border-green-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">3. Điều chỉnh định lượng</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh định lượng sản phẩm:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh định lượng"</li>
                    <li>Nhập mã sản phẩm</li>
                    <li>Chọn đơn vị tính</li>
                    <li>Nhập giá trị định lượng mới</li>
                    <li>Mô tả lý do điều chỉnh</li>
                  </ul>
                </div>
                
                <div class="border-l-4 border-purple-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">4. Điều chỉnh phiếu xuất/nhập kho</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh thông tin phiếu:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh phiếu xuất kho" hoặc "Điều chỉnh phiếu nhập kho"</li>
                    <li>Nhập mã đơn hàng</li>
                    <li>Nhập mã phiếu xuất/nhập</li>
                    <li>Nhập số lượng đơn hàng mới</li>
                    <li>Nhập số lượng kho mới</li>
                    <li>Mô tả chi tiết điều chỉnh</li>
                  </ul>
                </div>
              </div>
            </div>
          `,

          "Phòng Cung ứng": `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-truck text-green-600 mr-3"></i>
                Phòng Cung ứng - Hướng dẫn tạo Ticket
              </h3>
              
              <div class="space-y-6">
                <div class="border-l-4 border-blue-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">1. Điều chỉnh giá BOD</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh giá trong đơn hàng mua (BOD):</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh giá BOD"</li>
                    <li>Nhập mã đơn hàng BOD</li>
                    <li>Nhập giá trị điều chỉnh mới</li>
                    <li>Mô tả lý do thay đổi giá</li>
                    <li>Đính kèm tài liệu liên quan (nếu có)</li>
                  </ul>
                  <p class="text-red-600 font-semibold mt-3">
                      ⚠️ Lưu ý: Giá trị đơn giá cập nhật là <u>giá gốc, chưa trừ chiết khấu</u>. 
                      Hệ thống sẽ tự động áp dụng chiết khấu từ các cột Chiết khấu liên quan.
                  </p>
                </div>
                
                <div class="border-l-4 border-orange-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">2. Điều chỉnh VAT BOD</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh VAT cho đơn hàng mua:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh VAT BOD"</li>
                    <li>Nhập mã đơn hàng BOD</li>
                    <li>Chọn tùy chọn VAT (0%, 5%, 8%, 10%)</li>
                    <li>Mô tả lý do thay đổi VAT</li>
                  </ul>
                </div>
                
                <div class="border-l-4 border-teal-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">3. Điều chỉnh VAT BO</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh VAT cho đơn hàng BO:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh VAT BO"</li>
                    <li>Nhập mã đơn hàng BO</li>
                    <li>Chọn tùy chọn VAT mới</li>
                    <li>Giải thích lý do điều chỉnh</li>
                    <p class="text-red-600 font-semibold mt-3">
                      ⚠️ Lưu ý: Với các giá trị VAT 0%, 5%, 8%, 10% khi chọn.
                      Hệ thống sẽ tự động áp dụng VAT này cho toàn đơn Sale order detail liên quan.
                    </p>
                  </ul>
                </div>
              </div>
            </div>
          `,

          "Phòng Phát triển Kinh doanh": `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-line text-purple-600 mr-3"></i>
                Phòng Phát triển Kinh doanh - Hướng dẫn tạo Ticket
              </h3>
              
              <div class="space-y-6">
                <div class="border-l-4 border-indigo-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">1. Điều chỉnh giá SOD</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh giá trong đơn hàng bán (SOD):</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh giá SOD"</li>
                    <li>
                        Chọn người duyệt 
                        <span class="text-red-600 font-semibold ml-1">(yêu cầu: ít nhất 1 user)</span>
                    </li>
                    <li>Nhập mã đơn hàng SOD</li>
                    <li>Nhập giá trị điều chỉnh mới</li>
                    <li>Mô tả lý do thay đổi giá bán</li>
                    <li>Cung cấp thông tin khách hàng liên quan</li>
                  </ul>
                  <p class="text-red-600 font-semibold mt-3">
                      ⚠️ Lưu ý: Giá trị đơn giá cập nhật là <u>giá gốc, chưa trừ chiết khấu</u>. 
                      Hệ thống sẽ tự động áp dụng chiết khấu từ các cột Chiết khấu liên quan.
                  </p>
                </div>
                
                <div class="border-l-4 border-pink-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">2. Điều chỉnh VAT SOD</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh VAT cho đơn hàng bán:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh VAT SOD"</li>
                    <li>
                        Chọn người duyệt 
                        <span class="text-red-600 font-semibold ml-1">(yêu cầu: ít nhất 1 user)</span>
                    </li>
                    <li>Nhập mã đơn hàng SOD</li>
                    <li>Chọn tùy chọn VAT (0%, 5%, 8%, 10%)</li>
                    <li>Mô tả lý do thay đổi VAT</li>
                  </ul>
                </div>
                
                <div class="border-l-4 border-cyan-400 pl-4">
                  <h4 class="font-semibold text-gray-800 mb-2">3. Điều chỉnh VAT SO</h4>
                  <p class="text-gray-600 mb-2">Khi cần điều chỉnh VAT cho đơn hàng SO:</p>
                  <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Chọn loại: "Điều chỉnh VAT SO"</li>
                    <li>
                        Chọn người duyệt 
                        <span class="text-red-600 font-semibold ml-1">(yêu cầu: ít nhất 1 user)</span>
                    </li>
                    <li>Nhập mã đơn hàng SO</li>
                    <li>Chọn tùy chọn VAT mới</li>
                    <li>Giải thích lý do điều chỉnh</li>
                    <p class="text-red-600 font-semibold mt-3">
                      ⚠️ Lưu ý: Với các giá trị VAT 0%, 5%, 8%, 10% khi chọn.
                      Hệ thống sẽ tự động áp dụng VAT này cho toàn đơn Sale order detail liên quan.
                    </p>
                  </ul>
                </div>
              </div>
            </div>
          `,

          "Hệ thống": `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-cogs text-red-600 mr-3"></i>
                Hệ thống - Tài liệu toàn bộ quy trình
              </h3>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <h4 class="font-semibold text-gray-800 border-b pb-2">Kho vận</h4>
                  <div class="space-y-2 text-sm">
                    <div class="flex items-center p-2 bg-yellow-50 rounded">
                      <i class="fas fa-box text-yellow-600 mr-2"></i>
                      <span>Hủy phiếu xuất kho</span>
                    </div>
                    <div class="flex items-center p-2 bg-red-50 rounded">
                      <i class="fas fa-inbox text-red-600 mr-2"></i>
                      <span>Hủy phiếu nhập kho</span>
                    </div>
                    <div class="flex items-center p-2 bg-green-50 rounded">
                      <i class="fas fa-balance-scale text-green-600 mr-2"></i>
                      <span>Điều chỉnh định lượng</span>
                    </div>
                    <div class="flex items-center p-2 bg-purple-50 rounded">
                      <i class="fas fa-edit text-purple-600 mr-2"></i>
                      <span>Điều chỉnh phiếu xuất/nhập</span>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <h4 class="font-semibold text-gray-800 border-b pb-2">Cung ứng & Kinh doanh</h4>
                  <div class="space-y-2 text-sm">
                    <div class="flex items-center p-2 bg-blue-50 rounded">
                      <i class="fas fa-dollar-sign text-blue-600 mr-2"></i>
                      <span>Điều chỉnh giá BOD/SOD</span>
                    </div>
                    <div class="flex items-center p-2 bg-orange-50 rounded">
                      <i class="fas fa-percentage text-orange-600 mr-2"></i>
                      <span>Điều chỉnh VAT BOD/SOD/BO/SO</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-800 mb-2">Quy trình chung:</h4>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                  <li>Chọn phòng ban phù hợp</li>
                  <li>Chọn loại yêu cầu tương ứng</li>
                  <li>Điền đầy đủ thông tin bắt buộc</li>
                  <li>Mô tả chi tiết lý do yêu cầu</li>
                  <li>Gửi ticket và chờ phê duyệt</li>
                </ol>
              </div>
            </div>
          `,
        };

        // Nếu là admin, hiển thị tất cả hướng dẫn
        if (isAdmin) {
          let allGuides = "";
          Object.keys(guidesByDepartment).forEach((dept) => {
            if (dept !== "Hệ thống") {
              allGuides += guidesByDepartment[dept];
            }
          });
          allGuides += guidesByDepartment["Hệ thống"];
          document.getElementById("guideContent").innerHTML = allGuides;
        } else {
          // User thường chỉ thấy hướng dẫn của phòng ban mình
          document.getElementById("guideContent").innerHTML =
            guidesByDepartment[phongban] ||
            `<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <div class="text-center py-8">
                <i class="fas fa-info-circle text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Chưa có hướng dẫn</h3>
                <p class="text-gray-600">Hiện chưa có tài liệu hướng dẫn cho phòng ban <strong>${phongban}</strong>.</p>
                <p class="text-sm text-gray-500 mt-2">Vui lòng liên hệ quản trị viên để được hỗ trợ.</p>
              </div>
            </div>`;
        }
      }

      // Function escape ký tự đặc biệt cho OData query
      function escapeODataString(str) {
        if (!str) return '';
        return str
          .replace(/'/g, "''") // Escape single quotes
          .replace(/%/g, '%25') // Escape percent
          .replace(/\+/g, '%2B') // Escape plus
          .replace(/&/g, '%26') // Escape ampersand
          .replace(/#/g, '%23') // Escape hash
          .replace(/\[/g, '%5B') // Escape left bracket
          .replace(/\]/g, '%5D') // Escape right bracket
          .replace(/\(/g, '%28') // Escape left parenthesis
          .replace(/\)/g, '%29') // Escape right parenthesis
          .replace(/ /g, '%20')  // Escape spaces
          .replace(/\//g, '%2F') // Escape forward slash
      }

      // Function kiểm tra tồn kho cho hủy phiếu xuất kho
      async function checkExportStock(maPhieu, soLuongHuy, loaiPhieu) {
        try {
          const token = await getToken();
          const stockWarning = document.getElementById('exportStockWarning');
          const stockWarningText = document.getElementById('exportStockWarningText');
          
          if (!stockWarning || !stockWarningText) return;
          
          // Ẩn warning trước khi kiểm tra
          stockWarning.classList.add('hidden');
          // Reset tất cả class màu trước khi bắt đầu validation mới
          stockWarning.classList.remove('text-green-600', 'text-red-600');
          // Clear nội dung text cũ
          stockWarningText.textContent = '';
          
          // Hiển thị loading cho tất cả các field
          showExportOrderValidationLoading();
          showExportSlipValidationLoading();
          showExportQuantityValidationLoading();
          
          // Lấy mã đơn hàng từ input
          const maDonHangInput = document.getElementById('IDMaDonHangXuat');
          const maDonHang = maDonHangInput ? maDonHangInput.value.trim() : '';
          
          if (!maDonHang) {
            // Hiển thị lỗi cho tất cả các field
            showExportOrderValidationError();
            showExportSlipValidationError();
            showExportQuantityValidationError();
            stockWarningText.textContent = 'Vui lòng nhập đầy đủ thông tin.';
            stockWarning.classList.remove('hidden');
            return;
          }
          
          // Trim khoảng trống và escape ký tự đặc biệt
          const escapedMaPhieu = escapeODataString(maPhieu.trim());
          const escapedMaDonHang = escapeODataString(maDonHang.trim());
          
          // Bước 1: Query transaction sell để lấy thông tin và expand saleorder detail
          const transactionQuery = `/crdfd_transactionsaleses?$filter=crdfd_maphieuxuat eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and crdfd_soluonggiaotheokho eq ${soLuongHuy} and statecode eq 0&$select=crdfd_soluonggiaotheokho,crdfd_transactionsalesid,createdon&$orderby=createdon desc&$top=1`;
          console.log("transactionQuery: ", transactionQuery);
          const transactionResponse = await fetch(`${DATAVERSE_URL}${transactionQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          if (!transactionResponse.ok) {
            console.error('❌ Lỗi API transaction sell:', transactionResponse.status, transactionResponse.statusText);
            // Hiển thị lỗi cho tất cả các field
            showExportOrderValidationError();
            showExportSlipValidationError();
            showExportQuantityValidationError();
            stockWarningText.textContent = `Lỗi API: ${transactionResponse.statusText}`;
            stockWarning.classList.remove('hidden');
            return;
          }
          
          const transactionData = await transactionResponse.json();
          
          if (!transactionData.value || transactionData.value.length === 0) {
            // Hiển thị lỗi cho tất cả các field
            showExportOrderValidationError();
            showExportSlipValidationError();
            showExportQuantityValidationError();
            stockWarningText.textContent = `Không tìm thấy phiếu xuất kho tương ứng với mã đơn hàng: ${maDonHang}, mã phiếu: ${maPhieu} và số lượng: ${soLuongHuy}`;
            stockWarning.classList.remove('hidden');
            
            // Đảm bảo exportStockWarning được set đúng trạng thái lỗi
            const exportStockWarning = document.getElementById("exportStockWarning");
            if (exportStockWarning) {
              exportStockWarning.classList.remove('hidden');
              exportStockWarning.classList.remove('text-green-600');
              exportStockWarning.classList.add('text-red-600');
            }
            
            window.lastExportTransactionData = null;
            checkSubmitButtonState();
            return;
          }
          
          const transactionInfo = transactionData.value[0];
          
          // Hiển thị thành công cho tất cả các field
          showExportOrderValidationSuccess();
          showExportSlipValidationSuccess();
          showExportQuantityValidationSuccess();
          
          // Lưu thông tin transaction để sử dụng khi tạo ticket
          window.lastExportTransactionData = transactionInfo;
          
          // Ẩn exportStockWarning khi tìm thấy dữ liệu - chỉ hiển thị tích xanh cho input
          const exportStockWarning = document.getElementById("exportStockWarning");
          if (exportStockWarning) {
            exportStockWarning.classList.add('hidden');
            // Vẫn set class green để checkSubmitButtonState nhận diện được trạng thái success
            exportStockWarning.classList.remove('text-red-600');
            exportStockWarning.classList.add('text-green-600');
          }
          
          // Gọi function kiểm tra trạng thái nút submit
          checkSubmitButtonState();
          
        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra phiếu xuất kho:', error);
          // Hiển thị lỗi cho tất cả các field
          showExportOrderValidationError();
          showExportSlipValidationError();
          showExportQuantityValidationError();
          stockWarningText.textContent = `Lỗi khi kiểm tra: ${error.message}`;
          stockWarning.classList.remove('hidden');
          
          // Đảm bảo exportStockWarning được set đúng trạng thái lỗi
          const exportStockWarning = document.getElementById("exportStockWarning");
          if (exportStockWarning) {
            exportStockWarning.classList.remove('hidden');
            exportStockWarning.classList.remove('text-green-600');
            exportStockWarning.classList.add('text-red-600');
          }
          
          checkSubmitButtonState();
        }
      }
      
      async function checkInventoryStock(maPhieu, soLuongHuy, loaiPhieu) {
        try {
          const token = await getToken();
          const stockWarning = document.getElementById('stockWarning');
          const stockWarningText = document.getElementById('stockWarningText');
          
          if (!stockWarning || !stockWarningText) return;
          
          // Ẩn warning trước khi kiểm tra
          stockWarning.classList.add('hidden');
          
          // Hiển thị loading cho tất cả các field
          showImportOrderValidationLoading();
          showImportSlipValidationLoading();
          showImportQuantityValidationLoading();
          
          // Lấy mã đơn hàng từ input
          const maDonHangInput = document.getElementById('IDMaDonHang');
          const maDonHang = maDonHangInput ? maDonHangInput.value.trim() : '';
          
          if (!maDonHang) {
            // Hiển thị lỗi cho tất cả các field
            showImportOrderValidationError();
            showImportSlipValidationError();
            showImportQuantityValidationError();
            stockWarningText.textContent = 'Vui lòng nhập đầy đủ thông tin.';
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          // Trim khoảng trống và escape ký tự đặc biệt
          const escapedMaPhieu = escapeODataString(maPhieu.trim());
          const escapedMaDonHang = escapeODataString(maDonHang.trim());
          
          // Bước 1: Query transaction buy để lấy thông tin và expand buyorder detail
          const transactionQuery = `/crdfd_transactionbuies?$filter=crdfd_maphieunhap eq '${escapedMaPhieu}' and crdfd_maonhangchitiettext eq '${escapedMaDonHang}' and crdfd_soluonganhantheokho eq ${soLuongHuy}&$select=crdfd_soluonganhantheokho,crdfd_transactionbuyid,createdon&$expand=crdfd_IDchitietonhang($select=crdfd_vitrikho,_crdfd_tensanpham_value)&$orderby=createdon desc&$top=1`;
          
          //console.log('🔍 Query transaction buy:', transactionQuery);
          
          const transactionResponse = await fetch(`${DATAVERSE_URL}${transactionQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'OData-MaxVersion': '4.0',
              'OData-Version': '4.0'
            }
          });
          
          if (!transactionResponse.ok) {
            const errorText = await transactionResponse.text();
            console.error('❌ Lỗi khi gọi API transaction buy:', {
              status: transactionResponse.status,
              statusText: transactionResponse.statusText,
              errorText: errorText,
              query: transactionQuery
            });
            // Hiển thị lỗi cho tất cả các field
            showImportOrderValidationError();
            showImportSlipValidationError();
            showImportQuantityValidationError();
            stockWarningText.textContent = `Lỗi API: ${transactionResponse.statusText}`;
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          const transactionData = await transactionResponse.json();
          //console.log('🔍 API Response từ crdfd_transactionbuies:', transactionData);
          
          if (!transactionData.value || transactionData.value.length === 0) {
            // Hiển thị lỗi cho tất cả các field
            showImportOrderValidationError();
            showImportSlipValidationError();
            showImportQuantityValidationError();
            stockWarningText.textContent = `Không tìm thấy phiếu nhập kho tương ứng với mã đơn hàng: ${maDonHang}, mã phiếu: ${maPhieu} và số lượng: ${soLuongHuy}`;
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          const transactionInfo = transactionData.value[0];
          const chiTietDonHang = transactionInfo.crdfd_IDchitietonhang;
          
          // Lưu transaction data vào global variable để sử dụng khi tạo ticket
          window.lastTransactionData = transactionInfo;
          
          if (!chiTietDonHang) {
            stockWarningText.textContent = 'Không tìm thấy thông tin chi tiết đơn hàng.';
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          // crdfd_IDchitietonhang là object, không phải array
          const chiTiet = chiTietDonHang;
          
          //console.log('📦 Thông tin chi tiết đơn hàng:', chiTiet);
          
          const viTriKho = chiTiet.crdfd_vitrikho ? chiTiet.crdfd_vitrikho.trim() : '';
          const sanPham = chiTiet._crdfd_tensanpham_value ? chiTiet._crdfd_tensanpham_value.trim() : '';
          
          //console.log('🏪 Vị trí kho:', viTriKho);
          //console.log('📦 Sản phẩm ID:', sanPham);
          
          if (!viTriKho || !sanPham) {
            stockWarningText.textContent = 'Thiếu thông tin vị trí kho hoặc sản phẩm.';
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          // Bước 2: Query bảng kho để lấy tồn kho hiện tại (đã trim ở trên)
          const escapedViTriKho = escapeODataString(viTriKho);
          const escapedSanPham = escapeODataString(sanPham);
          
          const stockQuery = `/crdfd_kho_binh_dinhs?$filter=crdfd_vitrikhofx eq '${escapedViTriKho}' and _crdfd_tensanphamlookup_value eq '${escapedSanPham}'&$select=crdfd_tonkhothucte,createdon&$orderby=createdon desc&$top=1`;
          
          //console.log('🔍 Query tồn kho:', stockQuery);
          
          const stockResponse = await fetch(`${DATAVERSE_URL}${stockQuery}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'OData-MaxVersion': '4.0',
              'OData-Version': '4.0'
            }
          });
          
          if (!stockResponse.ok) {
            const errorText = await stockResponse.text();
            console.error('❌ Lỗi khi gọi API tồn kho:', {
              status: stockResponse.status,
              statusText: stockResponse.statusText,
              errorText: errorText,
              query: stockQuery
            });
            stockWarningText.textContent = `Lỗi API tồn kho (${stockResponse.status}): ${stockResponse.statusText}. Kiểm tra console để xem chi tiết.`;
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
            return;
          }
          
          const stockData = await stockResponse.json();
          //console.log('🔍 API Response từ crdfd_kho_binh_dinhs:', stockData);
          
          if (stockData.value && stockData.value.length > 0) {
            //console.log('✅ Thông tin tồn kho tìm thấy:', stockData.value[0]);
            const stockInfo = stockData.value[0]; // Lấy record mới nhất
            const tonKhoHienTai = parseFloat(stockInfo.crdfd_tonkhothucte) || 0;
            const tenSanPham = 'Sản phẩm'; // Sẽ lấy từ lookup nếu cần
            
            // Kiểm tra số lượng hủy có hợp lệ không
            if (soLuongHuy <= 0) {
              stockWarningText.textContent = 'Số lượng hủy phải lớn hơn 0.';
              stockWarning.classList.remove('hidden');
              stockWarning.classList.remove('text-green-600');
              stockWarning.classList.add('text-red-600');
              return;
            }
            
            // Tính toán tồn kho sau khi hủy
            let tonKhoSauKhiXuLy = 0;
            
            if (loaiPhieu === 'huy_phieu_nhap') {
              // Hủy phiếu nhập: tồn kho - số lượng hủy
              tonKhoSauKhiXuLy = tonKhoHienTai - soLuongHuy;
            }
            
            // Lấy nút tạo ticket để disable/enable
            const submitTicketBtn = document.getElementById('submitTicket');
            
            // Kiểm tra nếu tồn kho bị âm
            if (tonKhoSauKhiXuLy < 0) {
              // Hiển thị lỗi cho tất cả các field
              showImportOrderValidationError();
              showImportSlipValidationError();
              showImportQuantityValidationError();
              stockWarningText.textContent = `Cảnh báo: Tồn kho của ${tenSanPham} sẽ bị âm (${tonKhoSauKhiXuLy.toFixed(2)}) nếu hủy ${soLuongHuy} đơn vị. Tồn kho hiện tại: ${tonKhoHienTai.toFixed(2)}`;
              stockWarning.classList.remove('hidden');
              stockWarning.classList.remove('text-green-600');
              stockWarning.classList.add('text-red-600');
              
              // Gọi function kiểm tra trạng thái nút submit
              checkSubmitButtonState();
            } else {
              // Hiển thị thành công cho tất cả các field
              showImportOrderValidationSuccess();
              showImportSlipValidationSuccess();
              showImportQuantityValidationSuccess();
              // Hiển thị thông báo tồn kho khi tìm thấy dữ liệu
              stockWarningText.textContent = `Tồn kho hiện tại: ${tonKhoHienTai.toFixed(2)}. Tồn kho sau khi hủy: ${tonKhoSauKhiXuLy.toFixed(2)}`;
              stockWarning.classList.remove('hidden');
              stockWarning.classList.remove('text-red-600');
              stockWarning.classList.add('text-green-600');
              
              // Gọi function kiểm tra trạng thái nút submit
              checkSubmitButtonState();
            }
          } else {
            // Hiển thị lỗi cho tất cả các field
            showImportOrderValidationError();
            showImportSlipValidationError();
            showImportQuantityValidationError();
            stockWarningText.textContent = `Không tìm thấy thông tin tương thích cho mã đơn hàng: ${maDonHang} và mã phiếu: ${maPhieu}`;
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
          }

        } catch (error) {
          console.error('❌ Lỗi khi kiểm tra tồn kho:', error);
          console.error('📋 Chi tiết lỗi:', {
            message: error.message,
            stack: error.stack,
            maPhieu: maPhieu,
            maDonHang: document.getElementById('IDMaDonHang')?.value,
            soLuongHuy: soLuongHuy
          });
          
          // Hiển thị lỗi cho tất cả các field
          showImportOrderValidationError();
          showImportSlipValidationError();
          showImportQuantityValidationError();
          
          const stockWarning = document.getElementById('stockWarning');
          const stockWarningText = document.getElementById('stockWarningText');
          
          if (stockWarning && stockWarningText) {
            stockWarningText.textContent = `Lỗi khi kiểm tra: ${error.message}`;
            stockWarning.classList.remove('hidden');
            stockWarning.classList.remove('text-green-600');
            stockWarning.classList.add('text-red-600');
          }
        }
      }

      // Load khi vào page
      window.addEventListener("hashchange", () => {
        if (location.hash === "#guides") loadGuides();
      });
    </script>
  </body>
</html>